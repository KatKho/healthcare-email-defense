<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Email Defense Agent</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .input-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .input-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
        }

        .analyze-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .example-btn {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 30px;
        }

        .results-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .results-table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .results-table tr:hover {
            background: #f8fafc;
        }

        .classification {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .classification.safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .classification.suspicious {
            background: #fef5e7;
            color: #744210;
        }

        .classification.phishing {
            background: #fed7d7;
            color: #742a2a;
        }

        .confidence {
            font-weight: 600;
            color: #2d3748;
        }

        .ai-comment {
            font-style: italic;
            color: #718096;
            max-width: 300px;
        }

        .feedback-section {
            margin-top: 10px;
        }

        .review-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            width: 100%;
        }

        .review-btn:hover {
            background: #5a67d8;
        }


        .feedback-buttons {
            display: flex;
            gap: 10px;
        }

        .feedback-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .feedback-btn.correct {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .feedback-btn.correct:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .feedback-btn.incorrect {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }

        .feedback-btn.incorrect:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .feedback-btn:active {
            transform: translateY(0);
        }

        .feedback-btn.selected {
            color: white;
        }

        .feedback-btn.selected.correct {
            background: #38a169;
            border-color: #38a169;
        }

        .feedback-btn.selected.incorrect {
            background: #e53e3e;
            border-color: #e53e3e;
        }

        .no-results {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 40px;
        }

        .agent-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .agent-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .agent-status h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .refresh-stats-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .refresh-stats-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .agent-controls {
            display: flex;
            gap: 8px;
        }

        .clear-history-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .clear-history-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            transform: scale(1.05);
        }

        .reset-system-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .reset-system-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        .reset-system-btn:active {
            transform: translateY(0);
        }

        .last-updated {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
            font-style: italic;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .status-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .agent-actions {
            margin-top: 8px;
        }

        .agent-action {
            display: inline-block;
            background: #fef5e7;
            color: #744210;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 3px;
        }

        .agent-action.quarantine {
            background: #fed7d7;
            color: #742a2a;
        }

        .agent-action.escalate {
            background: #fef5e7;
            color: #744210;
        }

        .agent-action.pattern_based {
            background: #c6f6d5;
            color: #22543d;
        }

        .learning-indicator {
            color: #38a169;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .security-details {
            margin-top: 5px;
            padding: 5px;
            background: #f7fafc;
            border-radius: 4px;
            border-left: 3px solid #e53e3e;
        }

        .security-details small {
            color: #4a5568;
            font-size: 0.8rem;
        }

        .role-warning {
            margin-top: 5px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .role-warning.high {
            background: #fed7d7;
            border-left: 3px solid #e53e3e;
            color: #742a2a;
        }

        .role-warning.moderate {
            background: #fef5e7;
            border-left: 3px solid #d69e2e;
            color: #744210;
        }

        .role-info {
            margin-top: 5px;
            padding: 4px;
            background: #f0fff4;
            border-radius: 4px;
            border-left: 3px solid #38a169;
        }

        .role-info small {
            color: #2f855a;
            font-size: 0.8rem;
        }

        .reasoning-report-btn {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .reasoning-report-btn:hover {
            background: linear-gradient(135deg, #1e3a8a 0%, #1a365d 100%);
            transform: translateY(-1px);
        }

        .reasoning-report-btn:hover {
            background: linear-gradient(135deg, #1e3a8a 0%, #1a365d 100%);
            transform: translateY(-1px);
        }

        .reasoning-modal-content {
            max-width: 900px;
            width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
        }

        .reasoning-report-modal {
            font-size: 0.95rem;
        }

        .email-context {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2c5aa0;
        }

        .email-context h3 {
            margin: 0 0 12px 0;
            color: #1e3a8a;
            font-size: 1.1rem;
        }

        .context-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .context-grid div {
            color: #374151;
        }

        .recipient-details-modal {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #bfdbfe;
        }

        .recipient-details-modal h4 {
            margin: 0 0 10px 0;
            color: #1e40af;
            font-size: 1rem;
        }

        .no-threats {
            color: #059669;
            font-style: italic;
        }

        .reasoning-section {
            margin-bottom: 15px;
        }

        .reasoning-section:last-child {
            margin-bottom: 0;
        }

        .reasoning-section h4 {
            color: #2d3748;
            font-size: 1rem;
            margin-bottom: 8px;
            border-bottom: 2px solid #2c5aa0;
            padding-bottom: 4px;
        }

        .reasoning-section p {
            color: #4a5568;
            line-height: 1.5;
            margin: 0;
        }

        .reasoning-section ul {
            color: #4a5568;
            margin: 0;
            padding-left: 20px;
        }

        .reasoning-section li {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .brief-comment {
            font-weight: 500;
            color: #2d3748;
        }

        .reasoning-section.recommendation {
            background: linear-gradient(135deg, #fef5e7 0%, #fed7d7 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d69e2e;
            margin-top: 20px;
        }

        .reasoning-section.recommendation h4 {
            color: #744210;
            border-bottom-color: #d69e2e;
        }

        .reasoning-section.recommendation p {
            color: #744210;
            font-size: 1rem;
        }

        /* Confidence Breakdown Styling */
        .confidence-breakdown {
            background: linear-gradient(135deg, #e6f7ff 0%, #f0f9ff 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2c5aa0;
        }

        .confidence-breakdown h4 {
            color: #1e40af;
            border-bottom-color: #2c5aa0;
        }

        .confidence-breakdown h5 {
            color: #1e40af;
            font-size: 0.9rem;
            margin: 12px 0 8px 0;
            font-weight: 600;
        }

        .confidence-details {
            font-size: 0.9rem;
        }

        .confidence-final {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 1rem;
        }

        .confidence-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c5aa0;
        }

        .uncertainty-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .uncertainty-low {
            background: #d4edda;
            color: #155724;
        }

        .uncertainty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .uncertainty-high {
            background: #f8d7da;
            color: #721c24;
        }

        .factor-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
        }

        .factor-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1.2fr 1fr;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .factor-name {
            font-weight: 600;
            color: #2d3748;
        }

        .factor-score {
            color: #2c5aa0;
            font-weight: 600;
            text-align: center;
        }

        .factor-weight {
            color: #718096;
            font-size: 0.8rem;
            text-align: center;
        }

        .factor-contribution {
            color: #48bb78;
            font-weight: 600;
            text-align: right;
        }

        .base-confidence {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.95rem;
            color: #2d3748;
        }

        .confidence-adjustments {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .confidence-adjustments ul {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }

        .confidence-adjustments li {
            margin-bottom: 4px;
            color: #4a5568;
        }

        .confidence-adjustments .positive {
            color: #48bb78;
            font-weight: 600;
        }

        .confidence-adjustments .negative {
            color: #f56565;
            font-weight: 600;
        }

        .confidence-calibration {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .confidence-calibration p {
            margin: 4px 0;
            color: #4a5568;
        }

        .confidence-calibration .positive {
            color: #48bb78;
            font-weight: 600;
        }

        .confidence-calibration .negative {
            color: #f56565;
            font-weight: 600;
        }

        .uncertainty-details {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .uncertainty-details p {
            margin: 4px 0;
            color: #4a5568;
        }

        .recipient-info {
            margin-top: 8px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #bfdbfe;
        }

        .recipient-details {
            font-size: 0.9rem;
            color: #1e40af;
            font-weight: 500;
        }

        .unknown-user-warning {
            display: block;
            margin-top: 5px;
            color: #d69e2e;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .history-table {
            font-size: 14px;
        }

        .history-table th,
        .history-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .history-table tr {
            border-bottom: 1px solid #e2e8f0;
        }

        .history-table tr:last-child {
            border-bottom: none;
        }

        .history-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .history-status.auto_safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .history-status.auto_quarantine {
            background: #fed7d7;
            color: #742a2a;
        }

        .history-status.auto_learned {
            background: #e6fffa;
            color: #234e52;
        }

        .history-status.reviewed {
            background: #bee3f8;
            color: #2a69ac;
        }

        .moved-time {
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 25px;
        }

        .email-details {
            margin-bottom: 25px;
        }

        .email-field {
            margin-bottom: 15px;
        }

        .field-label {
            font-weight: 600;
            color: #4a5568;
            display: block;
            margin-bottom: 5px;
        }

        .email-value {
            background: #f7fafc;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            word-break: break-all;
        }

        .email-body {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .analysis-details {
            margin-bottom: 25px;
        }

        .analysis-details h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .analysis-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .analysis-item .field-label {
            font-weight: 600;
            color: #4a5568;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .analysis-item span {
            color: #2d3748;
            font-size: 0.95rem;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .modal-close-btn {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(113, 128, 150, 0.3);
            font-size: 14px;
        }

        .modal-close-btn:hover {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(113, 128, 150, 0.4);
        }

        .modal-close-btn:active {
            transform: translateY(0);
        }

        /* Confidence Breakdown Modal Styles */
        .confidence-icon {
            cursor: pointer;
            color: #667eea;
            font-size: 14px;
            margin-left: 6px;
            transition: all 0.2s;
            display: inline-block;
            vertical-align: middle;
        }

        .confidence-icon:hover {
            color: #764ba2;
            transform: scale(1.2);
        }

        .confidence-overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .confidence-main-score {
            text-align: center;
            margin-bottom: 15px;
        }

        .confidence-label {
            font-size: 14px;
            opacity: 0.9;
            display: block;
            margin-bottom: 5px;
        }

        .confidence-value-large {
            font-size: 48px;
            font-weight: bold;
            display: block;
        }

        .confidence-meta {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }

        .meta-item {
            text-align: center;
            flex: 1;
        }

        .meta-label {
            font-size: 12px;
            opacity: 0.8;
            display: block;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 18px;
            font-weight: 600;
        }

        .channel-scores {
            margin-bottom: 20px;
        }

        .channel-scores h3 {
            margin-bottom: 15px;
            color: #2c5aa0;
        }

        .channel-item {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .channel-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
        }

        .channel-score {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .channel-details {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
        }

        .channel-detail {
            font-size: 13px;
            color: #4a5568;
        }

        .channel-detail strong {
            color: #2d3748;
        }

        .channel-evidence {
            font-size: 12px;
            color: #718096;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .channel-evidence-item {
            margin: 4px 0;
        }

        .confidence-metrics {
            margin-bottom: 20px;
        }

        .confidence-metrics h3 {
            margin-bottom: 15px;
            color: #2c5aa0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 13px;
            color: #718096;
            display: block;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .confidence-adjustments {
            margin-top: 20px;
        }

        .confidence-adjustments h3 {
            margin-bottom: 15px;
            color: #2c5aa0;
        }

        .adjustment-item {
            background: #fffbf0;
            border-left: 4px solid #f59e0b;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .adjustment-reason {
            font-weight: 600;
            color: #92400e;
        }

        .adjustment-value {
            color: #d97706;
            font-style: italic;
        }

        .confidence-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .confidence-section:last-child {
            border-bottom: none;
        }

        .confidence-section h3 {
            margin-bottom: 15px;
            color: #2c5aa0;
            font-size: 16px;
        }

        .calculation-box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .calc-formula {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #2d3748;
            border-left: 4px solid #667eea;
        }

        .calc-step {
            padding: 8px 12px;
            margin: 8px 0;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .calc-step-label {
            color: #4a5568;
            font-weight: 600;
            margin-right: 8px;
        }

        .calc-step-value {
            color: #667eea;
            font-weight: bold;
        }

        .calc-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            font-size: 16px;
        }

        .calc-result span {
            font-weight: bold;
            font-size: 20px;
        }

        .metrics-detailed {
            display: grid;
            gap: 15px;
        }

        .metric-detail-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .metric-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .metric-detail-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .metric-detail-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .metric-detail-desc {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .metric-detail-votes {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 12px;
        }

        .vote-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            font-weight: 600;
            font-size: 11px;
        }

        .vote-malicious {
            background: #fee;
            color: #c53030;
        }

        .vote-benign {
            background: #e6fffa;
            color: #047857;
        }

        .reasoning-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .reasoning-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .reasoning-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        /* Investigation Features */
        .investigation-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .investigation-btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .investigation-btn:hover {
            background: #1e3a8a;
        }

        .investigation-banner {
            background: linear-gradient(135deg, #1e3a8a 0%, #2c5aa0 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .investigation-banner h3 {
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }

        .investigation-banner p {
            margin: 5px 0;
            opacity: 0.9;
        }

        .investigation-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }

        .investigation-info p {
            margin: 8px 0;
            color: #2d3748;
        }

        .email-context {
            margin-bottom: 20px;
        }

        .context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .context-grid div {
            background: #f7fafc;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .recipient-details-modal {
            margin-top: 15px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 6px;
            border: 1px solid #cbd5e0;
        }

        .recipient-details-modal h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
            font-size: 1rem;
        }

        .it-decision {
            background: #fed7d7;
            border: 1px solid #fc8181;
            border-radius: 6px;
        }

        .it-decision h4 {
            color: #c53030;
        }

        /* History Controls */
        .history-controls {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .search-container {
            display: flex;
            margin-bottom: 10px;
        }

        .filter-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-container select {
            min-width: 120px;
        }

        .filter-container button:hover {
            background: #4a5568;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0;
            overflow-x: auto;
            padding: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }

        .tab-btn:hover {
            color: #2c5aa0;
            background: rgba(44, 90, 160, 0.05);
        }

        .tab-btn.active {
            color: #2c5aa0;
            border-bottom-color: #2c5aa0;
            background: rgba(44, 90, 160, 0.1);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Descriptions */
        .section-description {
            color: #718096;
            margin-bottom: 25px;
            font-size: 14px;
        }

        /* Dashboard Styles */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .metric-info h3 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c5aa0;
        }

        .metric-info p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 0.9rem;
        }

        .metric-formula {
            display: block;
            margin: 3px 0 0 0;
            color: #a0aec0;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            padding: 2px 4px;
            border-radius: 3px;
            border-left: 2px solid #e2e8f0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard-widget {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .dashboard-widget h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .chart-container {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px dashed #cbd5e0;
        }

        /* Ensure Threat Trends content stays inside and scrolls instead of overflowing */
        #threatTrends {
            align-items: flex-start; /* top align */
            justify-content: flex-start; /* left align */
            overflow-y: auto; /* scroll vertically if needed */
            overflow-x: hidden; /* prevent horizontal overflow */
            padding: 6px; /* inner padding so items don't touch border */
        }

        .threat-list { width: 100%; }
        .threat-item { width: 100%; box-sizing: border-box; }

        .chart-placeholder {
            color: #718096;
            font-style: italic;
        }

        .performance-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f7fafc;
            border-radius: 4px;
        }

        .perf-label {
            font-weight: 500;
            color: #2d3748;
        }

        /* Quarantine Section */
        .quarantine-section {
            max-width: none;
        }

        .quarantine-table {
            table-layout: fixed;
            width: 100%;
        }

        .quarantine-table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .quarantine-table th:nth-child(1),
        .quarantine-table td:nth-child(1) { width: 15%; } /* Sender */

        .quarantine-table th:nth-child(2),
        .quarantine-table td:nth-child(2) { width: 12%; } /* Recipient */

        .quarantine-table th:nth-child(3),
        .quarantine-table td:nth-child(3) { width: 18%; } /* Subject */

        .quarantine-table th:nth-child(4),
        .quarantine-table td:nth-child(4) { width: 10%; } /* Classification */

        .quarantine-table th:nth-child(5),
        .quarantine-table td:nth-child(5) { width: 8%; } /* Confidence */

        .quarantine-table th:nth-child(6),
        .quarantine-table td:nth-child(6) { width: 13%; } /* Quarantine Type */

        .quarantine-table th:nth-child(7),
        .quarantine-table td:nth-child(7) { width: 10%; } /* Date */

        .quarantine-table th:nth-child(8),
        .quarantine-table td:nth-child(8) {
            width: 14%;
            white-space: normal;
        } /* Actions */

        .quarantine-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .quarantine-actions button {
            font-size: 11px;
            padding: 4px 8px;
        }

        /* Security Monitoring Section */
        .monitoring-section {
            max-width: none;
            padding: 25px;
        }

        .monitoring-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .monitoring-card h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #4299e1;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
        }

        .metric-limit, .metric-note {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 2px;
        }

        .savings-card {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-color: #48bb78;
        }

        .savings-card .metric-item {
            background: #ffffff;
            border-left-color: #48bb78;
        }

        .health-status {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }

        .status-dot.warning {
            background: #ed8936;
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
        }

        .status-dot.error {
            background: #f56565;
            box-shadow: 0 0 0 3px rgba(245, 101, 101, 0.2);
        }

        .security-alert {
            background: #fed7d7;
            border: 1px solid #fc8181;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #742a2a;
        }

        .monitoring-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }

        /* Clean up main content */
        .main-content {
            padding: 0;
            background: white;
        }

        .input-section,
        .results-section,
        .history-section,
        .quarantine-section,
        .dashboard-section {
            padding: 25px;
        }

        .history-section h2,
        .quarantine-section h2,
        .dashboard-section h2 {
            margin-top: 0;
        }

        /* Chart Styles */
        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            min-width: 120px;
            font-size: 12px;
            color: #2d3748;
            font-weight: 500;
        }

        .bar-fill {
            height: 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-size: 11px;
            font-weight: bold;
            min-width: 40px;
            position: relative;
        }

        .bar-fill.safe {
            background: linear-gradient(90deg, #38a169 0%, #48bb78 100%);
        }

        .bar-fill.suspicious {
            background: linear-gradient(90deg, #ed8936 0%, #f6ad55 100%);
        }

        .bar-fill.phishing {
            background: linear-gradient(90deg, #e53e3e 0%, #fc8181 100%);
        }

        /* Threat Trends */
        .threat-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px;
        }

        .threat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 4px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-width: 0;
        }

        .threat-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            min-width: 80px;
            text-align: center;
        }

        .threat-type.suspicious {
            background: #ed8936;
        }

        .threat-type.phishing {
            background: #e53e3e;
        }

        .threat-sender {
            flex: 1;
            font-size: 12px;
            color: #4a5568;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            min-width: 0;
        }

        .threat-date {
            font-size: 11px;
            color: #718096;
            font-weight: 500;
            min-width: 65px;
            max-width: 65px;
            text-align: right;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            flex-shrink: 0;
        }

        /* User Activity */
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f7fafc;
            border-radius: 4px;
        }

        .user-name {
            font-weight: 500;
            color: #2d3748;
            font-size: 12px;
        }

        .user-count {
            font-size: 11px;
            color: #718096;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Quarantine Actions */
        .quarantine-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .review-btn,
        .reasoning-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin: 2px;
        }

        .review-btn:hover,
        .reasoning-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .review-btn:active,
        .reasoning-btn:active {
            transform: translateY(0);
        }

        /* IT Review Dashboard Styles */
        .review-section {
            max-width: none;
        }

        .review-overview {
            margin-bottom: 30px;
        }

        .review-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            font-size: 1.8rem;
            opacity: 0.8;
        }

        .stat-info h3 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: bold;
            color: #2c5aa0;
        }

        .stat-info p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 0.9rem;
        }

        .active-review-section,
        .recent-decisions-section {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .active-review-section h3,
        .recent-decisions-section h3 {
            margin: 0 0 10px 0;
            color: #2d3748;
            font-size: 1.2rem;
        }

        .queue-description {
            color: #718096;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .review-queue-table {
            width: 100%;
            margin-top: 15px;
            table-layout: fixed;
        }

        .review-queue-container {
            overflow-x: auto;
            max-width: 100%;
        }

        .review-queue-table td {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 8px 12px;
        }

        .review-queue-table td:nth-child(2) { /* Sender column */
            max-width: 160px;
        }

        .review-queue-table td:nth-child(3) { /* Recipient column */
            max-width: 160px;
        }

        .review-queue-table td:nth-child(4) { /* Subject column */
            max-width: 200px;
        }

        .review-queue-table td:nth-child(5) { /* Classification column */
            max-width: 100px;
        }

        .review-queue-table td:nth-child(6) { /* Confidence column */
            max-width: 60px;
        }

        .review-queue-table td:nth-child(7) { /* Actions column */
            max-width: 140px;
            white-space: normal;
            min-width: 140px;
            vertical-align: top;
        }

        /* Responsive design for review queue table */
        @media (max-width: 1200px) {
            .review-queue-table td:nth-child(2) { /* Sender column */
                max-width: 130px;
            }
            .review-queue-table td:nth-child(3) { /* Recipient column */
                max-width: 130px;
            }
            .review-queue-table td:nth-child(4) { /* Subject column */
                max-width: 160px;
            }
            .review-queue-table td:nth-child(7) { /* Actions column */
                max-width: 130px;
                min-width: 130px;
            }
        }

        @media (max-width: 768px) {
            .review-queue-table {
                font-size: 12px;
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }
            .review-queue-table thead,
            .review-queue-table tbody,
            .review-queue-table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            .review-queue-table td {
                padding: 6px 8px;
            }
            .review-queue-table td:nth-child(2) { /* Sender column */
                max-width: 100px;
            }
            .review-queue-table td:nth-child(3) { /* Recipient column */
                max-width: 100px;
            }
            .review-queue-table td:nth-child(4) { /* Subject column */
                max-width: 120px;
            }
            .review-queue-table td:nth-child(7) { /* Actions column */
                max-width: 120px;
                min-width: 120px;
            }
            .review-actions {
                gap: 3px;
            }
            .review-actions button {
                font-size: 9px;
                padding: 5px 10px;
                min-width: 80px;
            }
        }

        .review-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            justify-content: center;
            align-items: center;
        }

        .review-actions button {
            font-size: 10px;
            padding: 6px 12px;
            width: 100%;
            min-width: 100px;
            white-space: nowrap;
            text-align: center;
        }

        .approve-btn,
        .reject-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 2px;
        }

        .approve-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .approve-btn:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .reject-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }

        .reject-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
        }

        .approve-btn:active,
        .reject-btn:active {
            transform: translateY(0);
        }

        .quarantine-date {
            color: #666;
            font-size: 12px;
            font-weight: 500;
        }

        /* Urgency Badges */
        .urgency-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            transition: all 0.2s ease;
        }

        .urgency-badge.clickable {
            cursor: pointer;
        }

        .urgency-badge.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .urgency-badge.clickable:active {
            transform: translateY(0);
        }

        .urgency-badge.urgent {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            animation: urgentPulse 2s infinite;
        }

        .urgency-badge.normal {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.3);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Urgent Row Styling */
        .urgent-row {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border-left: 4px solid #ff6b6b;
        }

        .urgent-row:hover {
            background: linear-gradient(135deg, #fff0f0 0%, #ffe0e0 100%);
        }

        /* Test Email Examples */
        .test-email-examples {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .test-email-examples h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .example-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .example-select-btn {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            min-height: 80px;
        }

        .example-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .example-select-btn.safe {
            border-color: #48bb78;
        }

        .example-select-btn.safe:hover {
            border-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }

        .example-select-btn.suspicious {
            border-color: #ed8936;
        }

        .example-select-btn.suspicious:hover {
            border-color: #dd6b20;
            background: linear-gradient(135deg, #fffaf0 0%, #fbd38d 100%);
        }

        .example-select-btn.phishing {
            border-color: #f56565;
        }

        .example-select-btn.phishing:hover {
            border-color: #e53e3e;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .example-select-btn.urgent {
            border-width: 3px;
            animation: urgentGlow 2s infinite;
        }

        @keyframes urgentGlow {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 107, 107, 0.3); }
            50% { box-shadow: 0 0 10px rgba(255, 107, 107, 0.6); }
        }

        .example-type {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .example-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .example-urgency {
            font-size: 11px;
            color: #718096;
            font-weight: 500;
        }

        .recent-decision {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 10px;
        }

        .decision-info {
            flex: 1;
        }

        .decision-email {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .decision-details {
            font-size: 12px;
            color: #718096;
        }

        .decision-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .decision-badge.approved {
            background: #38a169;
        }

        .decision-badge.rejected {
            background: #e53e3e;
        }

        /* Clickable decision styles */
        .recent-decision.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recent-decision.clickable:hover {
            background: #f0f9ff;
            border-color: #2c5aa0;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(44, 90, 160, 0.15);
        }

        .click-hint {
            color: #2c5aa0;
            font-weight: 500;
            font-size: 11px;
        }

        /* Email highlighting in quarantine */
        .highlighted-email {
            background: linear-gradient(90deg, #fff3cd, #ffeaa7) !important;
            border: 2px solid #f39c12 !important;
            animation: emailPulse 1s ease-in-out 3;
        }

        @keyframes emailPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .results-table {
                font-size: 14px;
            }

            .results-table th,
            .results-table td {
                padding: 10px 8px;
            }

            .ai-comment {
                max-width: 200px;
            }

            .nav-tabs {
                padding: 0 10px;
            }

            .tab-btn {
                padding: 12px 15px;
                font-size: 13px;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .metric-card {
                padding: 15px;
            }

            .metric-info h3 {
                font-size: 1.5rem;
            }

            .chart-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .bar-label {
                min-width: auto;
            }

            .review-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-info h3 {
                font-size: 1.4rem;
            }

            .recent-decision {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .review-actions {
                flex-direction: column;
                gap: 5px;
            }

            .approve-btn,
            .reject-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Healthcare Email Defense Agent</h1>
            <p>AI-Powered Email Security Analysis for Healthcare Organizations</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')"> Dashboard</button>
            <button class="tab-btn" onclick="showTab('review')"> IT Review</button>
            <button class="tab-btn" onclick="showTab('analyze')"> Test Email Generator</button>
            <button class="tab-btn" onclick="showTab('history')"> History Log</button>
            <button class="tab-btn" onclick="showTab('quarantine')"> Quarantine</button>
            <button class="tab-btn" onclick="showTab('monitoring')"> Security Monitor</button>
            <button class="tab-btn" onclick="showTab('metrics')"> Performance Metrics</button>
        </div>

        <div class="main-content">
            <!-- Observability Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="dashboard-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0;"> Observability Dashboard</h2>
                            <p class="section-description" style="margin: 5px 0 0 0;">Monitor system performance, threat trends, and AI accuracy metrics</p>
                        </div>
                        <button onclick="resetEntireSystem()" class="reset-system-btn" title="Reset all data, metrics, and history">
                             Reset System
                        </button>
                    </div>

                    <!-- Key Metrics Cards -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon"></div>
                            <div class="metric-info">
                                <h3 id="totalEmailsMetric">0</h3>
                                <p>Total Emails Processed</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"></div>
                            <div class="metric-info">
                                <h3 id="accuracyMetric">0%</h3>
                                <p>AI Accuracy Rate</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"></div>
                            <div class="metric-info">
                                <h3 id="threatsBlockedMetric">0</h3>
                                <p>Threats Detected</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts and Analysis -->
                    <div class="dashboard-grid">
                        <div class="dashboard-widget">
                            <h3> Classification Breakdown</h3>
                            <div id="classificationChart" class="chart-container">
                                <div class="chart-placeholder">Email classifications will appear here</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-widget">
                            <h3> Threat Trends</h3>
                            <div id="threatTrends" class="chart-container">
                                <div class="chart-placeholder">Threat trends will appear here</div>
                            </div>
                        </div>
                        
                        
                        <div class="dashboard-widget">
                            <h3> AI Performance</h3>
                            <div id="aiPerformance" class="performance-metrics">
                                <div class="performance-item">
                                    <span class="perf-label">False Positives:</span>
                                    <span id="falsePositiveRate">0%</span>
                                </div>
                                <div class="performance-item">
                                    <span class="perf-label">False Negatives:</span>
                                    <span id="falseNegativeRate">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IT Review Dashboard Tab -->
            <div id="review-tab" class="tab-content">
                <div class="review-section">
                    <h2> IT Review Dashboard</h2>
                    <p class="section-description">Review and process emails flagged by the AI system for human oversight</p>
                    
                    <!-- Review Queue Overview -->
                    <div class="review-overview">
                        <div class="review-stats">
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-info">
                                    <h3 id="pendingReviewCount">0</h3>
                                    <p>Pending Review</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-info">
                                    <h3 id="reviewedToday">0</h3>
                                    <p>Reviewed Today</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-info">
                                    <h3 id="reviewAccuracy">0%</h3>
                                    <p>Review Accuracy</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Review Queue -->
                    <div class="active-review-section">
                        <h3> Active Review Queue</h3>
                        <p class="queue-description">Emails requiring IT review and decision</p>
                        <div id="review-queue-container">
                            <div class="no-results">
                                No emails pending review. Flagged emails will appear here for your decision.
                            </div>
                        </div>
                    </div>

                    <!-- Recent IT Decisions -->
                    <div class="recent-decisions-section">
                        <h3> Recent IT Decisions</h3>
                        <p class="section-description">Your recent email review decisions and their outcomes</p>
                        <div id="recent-decisions-container">
                            <div class="no-results">
                                No recent decisions. Reviewed emails will appear here.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Email Generator Tab -->
            <div id="analyze-tab" class="tab-content">
            <div class="input-section">
                    <h2> Test Email Generator</h2>
                    <p class="section-description">Generate and analyze test emails to evaluate the AI defense system</p>
                
                <div class="form-group">
                    <label for="recipientEmail">Recipient Email:</label>
                    <input type="text" id="recipientEmail" placeholder="e.g., dr.smith@generalhospital.org" 
                           oninput="updateRecipientInfo()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    <div id="recipientInfo" class="recipient-info" style="display: none;">
                        <div class="recipient-details">
                            <span id="recipientName"></span>  
                            <span id="recipientRole"></span>  
                            <span id="recipientDepartment"></span>
                            <span id="unknownUserWarning" class="unknown-user-warning" style="display: none;">
                                 Unknown user - role inferred from email pattern
                            </span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sender">Sender Email:</label>
                    <input type="text" id="sender" placeholder="e.g., admin@hospital.com">
                </div>

                <div class="form-group">
                    <label for="subject">Subject:</label>
                    <input type="text" id="subject" placeholder="Email subject line">
                </div>

                <div class="form-group">
                    <label for="body">Email Body:</label>
                    <textarea id="body" placeholder="Paste the email content here..."></textarea>
                </div>

                <!-- Pre-written Test Emails -->
                <div class="test-email-examples">
                    <h3> Quick Test Examples</h3>
                    <p class="section-description">Select from pre-written test emails for consistent testing</p>
                    
                    <div class="example-buttons-grid">
                        <button class="example-select-btn safe" onclick="selectTestEmail('safe1')">
                            <span class="example-type"> Safe</span>
                            <span class="example-title">Staff Meeting Reminder</span>
                            <span class="example-urgency">Normal</span>
                        </button>
                        
                        <button class="example-select-btn safe urgent" onclick="selectTestEmail('safe2')">
                            <span class="example-type"> Safe</span>
                            <span class="example-title">HIPAA Training Required</span>
                            <span class="example-urgency">Urgent</span>
                        </button>
                        
                        <button class="example-select-btn suspicious" onclick="selectTestEmail('suspicious1')">
                            <span class="example-type"> Suspicious</span>
                            <span class="example-title">Unusual Access Request</span>
                            <span class="example-urgency">Normal</span>
                        </button>
                        
                        <button class="example-select-btn suspicious urgent" onclick="selectTestEmail('suspicious2')">
                            <span class="example-type"> Suspicious</span>
                            <span class="example-title">Urgent Policy Change</span>
                            <span class="example-urgency">Urgent</span>
                        </button>
                        
                        <button class="example-select-btn phishing" onclick="selectTestEmail('phishing1')">
                            <span class="example-type"> Phishing</span>
                            <span class="example-title">Account Suspension Alert</span>
                            <span class="example-urgency">Normal</span>
                        </button>
                        
                        <button class="example-select-btn phishing urgent" onclick="selectTestEmail('phishing2')">
                            <span class="example-type"> Phishing</span>
                            <span class="example-title">Emergency Security Breach</span>
                            <span class="example-urgency">Urgent</span>
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="analyze-btn" onclick="analyzeEmail()"> Test Email</button>
                    <button class="example-btn" onclick="generateExample()"> Generate Example</button>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                        <p>Testing email with AI...</p>
                </div>
            </div>

            </div>

            <!-- History Log Tab -->
            <div id="history-tab" class="tab-content">
            <div class="history-section">
                <h2> History Log</h2>
                    <p class="section-description">View processed emails and investigate past decisions</p>
                    
                    <!-- Search and Filter Controls -->
                    <div class="history-controls">
                        <div class="search-container">
                            <input type="text" id="historySearch" placeholder=" Search by sender, subject, or recipient..." 
                                   oninput="filterHistory()" style="flex: 1; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
                        </div>
                        <div class="filter-container">
                            <select id="classificationFilter" onchange="filterHistory()" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin-right: 10px;">
                                <option value="">All Classifications</option>
                                <option value="safe">Safe</option>
                                <option value="suspicious">Suspicious</option>
                                <option value="phishing">Phishing</option>
                            </select>
                            <select id="statusFilter" onchange="filterHistory()" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin-right: 10px;">
                                <option value="">All Statuses</option>
                                <option value="auto_safe">Auto-Approved</option>
                                <option value="auto_quarantine">Auto-Quarantined</option>
                                <option value="auto_learned">Auto-Learned</option>
                                <option value="it_quarantined">IT Quarantined</option>
                                <option value="it_approved">IT Approved</option>
                            </select>
                            <button onclick="clearFilters()" style="padding: 8px 12px; background: #718096; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
                        </div>
                    </div>
                    
                <div id="history-container">
                    <div class="no-results">
                        No emails in history yet. Reviewed emails and safe emails will appear here.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quarantine Tab -->
            <div id="quarantine-tab" class="tab-content">
                <div class="quarantine-section">
                    <h2> Quarantine</h2>
                    <p class="section-description">Emails that have been quarantined by IT staff decisions</p>
                    <div id="quarantine-container">
                        <div class="no-results">
                            No emails have been quarantined yet. IT decisions will appear here.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Monitoring Tab -->
            <div id="monitoring-tab" class="tab-content">
                <div class="monitoring-section">
                    <h2> DDOS & Security Protection Monitor</h2>
                    <p class="section-description">Real-time monitoring of rate limiting, caching, pre-filtering, and threat prevention</p>

                    <!-- Alert Banner -->
                    <div id="security-alert-banner" class="security-alert" style="display: none;">
                        <strong> Security Alert:</strong> <span id="alert-message"></span>
                    </div>

                    <!-- Rate Limiting Status -->
                    <div class="monitoring-card">
                        <h3> Rate Limiting Status</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Total Requests</div>
                                <div class="metric-value" id="total-requests">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Blocked Requests</div>
                                <div class="metric-value" id="blocked-requests">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Last Hour</div>
                                <div class="metric-value" id="requests-last-hour">0</div>
                                <div class="metric-limit">/ 50 limit</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Last Minute</div>
                                <div class="metric-value" id="requests-last-minute">0</div>
                                <div class="metric-limit">/ 10 limit</div>
                            </div>
                        </div>
                    </div>

                    <!-- Cache Performance -->
                    <div class="monitoring-card">
                        <h3> Email Deduplication & Cache</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Cache Hits</div>
                                <div class="metric-value" id="cache-hits">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Cache Misses</div>
                                <div class="metric-value" id="cache-misses">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Hit Rate</div>
                                <div class="metric-value" id="cache-hit-rate">0%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Cached Emails</div>
                                <div class="metric-value" id="cache-size">0</div>
                                <div class="metric-limit">/ 100 max</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pre-Filter Performance -->
                    <div class="monitoring-card">
                        <h3> Pre-Filter Performance</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Total Pre-Filtered</div>
                                <div class="metric-value" id="prefiltered-total">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Safe Auto-Pass</div>
                                <div class="metric-value" id="prefiltered-safe">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Phishing Caught</div>
                                <div class="metric-value" id="prefiltered-phishing">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">AI Analysis Needed</div>
                                <div class="metric-value" id="ai-analysis-needed">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Auto-Triage Stats -->
                    <div class="monitoring-card">
                        <h3> Auto-Triage System</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Auto-Approved</div>
                                <div class="metric-value" id="auto-approved">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Auto-Quarantined</div>
                                <div class="metric-value" id="auto-quarantined">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Manual Review Required</div>
                                <div class="metric-value" id="manual-review">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">IT Workload Reduction</div>
                                <div class="metric-value" id="workload-reduction">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Token Savings -->
                    <div class="monitoring-card savings-card">
                        <h3> Cost & Token Savings</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">AI Calls Saved</div>
                                <div class="metric-value" id="ai-calls-saved">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Estimated Tokens Saved</div>
                                <div class="metric-value" id="tokens-saved">0</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Est. Cost Savings</div>
                                <div class="metric-value" id="cost-savings">$0.00</div>
                                <div class="metric-note">(@$0.001/1K tokens)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Efficiency Gain</div>
                                <div class="metric-value" id="efficiency-gain">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="monitoring-card">
                        <h3> System Health</h3>
                        <div class="health-status">
                            <div class="health-indicator">
                                <span class="status-dot" id="rate-limit-status"></span>
                                <span>Rate Limiting: <strong id="rate-limit-text">Active</strong></span>
                            </div>
                            <div class="health-indicator">
                                <span class="status-dot" id="cache-status"></span>
                                <span>Email Cache: <strong id="cache-text">Operational</strong></span>
                            </div>
                            <div class="health-indicator">
                                <span class="status-dot" id="prefilter-status"></span>
                                <span>Pre-Filter: <strong id="prefilter-text">Active</strong></span>
                            </div>
                            <div class="health-indicator">
                                <span class="status-dot" id="autotriage-status"></span>
                                <span>Auto-Triage: <strong id="autotriage-text">Enabled</strong></span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="monitoring-actions">
                        <button class="action-btn" onclick="resetSecurityMetrics()"> Reset Metrics</button>
                        <button class="action-btn" onclick="exportSecurityMetrics()"> Export Data</button>
                        <button class="action-btn" onclick="updateMonitoringDisplay()"> Refresh</button>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics Tab -->
            <div id="metrics-tab" class="tab-content">
                <div class="monitoring-section">
                    <h2> Performance Metrics - Interactive Guide</h2>
                    <p class="section-description">Understanding AI Email Security Agent Performance</p>

                    <!-- False Positive Rate -->
                    <div class="monitoring-card" style="cursor: pointer;" onclick="toggleMetricCard(this)">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; font-size: 30px; margin-right: 20px;"></div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; font-size: 1.5em;">False Positive Rate (FPR)</h3>
                                <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9em;">Measuring Alert Noise</p>
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 1.1em; color: #2d3748; margin: 20px 0; border-left: 4px solid #667eea;">
                            FPR = (Emails Quarantined by Agent BUT Marked  Legit by Human) / Total Reviewed Emails  100%
                        </div>

                        <div style="line-height: 1.8; color: #4a5568; font-size: 1.05em; margin: 20px 0;">
                            <p><strong>What is a False Positive?</strong></p>
                            <p>A false positive occurs when the AI Agent flags and quarantines an email that is actually legitimate, creating unnecessary alerts for the IT team.</p>

                            <div style="background: #fff5f5; border-left: 4px solid #f56565; padding: 15px; margin: 15px 0; border-radius: 5px;">
                                <strong style="color: #c53030;">Example:</strong> An important business email from a client gets quarantined because it contains phrases like "urgent payment," which the system mistakenly identifies as a phishing attempt.
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 1.3em;"> Thesis Significance: Solving Alert Fatigue</h4>
                            <p style="margin: 0;">Lower FPR means IT staff see less "noise," allowing them to focus only on critical threats. This directly improves work efficiency and reduces alert fatigue caused by excessive false alarms.</p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 10px; margin-top: 20px; border: 2px solid #e2e8f0;">
                            <h4 style="margin: 0 0 20px 0;"> Calculator: Try Calculating FPR</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px; color: #2d3748;">Total Reviewed Emails:</label>
                                    <input type="number" id="fp-total" value="1000" min="1" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px; color: #2d3748;">False Positive Emails:</label>
                                    <input type="number" id="fp-false" value="50" min="0" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                                </div>
                            </div>
                            <button onclick="calculateFP()" style="width: 100%; background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">Calculate False Positive Rate</button>
                            <div id="fp-result" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; font-size: 1.5em; font-weight: bold; margin-top: 20px;"></div>

                            <div style="margin-top: 30px;">
                                <canvas id="fpChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- AI Accuracy Rate -->
                    <div class="monitoring-card" style="cursor: pointer;" onclick="toggleMetricCard(this)">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; font-size: 30px; margin-right: 20px;"></div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; font-size: 1.5em;">AI Accuracy Rate</h3>
                                <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9em;">Proving Trustworthiness</p>
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 1.1em; color: #2d3748; margin: 20px 0; border-left: 4px solid #667eea;">
                            Accuracy = (Emails Marked  Correct by Human Reviewer) / Total Reviewed Emails  100%
                        </div>

                        <div style="line-height: 1.8; color: #4a5568; font-size: 1.05em; margin: 20px 0;">
                            <p><strong>What is Accuracy Rate?</strong></p>
                            <p>The percentage of times the AI Agent's judgment (whether flagging as threat or marking as safe) aligns with human expert assessment.</p>

                            <div style="background: #fff5f5; border-left: 4px solid #f56565; padding: 15px; margin: 15px 0; border-radius: 5px;">
                                <strong style="color: #c53030;">Example:</strong> The AI flags 100 emails. Human reviewers confirm that 92 of those judgments were correct, resulting in 92% accuracy.
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 1.3em;"> Thesis Significance: Proves Trustworthiness</h4>
                            <p style="margin: 0;">The rise in this number validates that Reinforced Learning is occurring, making the Agent more reliable. As the AI learns from human feedback over time, its judgments become increasingly accurate and trustworthy.</p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 10px; margin-top: 20px; border: 2px solid #e2e8f0;">
                            <h4 style="margin: 0 0 20px 0;"> Calculator: Try Calculating Accuracy</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px; color: #2d3748;">Total Reviewed Emails:</label>
                                    <input type="number" id="acc-total" value="1000" min="1" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px; color: #2d3748;">Correctly Judged Emails:</label>
                                    <input type="number" id="acc-correct" value="920" min="0" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                                </div>
                            </div>
                            <button onclick="calculateAccuracy()" style="width: 100%; background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">Calculate Accuracy Rate</button>
                            <div id="acc-result" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; font-size: 1.5em; font-weight: bold; margin-top: 20px;"></div>

                            <div style="margin-top: 30px;">
                                <canvas id="accChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Confidence Score -->
                    <div class="monitoring-card" style="cursor: pointer;" onclick="toggleMetricCard(this)">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); display: flex; align-items: center; justify-content: center; font-size: 30px; margin-right: 20px;"></div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; font-size: 1.5em;">Confidence Score</h3>
                                <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9em;">Streamlining Workload</p>
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 1.1em; color: #2d3748; margin: 20px 0; border-left: 4px solid #667eea;">
                            Confidence = LLM's internal judgment based on signal analysis (0-100%)
                        </div>

                        <div style="line-height: 1.8; color: #4a5568; font-size: 1.05em; margin: 20px 0;">
                            <p><strong>What is Confidence Score?</strong></p>
                            <p>The AI Agent's level of certainty in its own judgment, calculated based on the number and quality of detected threat signals.</p>

                            <div style="background: #fff5f5; border-left: 4px solid #f56565; padding: 15px; margin: 15px 0; border-radius: 5px;">
                                <strong style="color: #c53030;">Example:</strong> 4 signals detected (suspicious link, urgent tone, unknown sender, spelling errors)  85% confidence score
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 1.3em;"> Thesis Significance: Mitigates Judgment Fatigue</h4>
                            <p style="margin: 0;">Higher scores mean the Agent is certain and can handle cases automatically. Low scores (<70%) prompt Director Li for priority review, streamlining his workload to focus only on complex cases requiring human judgment.</p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 10px; margin-top: 20px; border: 2px solid #e2e8f0;">
                            <h4 style="margin: 0 0 20px 0;"> Simulator: Threat Signals vs Confidence</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px; color: #2d3748;">Detected Threat Signals:</label>
                                    <input type="number" id="conf-signals" value="4" min="0" max="10" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px; color: #2d3748;">Total Possible Signals:</label>
                                    <input type="number" id="conf-total-signals" value="10" min="1" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                                </div>
                            </div>
                            <button onclick="calculateConfidence()" style="width: 100%; background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">Calculate Confidence Score</button>
                            <div id="conf-result" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; font-size: 1.5em; font-weight: bold; margin-top: 20px;"></div>

                            <div style="margin-top: 30px;">
                                <canvas id="confChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Review Modal -->
    <div id="emailModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Email Review</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="email-details">
                    <div class="email-field">
                        <div class="field-label">From:</div>
                        <div class="email-value" id="modalSender"></div>
                    </div>
                    <div class="email-field">
                        <div class="field-label">To:</div>
                        <div class="email-value" id="modalRecipient"></div>
                    </div>
                    <div class="email-field">
                        <div class="field-label">Subject:</div>
                        <div class="email-value" id="modalSubject"></div>
                    </div>
                    <div class="email-field">
                        <div class="field-label">Body:</div>
                        <div class="email-body" id="modalBody"></div>
                    </div>
                </div>
                
                <div class="analysis-details">
                    <h3> AI Analysis</h3>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="field-label">Classification:</div>
                            <span id="modalClassification"></span>
                        </div>
                        <div class="analysis-item">
                            <div class="field-label">Confidence:</div>
                            <span id="modalConfidence"></span>
                        </div>
                        <div class="analysis-item">
                            <div class="field-label">AI Comment:</div>
                            <span id="modalComment"></span>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="feedback-btn correct" onclick="confirmFeedbackFromModal('correct')">
                         Quarantine
                    </button>
                    <button class="feedback-btn incorrect" onclick="confirmFeedbackFromModal('incorrect')">
                         Send Email
                    </button>
                    <button class="reasoning-btn" id="modalReasoningBtn" onclick="openReasoningFromModal()" style="display: none;">
                         Reasoning Report
                    </button>
                    <button class="modal-close-btn" onclick="closeModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reasoning Report Modal -->
    <div id="reasoningModal" class="modal" style="display: none;">
        <div class="modal-content reasoning-modal-content">
            <div class="modal-header">
                <h2> Detailed Reasoning Report</h2>
                <span class="close" onclick="closeReasoningModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="reasoningModalContent">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-close-btn" onclick="closeReasoningModal()">
                    Close Report
                </button>
            </div>
        </div>
    </div>

    <!-- Confidence Breakdown Modal -->
    <div id="confidenceModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2> Confidence Score Analysis</h2>
                <span class="close" onclick="closeConfidenceModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <!-- Overview Section -->
                <div class="confidence-overview">
                    <div class="confidence-main-score">
                        <span class="confidence-label">Final Confidence Score:</span>
                        <span class="confidence-value-large" id="confModalScore">--</span>
                    </div>
                    <div class="confidence-meta">
                        <div class="meta-item">
                            <span class="meta-label">Autonomy Band:</span>
                            <span class="meta-value" id="confModalBand">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Risk Assessment:</span>
                            <span class="meta-value" id="confModalRisk">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Decision:</span>
                            <span class="meta-value" id="confModalDecision">--</span>
                        </div>
                    </div>
                </div>

                <!-- Channel Scores Section -->
                <div class="confidence-section">
                    <h3> Evidence Channels (Weighted Scoring)</h3>
                    <div id="confModalChannels"></div>
                </div>

                <!-- Aggregation Calculation -->
                <div class="confidence-section">
                    <h3> Risk Score Calculation</h3>
                    <div class="calculation-box">
                        <div class="calc-formula">
                            <strong>Formula:</strong> Risk = (Weight  Quality  Score) / (Weight  Quality)
                        </div>
                        <div id="confModalAggregation"></div>
                        <div class="calc-result">
                            <strong>Raw Risk Score:</strong> <span id="confModalRawRisk">--</span>
                        </div>
                    </div>
                </div>

                <!-- Quality & Agreement Metrics -->
                <div class="confidence-section">
                    <h3> Quality & Agreement Metrics</h3>
                    <div class="metrics-detailed">
                        <div class="metric-detail-item">
                            <div class="metric-detail-header">
                                <span class="metric-detail-label">Channel Agreement</span>
                                <span class="metric-detail-value" id="confModalAgreement">--</span>
                            </div>
                            <div class="metric-detail-desc" id="confModalAgreementDesc">--</div>
                            <div class="metric-detail-votes" id="confModalVotes">--</div>
                        </div>
                        <div class="metric-detail-item">
                            <div class="metric-detail-header">
                                <span class="metric-detail-label">Evidence Completeness</span>
                                <span class="metric-detail-value" id="confModalCompleteness">--</span>
                            </div>
                            <div class="metric-detail-desc">Measures how much evidence was available across all channels</div>
                        </div>
                        <div class="metric-detail-item">
                            <div class="metric-detail-header">
                                <span class="metric-detail-label">Uncertainty Level</span>
                                <span class="metric-detail-value" id="confModalUncertainty">--</span>
                            </div>
                            <div class="metric-detail-desc" id="confModalUncertaintyDesc">--</div>
                        </div>
                        <div class="metric-detail-item">
                            <div class="metric-detail-header">
                                <span class="metric-detail-label">Decision Margin</span>
                                <span class="metric-detail-value" id="confModalMargin">--</span>
                            </div>
                            <div class="metric-detail-desc">Distance from decision threshold (0.5) - larger = more certain</div>
                        </div>
                    </div>
                </div>

                <!-- Final Confidence Formula -->
                <div class="confidence-section">
                    <h3> Final Confidence Calculation</h3>
                    <div class="calculation-box">
                        <div class="calc-formula">
                            <strong>Formula:</strong><br>
                            Confidence = (0.55  Probability) + (0.20  Margin) + (0.15  Agreement) + (0.10  Completeness) - (0.10  Uncertainty)
                        </div>
                        <div id="confModalFinalCalc"></div>
                    </div>
                </div>

                <!-- Context-Specific Caps -->
                <div class="confidence-section" id="confModalAdjustments" style="display: none;">
                    <h3> Context-Specific Adjustments & Caps</h3>
                    <div id="confModalAdjustmentsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn" onclick="closeConfidenceModal()">Close Analysis</button>
            </div>
        </div>
    </div>

    <!-- Urgency Reasoning Modal -->
    <div id="urgencyModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2> Priority Classification Reasoning</h2>
                <span class="close" onclick="closeUrgencyModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <!-- Email Context -->
                <div class="confidence-section">
                    <h3> Email Context</h3>
                    <div id="urgencyEmailContext"></div>
                </div>

                <!-- Classification Result -->
                <div class="confidence-section">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Priority Classification:</div>
                        <div style="font-size: 36px; font-weight: bold;" id="urgencyClassification">--</div>
                    </div>
                </div>

                <!-- A. Security (Hard Checks) -->
                <div class="confidence-section">
                    <h3> A. Security Analysis (Hard Checks)</h3>
                    <div id="urgencySecurityChecks"></div>
                </div>

                <!-- B. Context & Intent (LLM Inference) -->
                <div class="confidence-section">
                    <h3> B. Context & Intent (AI Analysis)</h3>
                    <div id="urgencyContextIntent"></div>
                </div>

                <!-- C. Time & Behavior (Advanced) -->
                <div class="confidence-section">
                    <h3> C. Time & Behavior Analysis</h3>
                    <div id="urgencyTimeBehavior"></div>
                </div>

                <!-- Final Decision -->
                <div class="confidence-section">
                    <h3> Final Decision Summary</h3>
                    <div id="urgencyFinalSummary"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn" onclick="closeUrgencyModal()">Close Analysis</button>
            </div>
        </div>
    </div>

    <script>
        let analysisResults = [];
        let historyResults = [];
        let openrouterApiKey = '';
        let generationCounter = 0;
        let lastGeneratedType = null;
        
        // Agentic capabilities - persistent memory and learning
        let agentMemory = {
            learnedPatterns: {},
            feedbackHistory: [],
            threatIntelligence: {},
            rolePatterns: {
                // Store role-specific pattern learning
                // Structure: role -> pattern -> { count, classification, lastSeen }
            },
            performanceMetrics: {
                totalAnalyzed: 0,
                correctPredictions: 0,
                accuracyRate: 0,
                phishingCaught: 0,
                falsePositives: 0,
                securityThreatsBlocked: 0,
                highThreatEmails: 0,
                roleMismatches: 0
            },
            autoActions: {
                quarantineThreshold: 85,
                escalationThreshold: 90,
                autoQuarantineEnabled: true
            }
        };

        // Internal User Directory - Maps email addresses to roles
        const userDirectory = {
            // Medical Staff
            'dr.smith@generalhospital.org': { role: 'doctor', name: 'Dr. Sarah Smith', department: 'Cardiology' },
            'dr.johnson@generalhospital.org': { role: 'doctor', name: 'Dr. Michael Johnson', department: 'Emergency Medicine' },
            'dr.patel@generalhospital.org': { role: 'doctor', name: 'Dr. Priya Patel', department: 'Pediatrics' },
            'dr.chen@generalhospital.org': { role: 'doctor', name: 'Dr. Lisa Chen', department: 'Surgery' },
            
            // Nursing Staff
            'nurse.williams@generalhospital.org': { role: 'nurse', name: 'Rebecca Williams, RN', department: 'ICU' },
            'nurse.davis@generalhospital.org': { role: 'nurse', name: 'James Davis, RN', department: 'Emergency' },
            'nurse.garcia@generalhospital.org': { role: 'nurse', name: 'Maria Garcia, RN', department: 'Pediatrics' },
            'nurse.brown@generalhospital.org': { role: 'nurse', name: 'Ashley Brown, RN', department: 'Surgery' },
            'charge.nurse@generalhospital.org': { role: 'nurse', name: 'Patricia Martinez, RN', department: 'Charge Nurse' },
            
            // Administrative Staff
            'admin.thompson@generalhospital.org': { role: 'admin', name: 'Robert Thompson', department: 'Hospital Administration' },
            'admin.wilson@generalhospital.org': { role: 'admin', name: 'Jennifer Wilson', department: 'Patient Services' },
            'hr@generalhospital.org': { role: 'admin', name: 'HR Department', department: 'Human Resources' },
            'compliance@generalhospital.org': { role: 'admin', name: 'Compliance Office', department: 'Regulatory Affairs' },
            'admin.lee@generalhospital.org': { role: 'admin', name: 'David Lee', department: 'Medical Records' },
            
            // IT Staff
            'it.support@generalhospital.org': { role: 'it', name: 'IT Support Team', department: 'Information Technology' },
            'it.security@generalhospital.org': { role: 'it', name: 'IT Security Team', department: 'Cybersecurity' },
            'sysadmin@generalhospital.org': { role: 'it', name: 'System Administrator', department: 'IT Infrastructure' },
            'it.miller@generalhospital.org': { role: 'it', name: 'Kevin Miller', department: 'Network Administration' },
            
            // Maintenance/Janitorial
            'maintenance.supervisor@generalhospital.org': { role: 'janitor', name: 'Maintenance Supervisor', department: 'Facilities' },
            'janitor.lopez@generalhospital.org': { role: 'janitor', name: 'Carlos Lopez', department: 'Environmental Services' },
            'facilities@generalhospital.org': { role: 'janitor', name: 'Facilities Management', department: 'Building Operations' },
            'cleaning.crew@generalhospital.org': { role: 'janitor', name: 'Cleaning Crew', department: 'Housekeeping' },
            
            // Security Personnel
            'security.chief@generalhospital.org': { role: 'security', name: 'Security Chief', department: 'Hospital Security' },
            'security.desk@generalhospital.org': { role: 'security', name: 'Security Desk', department: 'Access Control' },
            'guard.adams@generalhospital.org': { role: 'security', name: 'John Adams', department: 'Security Patrol' },
            
            // Billing Department
            'billing@generalhospital.org': { role: 'billing', name: 'Billing Department', department: 'Revenue Cycle' },
            'billing.manager@generalhospital.org': { role: 'billing', name: 'Billing Manager', department: 'Financial Services' },
            'insurance.claims@generalhospital.org': { role: 'billing', name: 'Insurance Claims', department: 'Claims Processing' },
            'billing.rodriguez@generalhospital.org': { role: 'billing', name: 'Ana Rodriguez', department: 'Patient Billing' },
            
            // Pharmacy Staff
            'pharmacy.chief@generalhospital.org': { role: 'pharmacy', name: 'Chief Pharmacist', department: 'Hospital Pharmacy' },
            'pharmacy.tech@generalhospital.org': { role: 'pharmacy', name: 'Pharmacy Technician', department: 'Medication Services' },
            'pharmacist.white@generalhospital.org': { role: 'pharmacy', name: 'Dr. Susan White, PharmD', department: 'Clinical Pharmacy' },
            
            // Lab Technicians
            'lab.supervisor@generalhospital.org': { role: 'lab', name: 'Lab Supervisor', department: 'Laboratory Services' },
            'lab.tech@generalhospital.org': { role: 'lab', name: 'Lab Technician', department: 'Clinical Lab' },
            'pathology@generalhospital.org': { role: 'lab', name: 'Pathology Department', department: 'Anatomical Pathology' },
            'lab.jones@generalhospital.org': { role: 'lab', name: 'Michelle Jones, MLT', department: 'Blood Bank' },
            
            // Radiology Staff
            'radiology.chief@generalhospital.org': { role: 'radiology', name: 'Chief Radiologist', department: 'Imaging Services' },
            'xray.tech@generalhospital.org': { role: 'radiology', name: 'X-Ray Technician', department: 'Diagnostic Imaging' },
            'mri.tech@generalhospital.org': { role: 'radiology', name: 'MRI Technician', department: 'Advanced Imaging' },
            'radiology.clark@generalhospital.org': { role: 'radiology', name: 'Dr. Mark Clark', department: 'Interventional Radiology' }
        };

        // Function to detect recipient role from email address
        function detectRecipientRole(recipientEmail) {
            if (!recipientEmail || typeof recipientEmail !== 'string') {
                return null;
            }
            
            const email = recipientEmail.toLowerCase().trim();
            const userInfo = userDirectory[email];
            
            if (userInfo) {
                return {
                    role: userInfo.role,
                    name: userInfo.name,
                    department: userInfo.department,
                    isKnownUser: true
                };
            }
            
            // Fallback: Try to infer role from email patterns
            if (email.includes('dr.') || email.includes('doctor')) {
                return { role: 'doctor', name: 'Unknown Doctor', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('nurse')) {
                return { role: 'nurse', name: 'Unknown Nurse', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('admin')) {
                return { role: 'admin', name: 'Unknown Admin', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('it.') || email.includes('tech')) {
                return { role: 'it', name: 'Unknown IT Staff', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('maintenance') || email.includes('janitor') || email.includes('facilities')) {
                return { role: 'janitor', name: 'Unknown Maintenance', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('security')) {
                return { role: 'security', name: 'Unknown Security', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('billing') || email.includes('finance')) {
                return { role: 'billing', name: 'Unknown Billing Staff', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('pharmacy') || email.includes('pharm')) {
                return { role: 'pharmacy', name: 'Unknown Pharmacy Staff', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('lab')) {
                return { role: 'lab', name: 'Unknown Lab Staff', department: 'Unknown', isKnownUser: false };
            } else if (email.includes('radiology') || email.includes('xray') || email.includes('imaging')) {
                return { role: 'radiology', name: 'Unknown Radiology Staff', department: 'Unknown', isKnownUser: false };
            }
            
            return null;
        }

        // Load API key from server on page load
        async function loadApiKey() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                openrouterApiKey = config.openrouterApiKey;
                
                console.log('API key loaded:', openrouterApiKey ? 'Yes' : 'No');
                console.log('API key length:', openrouterApiKey ? openrouterApiKey.length : 0);
                if (!openrouterApiKey) {
                    console.error('No API key found! Make sure OPENROUTER_API_KEY is set in .env file');
                }
                
                // Hide API key section if key is available
                if (openrouterApiKey) {
                    const apiKeySection = document.querySelector('.api-key-section');
                    if (apiKeySection) {
                        apiKeySection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading API key:', error);
                console.log('Running in static mode - API key must be entered manually');
            }
        }

        // Load API key and agent memory when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadAgentMemory();
            loadSecurityMetrics(); // Load DDOS protection metrics
            recalculateAccuracy(); // Fix any existing accuracy calculations
            updateResultsDisplay(); // Make sure to update displays
            updateHistoryDisplay();
            updateAgentStatus();
            updateMonitoringDisplay(); // Initialize monitoring dashboard
            updateDashboard(); // Initialize main dashboard metrics
            updateReviewDashboard(); // Initialize IT Review dashboard
        });

        // Load agent memory from localStorage
        function loadAgentMemory() {
            const saved = localStorage.getItem('healthcareAgentMemory');
            if (saved) {
                agentMemory = { ...agentMemory, ...JSON.parse(saved) };
                console.log('Agent memory loaded:', agentMemory);
            }
            
            // Load history results
            const savedHistory = localStorage.getItem('healthcareHistoryResults');
            if (savedHistory) {
                historyResults = JSON.parse(savedHistory);
                const withBreakdown = historyResults.filter(r => r.confidenceBreakdown).length;
                console.log('History results loaded:', historyResults.length, 'items',
                           `(${withBreakdown} with detailed breakdown)`);
            }

            // Load active review results
            const savedActiveResults = localStorage.getItem('healthcareActiveResults');
            if (savedActiveResults) {
                analysisResults = JSON.parse(savedActiveResults);
                const withBreakdown = analysisResults.filter(r => r.confidenceBreakdown).length;
                console.log('Active review results loaded:', analysisResults.length, 'items',
                           `(${withBreakdown} with detailed breakdown)`);
            }
        }

        // Save agent memory to localStorage
        function saveAgentMemory() {
            localStorage.setItem('healthcareAgentMemory', JSON.stringify(agentMemory));
            localStorage.setItem('healthcareHistoryResults', JSON.stringify(historyResults));
            localStorage.setItem('healthcareActiveResults', JSON.stringify(analysisResults));
        }

        // 
        // PHASE 1 DEFENSE SYSTEMS - DDOS & FLOODING PROTECTION
        // 

        // Initialize security metrics tracking
        let securityMetrics = {
            rateLimits: {
                requestTimestamps: [],
                totalBlocked: 0,
                lastBlockedTime: null
            },
            cache: {
                emailCache: {}, // hash -> result
                cacheHits: 0,
                cacheMisses: 0
            },
            preFilter: {
                totalPreFiltered: 0,
                safePasses: 0,
                phishingCaught: 0
            },
            autoTriage: {
                autoApproved: 0,
                autoQuarantined: 0,
                manualReview: 0
            },
            monitoring: {
                totalRequests: 0,
                aiCallsSaved: 0,
                tokensSaved: 0 // Estimated
            }
        };

        // Load security metrics from localStorage
        function loadSecurityMetrics() {
            const saved = localStorage.getItem('securityMetrics');
            if (saved) {
                const loaded = JSON.parse(saved);
                // Merge with defaults to handle new fields
                securityMetrics = { ...securityMetrics, ...loaded };
                console.log('Security metrics loaded');
            }
        }

        // Save security metrics to localStorage
        function saveSecurityMetrics() {
            localStorage.setItem('securityMetrics', JSON.stringify(securityMetrics));
        }

        // Update security metrics
        function updateSecurityMetrics(eventType) {
            securityMetrics.monitoring.totalRequests++;

            switch(eventType) {
                case 'rateLimitTriggered':
                    securityMetrics.rateLimits.totalBlocked++;
                    securityMetrics.rateLimits.lastBlockedTime = new Date().toISOString();
                    break;
                case 'cacheHit':
                    securityMetrics.cache.cacheHits++;
                    securityMetrics.monitoring.aiCallsSaved++;
                    securityMetrics.monitoring.tokensSaved += 1500; // Avg tokens per analysis
                    break;
                case 'cacheMiss':
                    securityMetrics.cache.cacheMisses++;
                    break;
                case 'preFiltered':
                    securityMetrics.preFilter.totalPreFiltered++;
                    securityMetrics.monitoring.aiCallsSaved++;
                    securityMetrics.monitoring.tokensSaved += 1500;
                    break;
                case 'autoApproved':
                    securityMetrics.autoTriage.autoApproved++;
                    break;
                case 'autoQuarantined':
                    securityMetrics.autoTriage.autoQuarantined++;
                    break;
                case 'manualReview':
                    securityMetrics.autoTriage.manualReview++;
                    break;
            }

            saveSecurityMetrics();
            updateMonitoringDisplay();
        }

        // 
        // 1. RATE LIMITING SYSTEM
        // 

        const RATE_LIMITS = {
            perMinute: 10,      // Max 10 requests per minute
            perHour: 50,        // Max 50 requests per hour
            perDay: 200         // Max 200 requests per day
        };

        function checkRateLimit() {
            const now = Date.now();
            const oneMinute = 60 * 1000;
            const oneHour = 60 * 60 * 1000;
            const oneDay = 24 * 60 * 60 * 1000;

            // Clean up old timestamps (older than 24 hours)
            securityMetrics.rateLimits.requestTimestamps =
                securityMetrics.rateLimits.requestTimestamps.filter(ts => now - ts < oneDay);

            const timestamps = securityMetrics.rateLimits.requestTimestamps;

            // Check per-minute limit
            const lastMinute = timestamps.filter(ts => now - ts < oneMinute).length;
            if (lastMinute >= RATE_LIMITS.perMinute) {
                return {
                    allowed: false,
                    message: `You've exceeded the rate limit of ${RATE_LIMITS.perMinute} requests per minute.`,
                    waitTime: '1 minute',
                    limit: 'perMinute'
                };
            }

            // Check per-hour limit
            const lastHour = timestamps.filter(ts => now - ts < oneHour).length;
            if (lastHour >= RATE_LIMITS.perHour) {
                const oldestInHour = Math.min(...timestamps.filter(ts => now - ts < oneHour));
                const waitMinutes = Math.ceil((oneHour - (now - oldestInHour)) / 60000);
                return {
                    allowed: false,
                    message: `You've exceeded the rate limit of ${RATE_LIMITS.perHour} requests per hour.`,
                    waitTime: `${waitMinutes} minute${waitMinutes > 1 ? 's' : ''}`,
                    limit: 'perHour'
                };
            }

            // Check per-day limit
            const lastDay = timestamps.filter(ts => now - ts < oneDay).length;
            if (lastDay >= RATE_LIMITS.perDay) {
                const oldestInDay = Math.min(...timestamps.filter(ts => now - ts < oneDay));
                const waitHours = Math.ceil((oneDay - (now - oldestInDay)) / 3600000);
                return {
                    allowed: false,
                    message: `You've exceeded the daily limit of ${RATE_LIMITS.perDay} requests.`,
                    waitTime: `${waitHours} hour${waitHours > 1 ? 's' : ''}`,
                    limit: 'perDay'
                };
            }

            // All checks passed - record this request
            securityMetrics.rateLimits.requestTimestamps.push(now);
            saveSecurityMetrics();

            return { allowed: true };
        }

        // 
        // 2. EMAIL HASHING & DEDUPLICATION
        // 

        function generateEmailHash(sender, subject, body) {
            // Simple hash function (for production, use crypto.subtle.digest)
            const content = `${sender.toLowerCase()}|${subject.toLowerCase()}|${body.toLowerCase()}`;
            let hash = 0;
            for (let i = 0; i < content.length; i++) {
                const char = content.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return 'email_' + Math.abs(hash).toString(36);
        }

        function checkEmailCache(emailHash) {
            const cached = securityMetrics.cache.emailCache[emailHash];
            if (cached) {
                const cacheAge = Date.now() - cached.timestamp;
                const maxAge = 48 * 60 * 60 * 1000; // 48 hours

                if (cacheAge < maxAge) {
                    console.log(` Cache hit! Email analyzed ${Math.round(cacheAge / 60000)} minutes ago`);
                    return cached.result;
                } else {
                    // Expired - remove from cache
                    delete securityMetrics.cache.emailCache[emailHash];
                    saveSecurityMetrics();
                }
            }
            return null;
        }

        function cacheEmailResult(emailHash, result) {
            securityMetrics.cache.emailCache[emailHash] = {
                result: result,
                timestamp: Date.now()
            };

            // Limit cache size to 100 entries (remove oldest)
            const cacheEntries = Object.entries(securityMetrics.cache.emailCache);
            if (cacheEntries.length > 100) {
                cacheEntries.sort((a, b) => a[1].timestamp - b[1].timestamp);
                const toRemove = cacheEntries.slice(0, cacheEntries.length - 100);
                toRemove.forEach(([hash]) => delete securityMetrics.cache.emailCache[hash]);
            }

            saveSecurityMetrics();
        }

        function displayCachedResult(cachedResult, sender, subject, body, recipientEmail) {
            // If cached result doesn't have a breakdown, generate one based on the classification
            let confidenceBreakdown = cachedResult.confidenceBreakdown;
            if (!confidenceBreakdown || !confidenceBreakdown.channels) {
                console.log(' Cached result missing confidence breakdown, generating one...');
                confidenceBreakdown = generatePatternBasedConfidenceBreakdown(
                    {
                        classification: cachedResult.classification,
                        confidence: cachedResult.confidence,
                        reason: 'Cached result (reconstructed breakdown)'
                    },
                    sender,
                    subject,
                    body
                );
            }

            // Create a new result object with current timestamp but cached analysis
            const analysisResult = {
                id: Date.now(),
                sender: sender,
                subject: subject,
                body: body,
                recipientEmail: recipientEmail,
                recipientInfo: detectRecipientRole(recipientEmail),
                classification: cachedResult.classification,
                urgency: cachedResult.urgency,
                confidence: Math.min(100, cachedResult.confidence), // Cap at 100%
                comment: `[CACHED] ${cachedResult.comment}`,
                reasoningReport: cachedResult.reasoningReport,
                confidenceBreakdown: confidenceBreakdown,
                feedback: null,
                timestamp: new Date().toLocaleString(),
                agentActions: ['Used cached analysis result'],
                learningApplied: false,
                cached: true
            };

            analysisResults.unshift(analysisResult);

            // Auto-triage based on classification
            if (analysisResult.classification === 'Safe' && analysisResult.confidence >= 90) {
                console.log(' CACHED AUTO-TRIAGE: Safe email  Moving to History (auto_safe)');
                moveToHistory(analysisResult, 'auto_safe');
                updateSecurityMetrics('autoApproved');
            } else if (analysisResult.classification === 'Phishing' && analysisResult.confidence >= 90) {
                console.log(' CACHED AUTO-TRIAGE: Phishing email  Moving to History (auto_quarantine)');
                analysisResult.quarantined = true;
                analysisResult.quarantineReason = 'auto_quarantine';
                analysisResult.quarantineDate = new Date().toISOString();
                moveToHistory(analysisResult, 'auto_quarantine');
                updateSecurityMetrics('autoQuarantined');
            } else {
                console.log(' CACHED RESULT: Requires manual review  Staying in IT Review Queue');
                updateSecurityMetrics('manualReview');
            }

            saveAgentMemory();
            updateResultsDisplay();
            updateHistoryDisplay();
            updateAgentStatus();
            updateReviewDashboard();

            // Clear form
            document.getElementById('recipientEmail').value = '';
            document.getElementById('sender').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('body').value = '';
        }

        // 
        // 3. PRE-FILTERING (Pattern-Based Fast Path)
        // 

        function preFilterEmail(sender, subject, body) {
            const senderLower = sender.toLowerCase();
            const subjectLower = subject.toLowerCase();
            const bodyLower = body.toLowerCase();
            const combined = `${subjectLower} ${bodyLower}`;

            // Trusted internal domains (customize for your organization)
            const trustedDomains = [
                'hospital.org',
                'medicalcenter.com',
                'healthcare.net',
                'clinic.org'
            ];

            // Known safe patterns
            const safePatterns = [
                /meeting\s+(reminder|invitation|scheduled)/i,
                /appointment\s+(confirmation|reminder)/i,
                /newsletter/i,
                /unsubscribe/i
            ];

            // Obvious phishing patterns
            const phishingPatterns = [
                /urgent.*verify.*credentials?/i,
                /account.*suspended?.*click/i,
                /password.*expir(ed?|ing).*immediat/i,
                /click.*here.*verify/i,
                /confirm.*identity.*immediately/i,
                /unusual.*activity.*account/i,
                /suspended?.*account.*verify/i,
                /claim.*prize.*click/i,
                /wire.*transfer.*urgent/i,
                /social.*security.*suspended?/i
            ];

            // Check if from trusted domain
            const isTrustedDomain = trustedDomains.some(domain => senderLower.includes(domain));

            // Check safe patterns
            const hasSafePattern = safePatterns.some(pattern => pattern.test(combined));

            // Check phishing patterns
            const hasPhishingPattern = phishingPatterns.some(pattern => pattern.test(combined));

            // Confident SAFE decision
            if (isTrustedDomain && hasSafePattern && !hasPhishingPattern) {
                securityMetrics.preFilter.safePasses++;
                return {
                    confident: true,
                    classification: 'Safe',
                    confidence: 95,
                    urgency: 'Normal',
                    comment: 'Pre-filtered: Trusted domain with safe pattern detected. AI analysis skipped.',
                    reason: 'Trusted sender + safe patterns'
                };
            }

            // Confident PHISHING decision
            if (hasPhishingPattern && !isTrustedDomain) {
                securityMetrics.preFilter.phishingCaught++;
                return {
                    confident: true,
                    classification: 'Phishing',
                    confidence: 92,
                    urgency: 'Urgent',
                    comment: 'Pre-filtered: Known phishing patterns detected. AI analysis skipped.',
                    reason: 'Phishing patterns + untrusted sender'
                };
            }

            // Not confident - needs AI analysis
            return {
                confident: false,
                reason: 'Ambiguous - requires AI analysis'
            };
        }

        // Generate confidence breakdown for pattern-based (pre-filtered) emails
        function generatePatternBasedConfidenceBreakdown(preFilterResult, sender, subject, body) {
            const domain = sender.split('@')[1] || '';
            const isPhishing = preFilterResult.classification === 'Phishing';
            const isSafe = preFilterResult.classification === 'Safe';

            // Create channel breakdown for pattern-based analysis
            const breakdown = {
                channels: {
                    auth: {
                        score: isSafe ? 0.1 : 0.85,
                        quality: 0.8,
                        weight: 0.25,
                        vote: isSafe ? 'benign' : 'malicious',
                        evidence: isSafe ?
                            [`Trusted domain: ${domain}`] :
                            [`Suspicious/unknown domain: ${domain}`]
                    },
                    content: {
                        score: isPhishing ? 0.9 : 0.15,
                        quality: 1.0,
                        weight: 0.25,
                        vote: isPhishing ? 'malicious' : 'benign',
                        evidence: isPhishing ?
                            ['Known phishing patterns detected in subject/body'] :
                            ['Safe communication patterns detected']
                    },
                    url: {
                        score: isPhishing ? 0.75 : 0.2,
                        quality: 0.5,
                        weight: 0.20,
                        vote: isPhishing ? 'malicious' : 'benign',
                        evidence: isPhishing ?
                            ['Suspicious link patterns typical of phishing'] :
                            ['No suspicious link patterns detected']
                    },
                    attachment: {
                        score: 0.5,
                        quality: 0.0,
                        weight: 0.15,
                        vote: 'benign',
                        evidence: ['No attachment analysis in pre-filter']
                    },
                    context: {
                        score: isPhishing ? 0.8 : 0.1,
                        quality: 0.7,
                        weight: 0.15,
                        vote: isPhishing ? 'malicious' : 'benign',
                        evidence: isPhishing ?
                            ['Urgency language and pressure tactics detected'] :
                            ['Normal communication context']
                    }
                },
                riskRaw: preFilterResult.confidence / 100,
                decision: isPhishing ? 'malicious' : 'benign',
                autonomyBand: preFilterResult.confidence >= 90 ? 'High Autonomy' : 'Medium Autonomy',
                margin: Math.abs((preFilterResult.confidence / 100) - 0.5) * 2,
                agreement: 0.95, // High agreement in pattern matching
                completeness: 0.7, // Pattern matching has less data than AI
                uncertainty: 0.1
            };

            return breakdown;
        }

        function handlePreFilteredEmail(preFilterResult, sender, subject, body, recipientEmail) {
            // Generate confidence breakdown for pre-filtered emails
            const confidenceBreakdown = generatePatternBasedConfidenceBreakdown(
                preFilterResult, sender, subject, body
            );

            const analysisResult = {
                id: Date.now(),
                sender: sender,
                subject: subject,
                body: body,
                recipientEmail: recipientEmail,
                recipientInfo: detectRecipientRole(recipientEmail),
                classification: preFilterResult.classification,
                urgency: preFilterResult.urgency,
                confidence: Math.min(100, preFilterResult.confidence), // Cap at 100%
                comment: preFilterResult.comment,
                reasoningReport: {
                    summary: `Pre-filter analysis: ${preFilterResult.reason}`,
                    threatIndicators: preFilterResult.classification === 'Phishing' ?
                        ['Known phishing patterns detected'] : [],
                    roleAnalysis: 'Pattern-based analysis performed',
                    technicalFindings: ['Pre-filter analysis (no AI tokens used)'],
                    recommendation: preFilterResult.classification === 'Safe' ?
                        'Allow delivery' : 'Quarantine immediately'
                },
                confidenceBreakdown: confidenceBreakdown,
                feedback: null,
                timestamp: new Date().toLocaleString(),
                agentActions: ['Pre-filter pattern matching'],
                learningApplied: false,
                preFiltered: true
            };

            analysisResults.unshift(analysisResult);

            // Auto-triage based on pre-filter confidence
            if (analysisResult.classification === 'Safe' && analysisResult.confidence >= 90) {
                console.log(' PRE-FILTER AUTO-TRIAGE: Safe email  Moving to History (auto_safe)');
                moveToHistory(analysisResult, 'auto_safe');
                updateSecurityMetrics('autoApproved');
            } else if (analysisResult.classification === 'Phishing' && analysisResult.confidence >= 90) {
                console.log(' PRE-FILTER AUTO-TRIAGE: Phishing email  Moving to History (auto_quarantine)');
                analysisResult.quarantined = true;
                analysisResult.quarantineReason = 'auto_quarantine';
                analysisResult.quarantineDate = new Date().toISOString();
                moveToHistory(analysisResult, 'auto_quarantine');
                updateSecurityMetrics('autoQuarantined');
            } else {
                console.log(' PRE-FILTER RESULT: Requires manual review  Staying in IT Review Queue');
                updateSecurityMetrics('manualReview');
            }

            saveAgentMemory();
            updateResultsDisplay();
            updateHistoryDisplay();
            updateAgentStatus();
            updateReviewDashboard();

            // Clear form
            document.getElementById('recipientEmail').value = '';
            document.getElementById('sender').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('body').value = '';
        }

        // 
        // MONITORING DASHBOARD FUNCTIONS
        // 

        function updateMonitoringDisplay() {
            const now = Date.now();
            const oneHour = 60 * 60 * 1000;
            const oneMinute = 60 * 1000;

            // Rate Limiting Metrics
            const timestamps = securityMetrics.rateLimits.requestTimestamps || [];
            const requestsLastHour = timestamps.filter(ts => now - ts < oneHour).length;
            const requestsLastMinute = timestamps.filter(ts => now - ts < oneMinute).length;

            document.getElementById('total-requests').textContent = securityMetrics.monitoring.totalRequests;
            document.getElementById('blocked-requests').textContent = securityMetrics.rateLimits.totalBlocked;
            document.getElementById('requests-last-hour').textContent = requestsLastHour;
            document.getElementById('requests-last-minute').textContent = requestsLastMinute;

            // Cache Metrics
            const cacheHits = securityMetrics.cache.cacheHits || 0;
            const cacheMisses = securityMetrics.cache.cacheMisses || 0;
            const cacheTotal = cacheHits + cacheMisses;
            const hitRate = cacheTotal > 0 ? ((cacheHits / cacheTotal) * 100).toFixed(1) : 0;
            const cacheSize = Object.keys(securityMetrics.cache.emailCache || {}).length;

            document.getElementById('cache-hits').textContent = cacheHits;
            document.getElementById('cache-misses').textContent = cacheMisses;
            document.getElementById('cache-hit-rate').textContent = hitRate + '%';
            document.getElementById('cache-size').textContent = cacheSize;

            // Pre-Filter Metrics
            const prefiltered = securityMetrics.preFilter.totalPreFiltered || 0;
            const aiNeeded = securityMetrics.monitoring.totalRequests - prefiltered - cacheHits;

            document.getElementById('prefiltered-total').textContent = prefiltered;
            document.getElementById('prefiltered-safe').textContent = securityMetrics.preFilter.safePasses || 0;
            document.getElementById('prefiltered-phishing').textContent = securityMetrics.preFilter.phishingCaught || 0;
            document.getElementById('ai-analysis-needed').textContent = Math.max(0, aiNeeded);

            // Auto-Triage Metrics
            const autoApproved = securityMetrics.autoTriage.autoApproved || 0;
            const autoQuarantined = securityMetrics.autoTriage.autoQuarantined || 0;
            const manualReview = securityMetrics.autoTriage.manualReview || 0;
            const totalDecisions = autoApproved + autoQuarantined + manualReview;
            const workloadReduction = totalDecisions > 0 ?
                (((autoApproved + autoQuarantined) / totalDecisions) * 100).toFixed(1) : 0;

            document.getElementById('auto-approved').textContent = autoApproved;
            document.getElementById('auto-quarantined').textContent = autoQuarantined;
            document.getElementById('manual-review').textContent = manualReview;
            document.getElementById('workload-reduction').textContent = workloadReduction + '%';

            // Token Savings Metrics
            const aiCallsSaved = securityMetrics.monitoring.aiCallsSaved || 0;
            const tokensSaved = securityMetrics.monitoring.tokensSaved || 0;
            const costSavings = (tokensSaved / 1000 * 0.001).toFixed(2);
            const totalAICalls = (securityMetrics.monitoring.totalRequests - cacheHits - prefiltered);
            const efficiencyGain = securityMetrics.monitoring.totalRequests > 0 ?
                ((aiCallsSaved / securityMetrics.monitoring.totalRequests) * 100).toFixed(1) : 0;

            document.getElementById('ai-calls-saved').textContent = aiCallsSaved;
            document.getElementById('tokens-saved').textContent = tokensSaved.toLocaleString();
            document.getElementById('cost-savings').textContent = '$' + costSavings;
            document.getElementById('efficiency-gain').textContent = efficiencyGain + '%';

            // System Health Status
            updateHealthStatus('rate-limit-status', 'rate-limit-text',
                requestsLastMinute < 8 ? 'active' : requestsLastMinute < 10 ? 'warning' : 'error',
                requestsLastMinute < 10 ? 'Active' : 'Near Limit');

            updateHealthStatus('cache-status', 'cache-text',
                cacheSize < 90 ? 'active' : 'warning',
                cacheSize < 100 ? 'Operational' : 'Near Capacity');

            updateHealthStatus('prefilter-status', 'prefilter-text', 'active', 'Active');
            updateHealthStatus('autotriage-status', 'autotriage-text', 'active', 'Enabled');

            // Check for alerts
            if (requestsLastMinute >= 9) {
                showSecurityAlert('High request rate detected. Approaching per-minute limit.');
            } else if (securityMetrics.rateLimits.totalBlocked > 10) {
                showSecurityAlert(`${securityMetrics.rateLimits.totalBlocked} requests have been blocked by rate limiting.`);
            }
        }

        function updateHealthStatus(dotId, textId, status, text) {
            const dot = document.getElementById(dotId);
            const textEl = document.getElementById(textId);

            dot.className = 'status-dot';
            if (status === 'warning') dot.classList.add('warning');
            if (status === 'error') dot.classList.add('error');

            textEl.textContent = text;
        }

        function showSecurityAlert(message) {
            const banner = document.getElementById('security-alert-banner');
            const messageEl = document.getElementById('alert-message');

            messageEl.textContent = message;
            banner.style.display = 'block';

            // Auto-hide after 10 seconds
            setTimeout(() => {
                banner.style.display = 'none';
            }, 10000);
        }

        function resetSecurityMetrics() {
            if (confirm('Are you sure you want to reset all security metrics? This action cannot be undone.')) {
                securityMetrics = {
                    rateLimits: {
                        requestTimestamps: [],
                        totalBlocked: 0,
                        lastBlockedTime: null
                    },
                    cache: {
                        emailCache: {},
                        cacheHits: 0,
                        cacheMisses: 0
                    },
                    preFilter: {
                        totalPreFiltered: 0,
                        safePasses: 0,
                        phishingCaught: 0
                    },
                    autoTriage: {
                        autoApproved: 0,
                        autoQuarantined: 0,
                        manualReview: 0
                    },
                    monitoring: {
                        totalRequests: 0,
                        aiCallsSaved: 0,
                        tokensSaved: 0
                    }
                };

                saveSecurityMetrics();
                updateMonitoringDisplay();
                alert(' Security metrics have been reset.');
            }
        }

        function exportSecurityMetrics() {
            const data = {
                exportDate: new Date().toISOString(),
                metrics: securityMetrics,
                summary: {
                    totalRequests: securityMetrics.monitoring.totalRequests,
                    rateLimitBlocks: securityMetrics.rateLimits.totalBlocked,
                    cacheHitRate: securityMetrics.cache.cacheHits + securityMetrics.cache.cacheMisses > 0 ?
                        ((securityMetrics.cache.cacheHits / (securityMetrics.cache.cacheHits + securityMetrics.cache.cacheMisses)) * 100).toFixed(2) + '%' : '0%',
                    tokensSaved: securityMetrics.monitoring.tokensSaved,
                    estimatedCostSavings: '$' + (securityMetrics.monitoring.tokensSaved / 1000 * 0.001).toFixed(2),
                    workloadReduction: securityMetrics.autoTriage.autoApproved + securityMetrics.autoTriage.autoQuarantined + securityMetrics.autoTriage.manualReview > 0 ?
                        (((securityMetrics.autoTriage.autoApproved + securityMetrics.autoTriage.autoQuarantined) /
                        (securityMetrics.autoTriage.autoApproved + securityMetrics.autoTriage.autoQuarantined + securityMetrics.autoTriage.manualReview)) * 100).toFixed(2) + '%' : '0%'
                }
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `security-metrics-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            URL.revokeObjectURL(url);
            alert(' Security metrics exported successfully!');
        }

        // 
        // END OF MONITORING DASHBOARD FUNCTIONS
        // 

        // 
        // END OF PHASE 1 DEFENSE SYSTEMS
        // 

        async function analyzeEmail() {
            const sender = document.getElementById('sender').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('body').value.trim();
            const recipientEmail = document.getElementById('recipientEmail').value.trim();

            if (!openrouterApiKey) {
                alert('OpenRouter API key not configured. Please ensure OPENROUTER_API_KEY is set in environment variables.');
                return;
            }

            if (!sender || !subject || !body || !recipientEmail) {
                alert('Please fill in all fields: sender, recipient, subject, and email body.');
                return;
            }

            // PHASE 1 DEFENSE: Rate Limiting Check
            const rateLimitCheck = checkRateLimit();
            if (!rateLimitCheck.allowed) {
                alert(` Rate limit exceeded!\n\n${rateLimitCheck.message}\n\nPlease wait ${rateLimitCheck.waitTime} before trying again.`);
                updateSecurityMetrics('rateLimitTriggered');
                return;
            }

            // PHASE 1 DEFENSE: Email Deduplication
            const emailHash = generateEmailHash(sender, subject, body);
            const cachedResult = checkEmailCache(emailHash);
            if (cachedResult) {
                console.log(' Email found in cache - reusing previous analysis');
                console.log('   Classification:', cachedResult.classification, '| Confidence:', cachedResult.confidence + '%');
                displayCachedResult(cachedResult, sender, subject, body, recipientEmail);
                updateSecurityMetrics('cacheHit');
                return;
            }

            // PHASE 1 DEFENSE: Pre-filtering (Fast Path)
            const preFilterResult = preFilterEmail(sender, subject, body);
            if (preFilterResult.confident) {
                console.log(' Pre-filter confident result - skipping AI analysis');
                console.log('   Classification:', preFilterResult.classification, '| Confidence:', preFilterResult.confidence + '%');
                handlePreFilteredEmail(preFilterResult, sender, subject, body, recipientEmail);
                updateSecurityMetrics('preFiltered');
                return;
            }

            console.log(' No cache/pre-filter match - proceeding to full AI analysis');

            // Detect recipient role automatically (optional)
            const recipientInfo = detectRecipientRole(recipientEmail);
            const userRole = recipientInfo ? recipientInfo.role : 'healthcare worker'; // Default role if unknown

            const analyzeBtn = document.querySelector('.analyze-btn');
            const loading = document.getElementById('loading');

            analyzeBtn.disabled = true;
            loading.style.display = 'block';

            try {
                // Multi-step agentic analysis
                const result = await performAgenticAnalysis(openrouterApiKey, sender, subject, body, userRole);
                
                // Add to results array
                const analysisResult = {
                    id: Date.now(),
                    sender: sender,
                    subject: subject,
                    body: body,
                    recipientEmail: recipientEmail,
                    recipientInfo: recipientInfo,
                    classification: result.classification,
                    urgency: result.urgency,
                    confidence: Math.min(100, result.confidence), // Cap at 100%
                    comment: result.comment,
                    reasoningReport: result.reasoningReport || null,
                    confidenceBreakdown: result.confidenceBreakdown || null,
                    feedback: null,
                    timestamp: new Date().toLocaleString(),
                    agentActions: result.agentActions || [],
                    learningApplied: result.learningApplied || false,
                    threatIntel: result.threatIntel || null,
                    roleCheck: result.roleCheck || null,
                    userRole: result.userRole || userRole
                };
                
                analysisResults.unshift(analysisResult);

                // PHASE 1 DEFENSE: Cache the result for deduplication
                cacheEmailResult(emailHash, {
                    classification: result.classification,
                    urgency: result.urgency,
                    confidence: result.confidence,
                    comment: result.comment,
                    reasoningReport: result.reasoningReport,
                    confidenceBreakdown: result.confidenceBreakdown
                });

                // Update agent performance metrics
                agentMemory.performanceMetrics.totalAnalyzed++;

                // Track security metrics (avoid double counting)
                let threatBlocked = false;
                if (result.classification === 'Phishing') {
                    agentMemory.performanceMetrics.phishingCaught++;
                    threatBlocked = true;
                }
                if (result.threatIntel && result.threatIntel.threatLevel === 'HIGH') {
                    agentMemory.performanceMetrics.highThreatEmails++;
                    if (!threatBlocked) {
                        agentMemory.performanceMetrics.securityThreatsBlocked++;
                        threatBlocked = true;
                    }
                }
                // Only count securityThreatsBlocked if no other threat was already counted
                if (!threatBlocked && result.threatIntel && result.threatIntel.threatScore > 0) {
                    agentMemory.performanceMetrics.securityThreatsBlocked++;
                }

                // PHASE 1 DEFENSE: Auto-Triage System (High Confidence Decisions)
                console.log(' Email added to queue. ID:', analysisResult.id, 'Current analysisResults count:', analysisResults.length);

                // Auto-approve safe emails with high confidence
                if (result.classification === 'Safe' && result.confidence >= 90) {
                    console.log(' AI AUTO-TRIAGE: Safe email  Moving to History (auto_safe)');
                    moveToHistory(analysisResult, 'auto_safe');
                    updateSecurityMetrics('autoApproved');
                    console.log('   After moveToHistory: analysisResults:', analysisResults.length, 'historyResults:', historyResults.length);
                }
                // Auto-quarantine phishing emails with high confidence - Move to history immediately
                else if (result.classification === 'Phishing' && result.confidence >= 90) {
                    console.log(' AI AUTO-TRIAGE: Phishing email  Moving to History (auto_quarantine)');
                    analysisResult.quarantined = true;
                    analysisResult.quarantineReason = 'auto_quarantine';
                    analysisResult.quarantineDate = new Date().toISOString();
                    moveToHistory(analysisResult, 'auto_quarantine');
                    updateSecurityMetrics('autoQuarantined');
                    console.log('   After moveToHistory: analysisResults:', analysisResults.length, 'historyResults:', historyResults.length);
                }
                // Medium/low confidence or Suspicious classification -> manual IT review
                else {
                    console.log(' AI RESULT: ' + result.classification + ' (' + result.confidence + '%)  Staying in IT Review Queue');
                    console.log('   Email ID', analysisResult.id, 'should be in IT Review. Current analysisResults:', analysisResults.length);
                    updateSecurityMetrics('manualReview');
                }
                // Note: Suspicious emails always require manual review
                // This follows the "fail-safe default" principle - unsure? -> quarantine for review
                
                saveAgentMemory();

                // Update display with error handling
                try {
                    console.log(' Calling display updates...');
                    console.log('   Before display: analysisResults contains', analysisResults.length, 'items');
                    console.log('   Classifications in analysisResults:', analysisResults.map(r => `${r.id}:${r.classification}`));
                    updateResultsDisplay();
                    updateHistoryDisplay();
                    updateReviewDashboard(); // Explicitly update IT Review dashboard
                    updateAgentStatus();
                    console.log(' Display updates complete');
                } catch (displayError) {
                    console.log('Display update error (non-critical):', displayError);
                }
                
                // Save active results to persist review queue
                saveAgentMemory();
                
                // Clear form
                document.getElementById('recipientEmail').value = '';
                document.getElementById('sender').value = '';
                document.getElementById('subject').value = '';
                document.getElementById('body').value = '';
                document.getElementById('recipientInfo').style.display = 'none';

            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error analyzing email: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 
        // CHANNEL-BASED CONFIDENCE SCORING SYSTEM
        // Multi-signal evidence aggregation with quality tracking and uncertainty quantification
        // 

        function calculateMultiFactorConfidence(aiConfidence, classification, patternMatch, threatIntel, roleCheck, sender, subject, body) {
            console.log(' Calculating channel-based confidence with quality tracking...');

            // Initialize breakdown object for transparency
            const breakdown = {
                channels: {},
                quality: {},
                votes: {},
                adjustments: []
            };

            // 
            // CHANNEL 1: AUTH/SENDER (Weight: 0.25)
            // 
            let authScore = 0;
            let authQuality = 1.0;
            const authEvidence = [];

            const domain = sender.split('@')[1] || '';

            // Domain reputation checks
            const suspiciousDomains = ['medical-alert.net', 'hospital-security.com', 'healthcare-emergency.net'];
            const trustedDomains = ['generalhospital.org', 'hospital.org', 'clinic.org', 'medical.org', '.gov', '.edu'];

            if (suspiciousDomains.includes(domain.toLowerCase())) {
                authScore += 0.40;
                authEvidence.push('Suspicious domain');
            }

            if (trustedDomains.some(td => domain.toLowerCase().includes(td))) {
                authScore -= 0.20;
                authEvidence.push('Trusted domain');
            }

            // Spoofing detection
            const senderLower = sender.toLowerCase();
            const personalEmailDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com'];
            if (personalEmailDomains.some(pd => senderLower.includes(pd)) &&
                (subject.toLowerCase().includes('hospital') || subject.toLowerCase().includes('medical'))) {
                authScore += 0.25;
                authEvidence.push('Personal email claiming institution');
            }

            // Domain age simulation (would need real API)
            // For now, check for suspicious patterns
            const lookalikeDomains = /h0spital|hospita1|medica1|c1inic/i;
            if (lookalikeDomains.test(domain)) {
                authScore += 0.20;
                authEvidence.push('Lookalike domain detected');
            }

            // Cap auth score at 1.0
            authScore = Math.min(1.0, Math.max(0, authScore));

            breakdown.channels.auth = {
                score: authScore,
                quality: authQuality,
                evidence: authEvidence,
                weight: 0.25
            };
            breakdown.votes.auth = authScore >= 0.5 ? 'malicious' : 'benign';

            console.log(' [AUTH CHANNEL] Complete:');
            console.log('   Score:', (authScore * 100).toFixed(1) + '%');
            console.log('   Quality:', (authQuality * 100).toFixed(0) + '%');
            console.log('   Evidence:', authEvidence.length > 0 ? authEvidence : 'No risk indicators found');
            console.log('   Vote:', breakdown.votes.auth);

            // 
            // CHANNEL 2: CONTENT/LANGUAGE (Weight: 0.25)
            // 
            let contentScore = 0;
            let contentQuality = 1.0;
            const contentEvidence = [];

            const bodyLower = body.toLowerCase();
            const subjectLower = subject.toLowerCase();
            const combined = `${subjectLower} ${bodyLower}`;

            // Credential harvest phrases
            const credentialPhrases = ['verify your account', 'verify account', 'password reset', 'password expired', 'confirm identity', 'update credentials', 'suspended account', 'account suspended', 'account locked', 'verify now', 'suspended', 'violation'];
            const credentialHits = credentialPhrases.filter(phrase => combined.includes(phrase));
            if (credentialHits.length > 0) {
                contentScore += 0.20 * Math.min(credentialHits.length, 2); // Up to 0.40 for credential harvesting
                contentEvidence.push(`Credential harvest: ${credentialHits.join(', ')}`);
            }

            // Urgency/pressure
            const urgencyTerms = ['urgent', 'immediately', 'asap', 'right now', 'within 24 hours', 'expires', 'deadline', 'action required', 'respond now'];
            const urgencyHits = urgencyTerms.filter(term => combined.includes(term));
            if (urgencyHits.length > 0) {
                contentScore += 0.15 * Math.min(urgencyHits.length, 3); // Up to 0.45 for multiple urgency terms
                contentEvidence.push(`Urgency pressure: ${urgencyHits.length} terms (${urgencyHits.join(', ')})`);
            }

            // Security scare tactics
            const securityScareTerms = ['compromise', 'breach', 'hacked', 'unauthorized access', 'security alert', 'account locked', 'unusual activity'];
            const securityScareHits = securityScareTerms.filter(term => combined.includes(term));
            if (securityScareHits.length > 0) {
                contentScore += 0.25;
                contentEvidence.push(`Security scare tactics: ${securityScareHits.join(', ')}`);
            }

            // Action pressure (click here, click link, etc.)
            const actionPressureTerms = ['click here', 'click link', 'click below', 'click this', 'tap here', 'follow this link'];
            const actionPressureHits = actionPressureTerms.filter(phrase => combined.includes(phrase));
            if (actionPressureHits.length > 0) {
                contentScore += 0.20;
                contentEvidence.push(`Action pressure: ${actionPressureHits.join(', ')}`);
            }

            // Finance theme from unknown sender
            const financeTerms = ['invoice', 'payment', 'wire transfer', 'account number', 'payroll'];
            const financeHits = financeTerms.filter(term => combined.includes(term));
            if (financeHits.length > 0 && !trustedDomains.some(td => domain.toLowerCase().includes(td))) {
                contentScore += 0.15;
                contentEvidence.push(`Finance theme from external: ${financeHits.join(', ')}`);
            }

            // Homoglyphs/misspellings (basic check)
            const suspiciousChars = /[0]/; // 0 vs O variations
            if (suspiciousChars.test(body) || suspiciousChars.test(subject)) {
                contentScore += 0.05;
                contentEvidence.push('Homoglyph characters detected');
            }

            contentScore = Math.min(1.0, Math.max(0, contentScore));

            breakdown.channels.content = {
                score: contentScore,
                quality: contentQuality,
                evidence: contentEvidence,
                weight: 0.25
            };
            breakdown.votes.content = contentScore >= 0.5 ? 'malicious' : 'benign';

            console.log(' [CONTENT CHANNEL] Complete:');
            console.log('   Score:', (contentScore * 100).toFixed(1) + '%');
            console.log('   Quality:', (contentQuality * 100).toFixed(0) + '%');
            console.log('   Evidence:', contentEvidence.length > 0 ? contentEvidence : 'No risk indicators found');
            console.log('   Vote:', breakdown.votes.content);

            // 
            // CHANNEL 3: URL/LINKS (Weight: 0.20)
            // 
            let urlScore = 0;
            let urlQuality = 0.9; // Slightly lower since we can't fetch all URLs
            const urlEvidence = [];

            const links = body.match(/(https?:\/\/[^\s]+)/gi) || [];

            if (links.length > 0) {
                // URL shorteners
                const shorteners = ['bit.ly', 'tinyurl', 't.co', 'goo.gl'];
                const hasShortener = links.some(link => shorteners.some(s => link.includes(s)));
                if (hasShortener) {
                    urlScore += 0.05;
                    urlEvidence.push('URL shortener detected');
                }

                // Lookalike domains in links
                const suspiciousLinkPatterns = /h0spital|hospita1|medica1|paypa1|g00gle/i;
                if (links.some(link => suspiciousLinkPatterns.test(link))) {
                    urlScore += 0.30;
                    urlEvidence.push('Lookalike domain in link');
                }

                // Multiple redirects (check for redirect terms)
                if (body.includes('redirect') || body.includes('forwarding')) {
                    urlScore += 0.10;
                    urlEvidence.push('Possible redirects');
                }
            } else {
                urlQuality = 0.5; // Lower quality if no URLs to check
            }

            // Check for login form indicators
            if (combined.includes('login') || combined.includes('sign in') || combined.includes('enter your password')) {
                urlScore += 0.20;
                urlEvidence.push('Login/credential request');
            }

            urlScore = Math.min(1.0, Math.max(0, urlScore));

            breakdown.channels.url = {
                score: urlScore,
                quality: urlQuality,
                evidence: urlEvidence,
                weight: 0.20
            };
            breakdown.votes.url = urlScore >= 0.5 ? 'malicious' : 'benign';

            console.log(' [URL CHANNEL] Complete:');
            console.log('   Links found:', links.length);
            console.log('   Score:', (urlScore * 100).toFixed(1) + '%');
            console.log('   Quality:', (urlQuality * 100).toFixed(0) + '%');
            console.log('   Evidence:', urlEvidence.length > 0 ? urlEvidence : 'No risk indicators found');
            console.log('   Vote:', breakdown.votes.url);

            // 
            // CHANNEL 4: ATTACHMENT (Weight: 0.15)
            // 
            let attachmentScore = 0;
            let attachmentQuality = 0.7; // Simulated, would be higher with real attachment analysis
            const attachmentEvidence = [];

            // Look for attachment mentions
            const attachmentKeywords = ['attachment', 'attached', 'document', 'file'];
            const hasAttachmentMention = attachmentKeywords.some(kw => bodyLower.includes(kw));

            if (hasAttachmentMention) {
                // Executable/script indicators
                const dangerousTypes = ['.exe', '.vbs', '.js', '.bat', '.cmd', '.scr', '.com'];
                if (dangerousTypes.some(ext => bodyLower.includes(ext))) {
                    attachmentScore += 0.35;
                    attachmentEvidence.push('Executable file type mentioned');
                }

                // Macro/OLE
                if (bodyLower.includes('macro') || bodyLower.includes('enable content') || bodyLower.includes('enable editing')) {
                    attachmentScore += 0.25;
                    attachmentEvidence.push('Macro-enabled document');
                }

                // Password-protected
                if (bodyLower.includes('password') && hasAttachmentMention) {
                    attachmentScore += 0.15;
                    attachmentEvidence.push('Password-protected attachment');
                }
            } else {
                attachmentQuality = 0.5; // Lower quality if no attachments
            }

            attachmentScore = Math.min(1.0, Math.max(0, attachmentScore));

            breakdown.channels.attachment = {
                score: attachmentScore,
                quality: attachmentQuality,
                evidence: attachmentEvidence,
                weight: 0.15
            };
            breakdown.votes.attachment = attachmentScore >= 0.5 ? 'malicious' : 'benign';

            console.log(' [ATTACHMENT CHANNEL] Complete:');
            console.log('   Attachment mentioned:', hasAttachmentMention);
            console.log('   Score:', (attachmentScore * 100).toFixed(1) + '%');
            console.log('   Quality:', (attachmentQuality * 100).toFixed(0) + '%');
            console.log('   Evidence:', attachmentEvidence.length > 0 ? attachmentEvidence : 'No risk indicators found');
            console.log('   Vote:', breakdown.votes.attachment);

            // 
            // CHANNEL 5: CONTEXT (Weight: 0.15)
            // 
            let contextScore = 0;
            let contextQuality = 1.0;
            const contextEvidence = [];

            // Role alignment
            if (roleCheck) {
                if (roleCheck.roleMismatch) {
                    contextScore += 0.15;
                    contextEvidence.push('Role mismatch: ' + roleCheck.reason);
                } else if (roleCheck.aligned) {
                    contextScore -= 0.10;
                    contextEvidence.push('Role aligned');
                }
            }

            // Pattern matching (historical learning)
            if (patternMatch && patternMatch.found) {
                if (patternMatch.pattern.type === 'phishing') {
                    contextScore += 0.25;
                    contextEvidence.push('Known phishing pattern match');
                } else if (patternMatch.pattern.type === 'safe') {
                    contextScore -= 0.25;
                    contextEvidence.push('Known safe pattern match');
                }
            }

            // Known vendor check (from threat intel)
            if (threatIntel && threatIntel.isTrustedDomain) {
                contextScore -= 0.25;
                contextEvidence.push('Known trusted vendor');
            }

            // Thread continuity would go here (not implemented)

            contextScore = Math.min(1.0, Math.max(0, contextScore));

            breakdown.channels.context = {
                score: contextScore,
                quality: contextQuality,
                evidence: contextEvidence,
                weight: 0.15
            };
            breakdown.votes.context = contextScore >= 0.5 ? 'malicious' : 'benign';

            console.log(' [CONTEXT CHANNEL] Complete:');
            console.log('   Score:', (contextScore * 100).toFixed(1) + '%');
            console.log('   Quality:', (contextQuality * 100).toFixed(0) + '%');
            console.log('   Evidence:', contextEvidence.length > 0 ? contextEvidence : 'No risk indicators found');
            console.log('   Vote:', breakdown.votes.context);

            // 
            // AGGREGATE TO RAW RISK SCORE
            // 

            const weights = {
                auth: 0.25,
                content: 0.25,
                url: 0.20,
                attachment: 0.15,
                context: 0.15
            };

            // Quality-weighted aggregation
            let numerator = 0;
            let denominator = 0;

            for (const [channel, weight] of Object.entries(weights)) {
                const channelData = breakdown.channels[channel];
                numerator += weight * channelData.quality * channelData.score;
                denominator += weight * channelData.quality;
            }

            let riskRaw = denominator > 0 ? numerator / denominator : 0.5;

            // Evidence completeness
            const completeness = denominator / 1.0; // Total weight is 1.0
            breakdown.completeness = completeness;

            // Only cap risk if completeness is VERY low (<40%) AND predicting malicious
            // Don't penalize safe emails that naturally lack suspicious indicators
            const predictedMaliciousPreCap = riskRaw >= 0.5;
            if (completeness < 0.4 && predictedMaliciousPreCap && riskRaw > 0.75) {
                riskRaw = Math.min(riskRaw, 0.75);
                breakdown.adjustments.push({
                    reason: `Very low evidence completeness (${(completeness * 100).toFixed(0)}%)`,
                    adjustment: 'cap risk at 75%'
                });
            }

            // 
            // AGREEMENT & UNCERTAINTY
            // 

            const votes = Object.values(breakdown.votes);
            const maliciousVotes = votes.filter(v => v === 'malicious').length;
            const benignVotes = votes.filter(v => v === 'benign').length;
            const totalVotes = votes.length;

            console.log('\n  [VOTING] Channel agreement analysis:');
            console.log('   Malicious votes:', maliciousVotes + '/' + totalVotes);
            console.log('   Benign votes:', benignVotes + '/' + totalVotes);

            // Agreement (1 = unanimous, 0 = split)
            const pMalicious = maliciousVotes / totalVotes;
            const pBenign = benignVotes / totalVotes;
            const entropy = -(pMalicious * Math.log2(pMalicious || 1) + pBenign * Math.log2(pBenign || 1));
            const agreement = 1 - (entropy / Math.log2(2)); // Normalize to [0,1]
            breakdown.agreement = agreement;

            // Uncertainty: average quality gap + contradictions
            const avgQuality = Object.values(breakdown.channels).reduce((sum, ch) => sum + ch.quality, 0) / 5;
            let uncertainty = (1 - avgQuality);

            // Detect contradictions
            if (breakdown.channels.auth.score < 0.3 && breakdown.channels.content.score > 0.7) {
                uncertainty += 0.1;
                breakdown.adjustments.push({ reason: 'Contradiction: trusted sender with malicious content', adjustment: '+10% uncertainty' });
            }

            uncertainty = Math.min(1.0, uncertainty);
            breakdown.uncertainty = uncertainty;

            // 
            // MARGIN-BASED CONFIDENCE
            // 

            const threshold = 0.5;
            const margin = Math.abs(riskRaw - threshold);
            breakdown.margin = margin;

            // Determine action and chosen probability
            const predictedMalicious = riskRaw >= threshold;
            const chosenProbability = predictedMalicious ? riskRaw : (1 - riskRaw);

            // Final confidence formula
            let confidence = (0.55 * chosenProbability) +
                           (0.20 * margin) +
                           (0.15 * agreement) +
                           (0.10 * completeness) -
                           (0.10 * uncertainty);

            // Convert to percentage
            confidence = confidence * 100;

            // Debug logging for confidence calculation
            console.log(' Pre-cap confidence calculation:');
            console.log('   Risk Raw:', (riskRaw * 100).toFixed(1) + '%', predictedMalicious ? '(Malicious)' : '(Benign)');
            console.log('   Chosen Probability:', (chosenProbability * 100).toFixed(1) + '%');
            console.log('   Margin:', (margin * 100).toFixed(1) + '%');
            console.log('   Agreement:', (agreement * 100).toFixed(0) + '%');
            console.log('   Completeness:', (completeness * 100).toFixed(0) + '%');
            console.log('   Uncertainty:', (uncertainty * 100).toFixed(0) + '%');
            console.log('   Calculated confidence (before caps):', confidence.toFixed(1) + '%');

            // 
            // CONTEXT-SPECIFIC CAPS
            // 

            // VIP target cap (if we had VIP data)
            // For now, check if recipient has 'director' or 'admin' in role
            const isVIP = roleCheck && (roleCheck.role || '').toLowerCase().match(/director|admin|chief|executive/);
            if (isVIP && !(trustedDomains.some(td => domain.toLowerCase().includes(td)))) {
                confidence = Math.min(confidence, 79);
                breakdown.adjustments.push({ reason: 'VIP recipient (not whitelisted)', adjustment: 'cap at 79%' });
            }

            // Key evidence missing cap - only apply if predicting malicious AND missing evidence
            // Don't cap safe emails just because they lack URLs/attachments
            if (predictedMalicious && urlQuality < 0.6 && attachmentQuality < 0.6 && confidence > 75) {
                confidence = Math.min(confidence, 75);
                breakdown.adjustments.push({ reason: 'Key evidence missing (URL & attachment analysis)', adjustment: 'cap at 75%' });
            }

            // First-time sender cap - only for high-confidence malicious predictions
            // Safe emails from new senders shouldn't be heavily penalized
            if ((!patternMatch || !patternMatch.found) && predictedMalicious && confidence > 85) {
                confidence = Math.min(confidence, 85);
                breakdown.adjustments.push({ reason: 'First-time sender (no historical pattern)', adjustment: 'cap at 85%' });
            }

            // 
            // FINALIZE
            // 

            confidence = Math.min(100, Math.max(0, confidence));
            breakdown.riskRaw = riskRaw;
            breakdown.finalConfidence = confidence;
            breakdown.decision = predictedMalicious ? 'HOLD' : 'RELEASE';
            breakdown.autonomyBand = confidence >= 80 ? 'HIGH' : confidence >= 60 ? 'MEDIUM' : 'LOW';

            console.log(' Channel-based confidence calculated:', confidence.toFixed(1) + '%',
                       'Risk:', (riskRaw * 100).toFixed(1) + '%',
                       'Agreement:', (agreement * 100).toFixed(0) + '%',
                       'Completeness:', (completeness * 100).toFixed(0) + '%');
            console.log('   Quality values - URL:', urlQuality, 'Attachment:', attachmentQuality);
            console.log('   Adjustments applied:', breakdown.adjustments.map(a => a.adjustment).join(', ') || 'None');

            return {
                finalConfidence: Math.round(confidence * 10) / 10,
                breakdown: breakdown,
                uncertainty: {
                    level: uncertainty > 0.3 ? 'high' : uncertainty > 0.15 ? 'medium' : 'low',
                    score: Math.round(uncertainty * 100),
                    description: `Agreement: ${(agreement * 100).toFixed(0)}%, Completeness: ${(completeness * 100).toFixed(0)}%`
                }
            };
        }

        // Get historical accuracy for a classification type
        function getHistoricalAccuracy(classification) {
            const history = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
            const classificationHistory = history.filter(h =>
                h.classification === classification && h.feedback
            );

            if (classificationHistory.length === 0) {
                return null;
            }

            const correct = classificationHistory.filter(h => h.feedback === 'correct').length;
            const accuracy = (correct / classificationHistory.length) * 100;

            return {
                accuracy: accuracy,
                sampleSize: classificationHistory.length
            };
        }

        // Get confidence calibration adjustment
        function getConfidenceCalibration(classification, currentConfidence) {
            const historicalAccuracy = getHistoricalAccuracy(classification);

            if (!historicalAccuracy || historicalAccuracy.sampleSize < 5) {
                return { adjustment: 0, reason: 'Insufficient historical data' };
            }

            // If historical accuracy is much lower than current confidence, reduce confidence
            const accuracyGap = currentConfidence - historicalAccuracy.accuracy;

            if (accuracyGap > 20) {
                // Overconfident - reduce by 10%
                return {
                    adjustment: -10,
                    reason: `Historical accuracy (${Math.round(historicalAccuracy.accuracy)}%) is much lower than current confidence`,
                    historicalAccuracy: historicalAccuracy.accuracy
                };
            } else if (accuracyGap > 10) {
                // Slightly overconfident - reduce by 5%
                return {
                    adjustment: -5,
                    reason: `Historical accuracy (${Math.round(historicalAccuracy.accuracy)}%) is lower than current confidence`,
                    historicalAccuracy: historicalAccuracy.accuracy
                };
            } else if (accuracyGap < -10) {
                // Underconfident - increase by 5%
                return {
                    adjustment: +5,
                    reason: `Historical accuracy (${Math.round(historicalAccuracy.accuracy)}%) is higher than current confidence`,
                    historicalAccuracy: historicalAccuracy.accuracy
                };
            }

            return { adjustment: 0, reason: 'Confidence well-calibrated', historicalAccuracy: historicalAccuracy.accuracy };
        }

        // Multi-step agentic analysis with learning and autonomous actions
        async function performAgenticAnalysis(apiKey, sender, subject, body, userRole) {
            console.log(' Agent starting multi-step analysis...');
            
            // Step 1: Role-based Context Check
            const roleCheck = checkRoleAlignment(userRole, sender, subject, body);
            console.log(' Role alignment result:', roleCheck);
            
            // Step 2: Pattern Recognition - Check learned patterns
            const patternMatch = checkLearnedPatterns(sender, subject, body);
            console.log(' Pattern recognition result:', patternMatch);
            
            // Step 3: Threat Intelligence Check
            const threatIntel = await checkThreatIntelligence(sender, subject, body);
            console.log(' Threat intelligence result:', threatIntel);
            
            // Step 4: AI Analysis with context
            const aiResult = await analyzeWithAI(apiKey, sender, subject, body, patternMatch, threatIntel, roleCheck, userRole, recipientInfo);
            console.log(' AI analysis result:', aiResult);
            
            // Step 5: Autonomous Decision Making
            const agentActions = determineAutonomousActions(aiResult, patternMatch, threatIntel, roleCheck);
            console.log(' Autonomous actions:', agentActions);
            
            // Step 5: Apply Learning Context
            const learningApplied = applyLearnedContext(aiResult, patternMatch);

            // Step 6: Calculate Multi-Factor Confidence
            const confidenceResult = calculateMultiFactorConfidence(
                aiResult.confidence,
                aiResult.classification,
                patternMatch,
                threatIntel,
                roleCheck,
                sender,
                subject,
                body
            );
            console.log(' Multi-factor confidence:', confidenceResult);

            return {
                ...aiResult,
                confidence: confidenceResult.finalConfidence,
                confidenceBreakdown: confidenceResult.breakdown,
                uncertainty: confidenceResult.uncertainty,
                agentActions,
                learningApplied,
                patternMatch,
                threatIntel,
                roleCheck,
                userRole
            };
        }

        // Check learned patterns from previous feedback
        function checkLearnedPatterns(sender, subject, body) {
            const emailHash = generateEmailHash(sender, subject, body);
            
            // Check for exact matches
            if (agentMemory.learnedPatterns[emailHash]) {
                return {
                    type: 'exact_match',
                    confidence: 95,
                    classification: agentMemory.learnedPatterns[emailHash].classification,
                    reason: 'Previously analyzed email'
                };
            }
            
            // Check for sender patterns
            const senderPattern = agentMemory.learnedPatterns[`sender:${sender}`];
            if (senderPattern && senderPattern.count > 2) {
                return {
                    type: 'sender_pattern',
                    confidence: Math.min(85, 60 + (senderPattern.count * 5)),
                    classification: senderPattern.classification,
                    reason: `Known ${senderPattern.classification.toLowerCase()} sender (${senderPattern.count} instances)`
                };
            }
            
            // Check for subject patterns
            const subjectKeywords = extractKeywords(subject);
            for (const keyword of subjectKeywords) {
                const keywordPattern = agentMemory.learnedPatterns[`keyword:${keyword}`];
                if (keywordPattern && keywordPattern.count > 1) {
                    return {
                        type: 'keyword_pattern',
                        confidence: Math.min(75, 50 + (keywordPattern.count * 10)),
                        classification: keywordPattern.classification,
                        reason: `Known ${keywordPattern.classification.toLowerCase()} keyword pattern`
                    };
                }
            }
            
            return null;
        }

        // Role-based context validation
        function checkRoleAlignment(userRole, sender, subject, body) {
            const rolePatterns = {
                'nurse': {
                    expected: ['patient', 'medication', 'schedule', 'shift', 'care plan', 'nursing', 'treatment', 'vital signs'],
                    suspicious: ['financial', 'billing', 'payroll', 'hr policy', 'employee benefits', 'maintenance request'],
                    highRisk: ['presurgery information', 'surgical procedure', 'anesthesia protocol']
                },
                'doctor': {
                    expected: ['patient', 'diagnosis', 'treatment', 'medical record', 'consultation', 'surgery', 'prescription', 'clinical'],
                    suspicious: ['maintenance', 'janitorial', 'facilities', 'parking', 'cafeteria'],
                    highRisk: ['billing dispute', 'insurance claim', 'employee termination']
                },
                'admin': {
                    expected: ['policy', 'meeting', 'schedule', 'announcement', 'form', 'procedure', 'administrative'],
                    suspicious: ['patient diagnosis', 'medical procedure', 'surgery details', 'medication dosage'],
                    highRisk: ['clinical protocol', 'patient treatment plan', 'medical emergency']
                },
                'it': {
                    expected: ['system', 'network', 'software', 'security', 'update', 'maintenance', 'backup', 'technical'],
                    suspicious: ['patient care', 'medical diagnosis', 'nursing shift', 'surgery schedule'],
                    highRisk: ['clinical decision', 'patient treatment', 'medical emergency']
                },
                'janitor': {
                    expected: ['cleaning', 'maintenance', 'supplies', 'schedule', 'safety', 'facilities', 'equipment'],
                    suspicious: ['patient information', 'medical record', 'treatment plan', 'diagnosis'],
                    highRisk: ['presurgery information', 'patient data', 'medical records', 'clinical protocol', 'surgery details']
                },
                'security': {
                    expected: ['incident', 'safety', 'access', 'patrol', 'emergency', 'visitor', 'security protocol'],
                    suspicious: ['patient treatment', 'medical procedure', 'clinical decision', 'medication'],
                    highRisk: ['patient diagnosis', 'surgery details', 'medical records']
                },
                'billing': {
                    expected: ['invoice', 'payment', 'insurance', 'claim', 'billing', 'financial', 'account'],
                    suspicious: ['clinical protocol', 'patient care', 'medical treatment', 'nursing'],
                    highRisk: ['patient diagnosis', 'medical procedure', 'treatment plan']
                },
                'pharmacy': {
                    expected: ['medication', 'prescription', 'drug', 'pharmacy', 'dosage', 'pharmaceutical'],
                    suspicious: ['maintenance', 'facilities', 'security incident', 'administrative policy'],
                    highRisk: ['surgery details', 'non-medication medical procedures']
                },
                'lab': {
                    expected: ['lab result', 'test', 'specimen', 'analysis', 'laboratory', 'sample'],
                    suspicious: ['billing', 'administrative', 'maintenance', 'security'],
                    highRisk: ['surgery details', 'treatment planning', 'non-diagnostic procedures']
                },
                'radiology': {
                    expected: ['imaging', 'scan', 'x-ray', 'mri', 'ct', 'radiology', 'image'],
                    suspicious: ['billing dispute', 'maintenance', 'administrative', 'security'],
                    highRisk: ['non-imaging medical procedures', 'surgery details']
                }
            };

            const roleConfig = rolePatterns[userRole];
            if (!roleConfig) {
                return null;
            }

            const emailText = `${subject} ${body}`.toLowerCase();
            
            // Check for high-risk content (strong role mismatch)
            const highRiskMatches = roleConfig.highRisk.filter(keyword => 
                emailText.includes(keyword.toLowerCase())
            );
            
            if (highRiskMatches.length > 0) {
                return {
                    type: 'role_mismatch',
                    severity: 'high',
                    confidence: 85,
                    reason: `High-risk content for ${userRole}: Contains "${highRiskMatches.join(', ')}" which is inappropriate for this role`,
                    classification: 'Suspicious',
                    roleMismatch: true,
                    matchedKeywords: highRiskMatches
                };
            }

            // Check for suspicious content (moderate role mismatch)
            const suspiciousMatches = roleConfig.suspicious.filter(keyword => 
                emailText.includes(keyword.toLowerCase())
            );
            
            if (suspiciousMatches.length > 1) {
                return {
                    type: 'role_mismatch',
                    severity: 'moderate',
                    confidence: 65,
                    reason: `Content may be inappropriate for ${userRole}: Contains "${suspiciousMatches.join(', ')}"`,
                    classification: 'Suspicious',
                    roleMismatch: true,
                    matchedKeywords: suspiciousMatches
                };
            }

            // Check for expected content (role alignment)
            const expectedMatches = roleConfig.expected.filter(keyword => 
                emailText.includes(keyword.toLowerCase())
            );
            
            if (expectedMatches.length > 0) {
                return {
                    type: 'role_alignment',
                    severity: 'good',
                    confidence: 75,
                    reason: `Content appropriate for ${userRole}: Contains expected keywords "${expectedMatches.join(', ')}"`,
                    classification: null, // Don't override classification for good alignment
                    roleMismatch: false,
                    matchedKeywords: expectedMatches
                };
            }
            
            return null;
        }

        // Enhanced threat intelligence check with security analysis
        async function checkThreatIntelligence(sender, subject, body) {
            const domain = sender.split('@')[1];
            
            // 1. Domain Analysis
            const suspiciousDomains = ['medical-alert.net', 'hospital-security.com', 'healthcare-emergency.net', 'medicare-updates.org'];
            const isSuspiciousDomain = suspiciousDomains.includes(domain);
            
            // 2. Link Analysis (simulated)
            const links = extractLinks(body);
            const suspiciousLinks = links.filter(link => {
                return link.includes('h0spital') || // Lookalike domains
                       link.includes('hospita1') ||
                       link.includes('medica1') ||
                       link.includes('bit.ly') || // Shortened URLs
                       link.includes('tinyurl');
            });
            
            // 3. Header Analysis (simulated)
            const headerAnalysis = analyzeHeaders(sender, subject);
            
            // 4. Content Analysis
            const bodyLower = body.toLowerCase();
            const phishingKeywords = ['urgent', 'immediately', 'click here', 'verify', 'suspended', 'violation', 'compromise', 'breach'];
            const phishingScore = phishingKeywords.filter(keyword => bodyLower.includes(keyword)).length;
            
            // 5. MIME/Attachment Analysis (simulated)
            const attachmentAnalysis = analyzeAttachments(body);
            
            // 6. Threat Level Calculation
            let threatScore = 0;
            if (isSuspiciousDomain) threatScore += 40;
            if (suspiciousLinks.length > 0) threatScore += 30;
            if (headerAnalysis.spoofing) threatScore += 25;
            if (phishingScore > 2) threatScore += 20;
            if (attachmentAnalysis.suspicious) threatScore += 15;
            
            const threatLevel = threatScore >= 70 ? 'HIGH' : threatScore >= 40 ? 'MEDIUM' : 'LOW';
            
            return {
                suspiciousDomain: isSuspiciousDomain,
                phishingScore,
                suspiciousLinks: suspiciousLinks.length,
                headerIssues: headerAnalysis.issues,
                attachmentIssues: attachmentAnalysis.issues,
                threatScore,
                threatLevel,
                confidence: threatScore + 10
            };
        }

        // Extract links from email body
        function extractLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.match(urlRegex) || [];
        }

        // Analyze email headers for spoofing
        function analyzeHeaders(sender, subject) {
            const issues = [];
            let spoofing = false;
            
            // Check for suspicious sender patterns
            if (sender.includes('noreply') && subject.toLowerCase().includes('urgent')) {
                issues.push('Urgent subject from noreply sender');
                spoofing = true;
            }
            
            // Check for suspicious domains
            const suspiciousPatterns = ['@gmail.com', '@yahoo.com', '@hotmail.com'];
            if (suspiciousPatterns.some(pattern => sender.includes(pattern)) && subject.toLowerCase().includes('hospital')) {
                issues.push('Personal email claiming to be from hospital');
                spoofing = true;
            }
            
            return { issues, spoofing };
        }

        // Analyze attachments (simulated)
        function analyzeAttachments(text) {
            const issues = [];
            let suspicious = false;
            
            // Look for attachment mentions
            const attachmentKeywords = ['attachment', 'document', 'file', '.exe', '.zip', '.pdf'];
            const hasAttachments = attachmentKeywords.some(keyword => text.toLowerCase().includes(keyword));
            
            if (hasAttachments && text.toLowerCase().includes('password')) {
                issues.push('Password-protected attachment');
                suspicious = true;
            }
            
            if (text.toLowerCase().includes('macro') || text.toLowerCase().includes('enable content')) {
                issues.push('Macro-enabled document');
                suspicious = true;
            }
            
            return { issues, suspicious };
        }

        // Determine autonomous actions based on analysis
        function determineAutonomousActions(aiResult, patternMatch, threatIntel, roleCheck) {
            const actions = [];
            
            // Auto-quarantine high-confidence phishing
            if (aiResult.classification === 'Phishing' && aiResult.confidence >= agentMemory.autoActions.quarantineThreshold) {
                actions.push({
                    type: 'quarantine',
                    reason: `High-confidence phishing (${aiResult.confidence}%)`,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Escalate high-threat situations
            if (threatIntel.threatLevel === 'HIGH' || aiResult.confidence >= agentMemory.autoActions.escalationThreshold) {
                actions.push({
                    type: 'escalate',
                    reason: 'High threat level detected',
                    timestamp: new Date().toISOString()
                });
            }
            
            // Apply pattern-based actions
            if (patternMatch && patternMatch.confidence > 80) {
                actions.push({
                    type: 'pattern_based',
                    reason: patternMatch.reason,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Role-based escalation
            if (roleCheck && roleCheck.roleMismatch) {
                if (roleCheck.severity === 'high') {
                actions.push({
                        type: 'role_escalate',
                        reason: `ROLE MISMATCH: ${roleCheck.reason}`,
                        timestamp: new Date().toISOString()
                    });
                } else if (roleCheck.severity === 'moderate') {
                    actions.push({
                        type: 'role_review',
                        reason: `Role Review: ${roleCheck.reason}`,
                    timestamp: new Date().toISOString()
                });
                }
            }
            
            return actions;
        }

        // Apply learned context to improve analysis
        function applyLearnedContext(aiResult, patternMatch) {
            let learningApplied = false;
            
            if (patternMatch && patternMatch.confidence > 70) {
                // Boost confidence if pattern matches
                aiResult.confidence = aiResult.confidence + 10;
                aiResult.comment = `[Learning Applied] ${aiResult.comment}`;
                learningApplied = true;
                
                // For exact matches with high confidence, use the learned classification
                if (patternMatch.type === 'exact_match' && patternMatch.confidence >= 95) {
                    aiResult.classification = patternMatch.classification;
                    aiResult.confidence = patternMatch.confidence;
                    aiResult.comment = `[Auto-Classified] Previously analyzed: ${patternMatch.classification}`;
                }
            }
            
            return learningApplied;
        }

        // Helper functions
        function generateEmailHash(sender, subject, body) {
            // Use a simple hash function that works with Unicode
            const str = sender + subject + body;
            let hash = 0;

            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }

            // Convert to positive hex string
            return Math.abs(hash).toString(36).substring(0, 16);
        }

        function extractKeywords(text) {
            return text.toLowerCase().split(/\W+/).filter(word => word.length > 3);
        }

        async function analyzeWithAI(apiKey, sender, subject, body, patternMatch = null, threatIntel = null, roleCheck = null, userRole = null, recipientInfo = null) {
            // Try multiple free models in order of preference
            const freeModels = [
                'microsoft/wizardlm-2-8x22b:free',
                'meta-llama/llama-3.1-8b-instruct:free', 
                'google/gemma-2-9b-it:free',
                'qwen/qwen-2-7b-instruct:free',
                'huggingfaceh4/zephyr-7b-beta:free'
            ];
            const emailContent = `Subject: ${subject}\nFrom: ${sender}\n\n${body}`;
            
            // Build role context information
            let roleContext = '';
            if (userRole && roleCheck) {
                roleContext = `
Recipient Role: ${userRole}
Role Analysis: ${roleCheck ? roleCheck.reason : 'No role issues detected'}
${roleCheck && roleCheck.roleMismatch ? 'WARNING: This email content may be inappropriate for the recipient\'s role!' : ''}
`;
            }

            // Build threat context for detailed analysis
            let threatContext = '';
            if (threatIntel) {
                threatContext = `
Previous Analysis Context:
- Threat Score: ${threatIntel.threatScore}/100
- Suspicious Links: ${threatIntel.suspiciousLinks}
- Header Issues: ${threatIntel.headerIssues.join(', ')}
- Attachment Issues: ${threatIntel.attachmentIssues.join(', ')}
`;
            }

            // Create optimized prompt with clearer instructions including urgency detection
            const prompt = `Healthcare email security analysis with urgency detection. Respond with valid JSON only.

EMAIL DATA:
From: ${sender}
To: ${userRole || 'staff'} ${recipientInfo ? `(${recipientInfo.name} - ${recipientInfo.role})` : '(Unknown recipient - using default healthcare worker role)'}
Subject: ${subject}
Body: ${body}
${roleCheck ? `Role Issue: ${roleCheck.reason}` : ''}
${threatIntel ? `Threats: ${threatIntel.threatScore}/100, ${threatIntel.suspiciousLinks} suspicious links` : ''}

REQUIRED JSON OUTPUT:
{
  "classification": "Safe",
  "urgency": "Normal",
  "confidence": 85,
  "comment": "Brief explanation",
  "reasoningReport": {
    "summary": "2-sentence analysis summary",
    "threatIndicators": ["threat1", "threat2"],
    "roleAnalysis": "Role appropriateness explanation", 
    "technicalFindings": ["finding1", "finding2"],
    "recommendation": "Clear action recommendation",
    "urgencyReason": "Why this email is urgent or normal"
  }
}

CLASSIFICATION RULES:
- Safe: legitimate healthcare communication
- Suspicious: unclear/inappropriate content
- Phishing: malicious intent

URGENCY RULES (CRITICAL - ALWAYS DETECT URGENCY):
- Urgent: medical emergencies, critical alerts, time-sensitive patient care, urgent requests, any email with urgency keywords
- Normal: routine communications, general updates, non-critical information

IMPORTANT: If ANY urgency indicator is present in the email (subject OR body), classify as "Urgent". Err on the side of urgency for healthcare communications.

URGENCY INDICATORS: "emergency", "urgent", "critical", "immediate", "stat", "asap", "patient in distress", "code blue", "time sensitive", "deadline", "urgent response needed", "life threatening", "emergency room", "trauma", "cardiac arrest", "immediately", "as soon as possible", "right away", "without delay", "expires", "deadline", "due today", "must complete", "action required", "response needed"`;

            // Try models in sequence until one works
            let response = null;
            let lastError = null;
            
            for (const model of freeModels) {
                console.log(`Trying model: ${model}`);
                
                try {
                    response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'Healthcare Email Defense Demo'
                },
                body: JSON.stringify({
                            model: model,
                            max_tokens: 800,
                            temperature: 0.1,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ]
                })
            });
                    
                    if (response.ok) {
                        console.log(` Successfully using model: ${model}`);
                        break;
                    } else {
                        const errorData = await response.json();
                        console.log(` Model ${model} failed:`, errorData);
                        lastError = errorData;
                        response = null;
                    }
                } catch (error) {
                    console.log(` Model ${model} error:`, error);
                    lastError = error;
                    response = null;
                }
            }
            
            if (!response) {
                throw new Error(`All models failed. Last error: ${JSON.stringify(lastError)}`);
            }

            console.log('API Response status:', response.status);
            console.log('API Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error response:', errorText);
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();
            console.log('Full API response:', data);
            const content = data.choices[0].message.content;
            
            // Check if response was truncated
            if (data.choices[0].finish_reason === 'length') {
                console.warn(' AI response was truncated due to length limits');
            }
            
            try {
                // Clean the response content
                const cleanContent = content.trim();
                console.log('AI Response:', cleanContent);
                console.log('Response length:', cleanContent.length);
                console.log('Contains reasoningReport?', cleanContent.includes('reasoningReport'));
                
                // Try multiple JSON extraction methods
                let result;
                let jsonString = cleanContent;
                
                // Method 1: Try parsing the entire response
                try {
                    result = JSON.parse(jsonString);
                } catch {
                    // Method 2: Extract JSON using regex
                    const jsonMatch = jsonString.match(/\{[\s\S]*?\}/);
                    if (jsonMatch) {
                        try {
                            result = JSON.parse(jsonMatch[0]);
                        } catch {
                            // Method 3: Try to find JSON between backticks or code blocks
                            const codeBlockMatch = jsonString.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                            if (codeBlockMatch) {
                                result = JSON.parse(codeBlockMatch[1]);
                            } else {
                                throw new Error('No valid JSON found');
                            }
                        }
                    } else {
                        throw new Error('No JSON pattern found');
                    }
                }
                
                console.log('Parsed result:', result);
                
                // Validate and normalize the result structure
                if (result && typeof result === 'object') {
                    const classification = result.classification || 'Suspicious';
                    const urgency = result.urgency || 'Normal';
                    const confidence = Math.round(Number(result.confidence) || 70);
                    const comment = result.comment || 'Analysis completed';
                    
                    // Ensure classification is one of the valid values
                    const validClassifications = ['Safe', 'Suspicious', 'Phishing'];
                    const finalClassification = validClassifications.includes(classification) 
                        ? classification 
                        : 'Suspicious';
                    
                    // Ensure urgency is one of the valid values
                    const validUrgencies = ['Normal', 'Urgent'];
                    const finalUrgency = validUrgencies.includes(urgency) ? urgency : 'Normal';
                    
                    // Debug AI urgency detection
                    console.log(' AI Urgency Detection Debug:');
                    console.log('- Raw urgency from AI:', result.urgency);
                    console.log('- Valid urgencies:', validUrgencies);
                    console.log('- Final urgency:', finalUrgency);
                    
                    // Confidence transparency: do not clamp; report source
                    const finalConfidence = Math.round(confidence);
                    const confidenceSource = result.confidence !== undefined ? 'model' : 'unknown';
                    const confidenceJustification = confidenceSource === 'model'
                        ? 'Confidence provided by the model response'
                        : 'Confidence source unknown (no explicit model field)';
                    
                    return {
                        classification: finalClassification,
                        urgency: finalUrgency,
                        confidence: finalConfidence,
                        comment: `${comment} [confidence: ${finalConfidence}% | source: ${confidenceSource}]`,
                        confidenceSource,
                        confidenceJustification,
                        reasoningReport: result.reasoningReport || {
                            summary: `AI analysis completed. Email classified as ${finalClassification} with ${finalConfidence}% confidence (source: ${confidenceSource}). Urgency: ${finalUrgency}.`,
                            threatIndicators: result.threatIndicators || [],
                            roleAnalysis: result.roleAnalysis || `Content analyzed for ${userRole || 'healthcare worker'} role.`,
                            technicalFindings: result.technicalFindings || ['AI-based content analysis performed'],
                            urgencyReason: result.reasoningReport?.urgencyReason || `Email classified as ${finalUrgency} based on content analysis.`,
                            recommendation: result.recommendation || `${finalClassification === 'Phishing' ? 'Quarantine immediately' : finalClassification === 'Safe' ? 'Allow delivery' : 'Manual review recommended'}`
                        }
                    };
                } else {
                    throw new Error('Invalid result structure');
                }
            } catch (parseError) {
                console.warn('Failed to parse AI response:', parseError);
                console.log('Raw response:', content);
                
                // Improved fallback parsing - analyze the email content directly
                const lowerContent = content.toLowerCase();
                const emailLower = emailContent.toLowerCase();
                let classification = 'Suspicious';
                let confidence = 70;
                let comment = 'AI analysis completed - manual review recommended';
                
                // Analyze email content for threat indicators and urgency
                const phishingKeywords = ['urgent', 'immediately', 'click here', 'verify account', 'suspended', 'violation', 'compromise', 'breach', 'password expired', 'account locked', 'click here', 'verify now', 'action required', 'account suspended'];
                const safeKeywords = ['appointment', 'schedule', 'medical', 'patient', 'doctor', 'nurse', 'hospital', 'clinic', 'treatment', 'prescription', 'hipaa', 'compliance', 'training', 'reminder', 'policy', 'staff', 'internal', 'meeting', 'conference'];

                // A. LEGITIMATE MEDICAL URGENCY - Clinical and specific
                const medicalUrgencyKeywords = ['stat', 'code blue', 'code red', 'patient in distress', 'life threatening', 'cardiac arrest', 'emergency room', 'trauma', 'or schedule', 'surgery schedule', 'surgical', 'pre-op', 'post-op', 'critical patient', 'rapid response', 'stroke alert', 'sepsis', 'icu', 'intensive care', 'critical condition'];

                // B. HEALTHCARE CONTEXT - MRN/patient ID or concrete clinical terms
                const clinicalContextKeywords = ['mrn', 'medical record number', 'patient id', 'patient #', 'diagnosis', 'labs', 'radiology', 'pathology', 'biopsy', 'blood work', 'vitals', 'bp', 'heart rate', 'o2 sat', 'glucose', 'medication', 'dosage', 'prescription'];

                // C. GENERIC URGENCY - Could be legitimate OR phishing
                const genericUrgencyKeywords = ['urgent', 'emergency', 'critical', 'immediate', 'asap', 'time sensitive', 'immediately'];

                // D. PHISHING PRESSURE - Generic "take action now" tactics
                const phishingPressureKeywords = ['expires', 'deadline', 'must complete', 'due today', 'right away', 'without delay', 'urgent response needed', 'response needed', 'verify now', 'act now', 'limited time'];

                // Check for legitimate hospital/healthcare domains
                const legitimateDomains = ['generalhospital.org', 'hospital.org', 'clinic.org', 'medical.org', 'healthcare.org', '.gov', '.edu'];
                const isLegitimateDomain = legitimateDomains.some(domain => sender.toLowerCase().includes(domain));

                const phishingScore = phishingKeywords.filter(keyword => emailLower.includes(keyword)).length;
                const safeScore = safeKeywords.filter(keyword => emailLower.includes(keyword)).length;

                // Count different types of urgency
                const medicalUrgencyScore = medicalUrgencyKeywords.filter(keyword => emailLower.includes(keyword)).length;
                const clinicalContextScore = clinicalContextKeywords.filter(keyword => emailLower.includes(keyword)).length;
                const genericUrgencyScore = genericUrgencyKeywords.filter(keyword => emailLower.includes(keyword)).length;
                const phishingPressureScore = phishingPressureKeywords.filter(keyword => emailLower.includes(keyword)).length;

                // Get found keywords for debugging
                const foundPhishingKeywords = phishingKeywords.filter(keyword => emailLower.includes(keyword));
                const foundSafeKeywords = safeKeywords.filter(keyword => emailLower.includes(keyword));
                const foundMedicalUrgency = medicalUrgencyKeywords.filter(keyword => emailLower.includes(keyword));
                const foundClinicalContext = clinicalContextKeywords.filter(keyword => emailLower.includes(keyword));
                const foundGenericUrgency = genericUrgencyKeywords.filter(keyword => emailLower.includes(keyword));
                const foundPhishingPressure = phishingPressureKeywords.filter(keyword => emailLower.includes(keyword));

                // SMART URGENCY CLASSIFICATION
                // Priority 1: Medical urgency from trusted domain = URGENT (legitimate)
                // Priority 2: Medical urgency + clinical context = URGENT (legitimate even if external referral)
                // Priority 3: Generic urgency + trusted domain + healthcare content = URGENT (legitimate)
                // Priority 4: Phishing pressure + suspicious indicators = NOT URGENT (phishing tactic)
                // Priority 5: Generic urgency alone = NOT URGENT (requires context)

                let urgency = 'Normal';
                let urgencyReason = '';

                if (medicalUrgencyScore > 0 && isLegitimateDomain) {
                    // STAT, code blue, surgery from hospital.org = URGENT
                    urgency = 'Urgent';
                    urgencyReason = `Medical urgency from trusted domain: ${foundMedicalUrgency.join(', ')}`;
                } else if (medicalUrgencyScore > 0 && clinicalContextScore > 0) {
                    // Surgery info + MRN/patient data = URGENT even if from external specialist
                    urgency = 'Urgent';
                    urgencyReason = `Medical urgency with clinical context: ${foundMedicalUrgency.join(', ')} + ${foundClinicalContext.join(', ')}`;
                } else if (genericUrgencyScore > 0 && isLegitimateDomain && safeScore >= 2) {
                    // "Urgent" from hospital.org with healthcare keywords = URGENT
                    urgency = 'Urgent';
                    urgencyReason = `Urgent healthcare communication from trusted source`;
                } else if (phishingPressureScore > 0 && phishingScore >= 2) {
                    // "Expires", "must complete" + phishing keywords = NOT URGENT (phishing)
                    urgency = 'Normal';
                    urgencyReason = `Phishing pressure tactics detected - not classified as urgent`;
                } else if (genericUrgencyScore > 0 && !isLegitimateDomain && clinicalContextScore === 0) {
                    // Generic "urgent" from unknown sender with no clinical context = NOT URGENT
                    urgency = 'Normal';
                    urgencyReason = `Generic urgency without clinical context or trusted sender`;
                }

                // Debug urgency detection
                console.log(' Urgency Detection Debug:');
                console.log('- Sender domain:', sender, '| Legitimate:', isLegitimateDomain);
                console.log('- Medical urgency keywords:', foundMedicalUrgency);
                console.log('- Clinical context keywords:', foundClinicalContext);
                console.log('- Generic urgency keywords:', foundGenericUrgency);
                console.log('- Phishing pressure keywords:', foundPhishingPressure);
                console.log('- Phishing score:', phishingScore);
                console.log('- Healthcare score:', safeScore);
                console.log('- Final urgency:', urgency);
                console.log('- Reason:', urgencyReason);
                
                // Determine classification based on content analysis
                // Priority 1: Legitimate domains with healthcare content
                if (isLegitimateDomain && (safeScore >= 1 || emailLower.includes('hipaa') || emailLower.includes('training') || emailLower.includes('compliance'))) {
                    classification = 'Safe';
                    confidence = Math.max(80, 85 + safeScore * 2);
                    comment = 'Legitimate healthcare domain with appropriate content';
                }
                // Priority 2: Clear phishing indicators
                else if (phishingScore >= 2 || emailLower.includes('phishing') || emailLower.includes('malicious')) {
                    classification = 'Phishing';
                    confidence = 75 + (phishingScore * 5);
                    comment = 'Multiple threat indicators detected';
                }
                // Priority 3: Strong safe indicators
                else if (safeScore >= 2 && phishingScore === 0) {
                    classification = 'Safe';
                    confidence = Math.max(70, 80 - (safeScore * 2));
                    comment = 'Appears to be legitimate healthcare communication';
                }
                // Priority 4: AI explicitly marked as safe
                else if (lowerContent.includes('safe') && !lowerContent.includes('not safe')) {
                    classification = 'Safe';
                    confidence = 70;
                    comment = 'Marked as safe by AI analysis';
                }
                // Priority 5: AI explicitly marked as suspicious
                else if (lowerContent.includes('suspicious')) {
                    classification = 'Suspicious';
                    confidence = 75;
                    comment = 'Suspicious indicators detected';
                }
                // Priority 6: Default based on content analysis
                else {
                    if (phishingScore > safeScore) {
                        classification = 'Suspicious';
                        confidence = 65 + phishingScore * 5;
                    } else if (safeScore > 0) {
                        classification = 'Safe';
                        confidence = 60 + safeScore * 3;
                    } else {
                        classification = 'Suspicious';
                        confidence = 70;
                        comment = 'No clear indicators - defaulting to suspicious for safety';
                    }
                }
                
                // Confidence transparency: no artificial bounds
                
                // Generate reasoning report for fallback analysis
                // (foundPhishingKeywords, foundSafeKeywords, foundUrgencyKeywords already declared above)
                
                const reasoningReport = {
                    summary: `Fallback analysis completed due to AI unavailability. Email classified as ${classification} with ${confidence}% confidence based on content pattern analysis. Urgency: ${urgency}.`,
                    threatIndicators: [
                        ...(foundPhishingKeywords.length > 0 ? [`Phishing keywords detected: ${foundPhishingKeywords.join(', ')}`] : []),
                        ...(phishingScore >= 2 ? ['Multiple threat indicators present'] : []),
                        ...(!isLegitimateDomain ? ['Sender domain not in trusted healthcare domain list'] : [])
                    ],
                    roleAnalysis: roleCheck ? roleCheck.reason : `Content analyzed for ${userRole || 'healthcare worker'} role - no specific role concerns detected in fallback mode`,
                    technicalFindings: [
                        `Phishing keyword score: ${phishingScore}`,
                        `Healthcare keyword score: ${safeScore}`,
                        `Medical urgency score: ${medicalUrgencyScore}`,
                        `Clinical context score: ${clinicalContextScore}`,
                        `Phishing pressure score: ${phishingPressureScore}`,
                        `Domain legitimacy: ${isLegitimateDomain ? 'Trusted healthcare domain' : 'External domain'}`,
                        'Note: Technical analysis limited in fallback mode'
                    ],
                    urgencyReason: urgencyReason || 'No specific urgency indicators detected',
                    recommendation: classification === 'Phishing' ? 
                        'Quarantine immediately and alert security team due to multiple threat indicators' :
                        classification === 'Safe' ?
                        'Allow delivery - content appears legitimate for healthcare environment' :
                        'Manual review recommended - unclear threat level requires human analysis'
                };
                
                return {
                    classification,
                    urgency,
                    confidence,
                    comment,
                    reasoningReport
                };
            }
        }

        function updateResultsDisplay() {
            // Results are now displayed in other tabs (IT Review, History, Quarantine)
            // This function is kept for compatibility but does nothing since results-container was removed
            try {
                const container = document.getElementById('results-container');
                if (!container) {
                    // Container doesn't exist, which is expected since we removed it
                    return;
                }
                // If container exists, update it (shouldn't happen but just in case)
                if (analysisResults.length === 0) {
                    container.innerHTML = '<div class="no-results">No emails analyzed yet. Submit an email above to see results.</div>';
                    return;
                }
            } catch (error) {
                console.log('updateResultsDisplay: Container not found (expected)', error);
            }
            return;

            const tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>AI Comment</th>
                            <th>Agent Actions</th>
                            <th>IT Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysisResults.map(result => `
                            <tr>
                                <td>${result.sender}</td>
                                <td>${result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                    ${result.learningApplied ? '<div class="learning-indicator"> Learning Applied</div>' : ''}
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                    <span class="confidence-icon" onclick="openConfidenceBreakdown(${result.id})" title="View confidence breakdown"></span>
                                </td>
                                <td>
                                    <div class="ai-comment">
                                        <div class="brief-comment">${result.comment}</div>
                                        ${result.reasoningReport ? `
                                            <button class="reasoning-report-btn" onclick="openReasoningReport(${result.id})" title="View detailed analysis">
                                                 View Reasoning Report
                                            </button>
                                        ` : ''}
                                    </div>
                                    ${result.threatIntel ? `
                                        <div class="security-details">
                                            ${result.threatIntel.suspiciousLinks > 0 ? `<small> ${result.threatIntel.suspiciousLinks} suspicious links</small>` : ''}
                                            ${result.threatIntel.headerIssues.length > 0 ? `<br><small> ${result.threatIntel.headerIssues.length} header issues</small>` : ''}
                                            ${result.threatIntel.attachmentIssues.length > 0 ? `<br><small> ${result.threatIntel.attachmentIssues.length} attachment issues</small>` : ''}
                                        </div>
                                    ` : ''}
                                    ${result.roleCheck && result.roleCheck.roleMismatch ? `
                                        <div class="role-warning ${result.roleCheck.severity}">
                                            <strong> ROLE MISMATCH:</strong> ${result.roleCheck.reason}
                                            <br><small>Recipient: ${result.userRole}</small>
                                        </div>
                                    ` : result.userRole ? `
                                        <div class="role-info">
                                            <small> Recipient: ${result.userRole}</small>
                                        </div>
                                    ` : ''}
                                </td>
                                <td>
                                    <div class="agent-actions">
                                        ${result.agentActions && result.agentActions.length > 0 ? 
                                            result.agentActions.map(action => 
                                                `<span class="agent-action ${action.type}">${action.type.replace('_', ' ')}</span>`
                                            ).join('') : 
                                            '<span style="color: #718096; font-style: italic;">No actions</span>'
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="feedback-section">
                                        <button class="review-btn" onclick="openReview(${result.id})" title="Review full email">
                                             Review
                                        </button>
                                        <div class="feedback-buttons">
                                            <button class="feedback-btn correct ${result.feedback === 'correct' ? 'selected' : ''}" 
                                                    onclick="confirmFeedback(${result.id}, 'correct', '${result.classification}');">
                                                 Quarantine
                                            </button>
                                            <button class="feedback-btn incorrect ${result.feedback === 'incorrect' ? 'selected' : ''}" 
                                                    onclick="confirmFeedback(${result.id}, 'incorrect', '${result.classification}');">
                                                 Send Email
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function setFeedback(resultId, feedback) {
            console.log('setFeedback called with:', { resultId, feedback });
            console.log('Type of resultId:', typeof resultId);
            console.log('Current analysisResults:', analysisResults.map(r => ({ id: r.id, type: typeof r.id })));
            
            const result = analysisResults.find(r => r.id == resultId); // Use == instead of === to handle type coercion
            console.log('Found result:', result);
            
            if (result) {
                // Only update metrics if this is the first feedback for this email
                const isFirstFeedback = !result.feedback;
                const previousFeedback = result.feedback;
                
                result.feedback = feedback;
                
                // Learn from feedback
                learnFromFeedback(result, feedback);
                
                // Track false positives
                if (feedback === 'incorrect' && (result.classification === 'Suspicious' || result.classification === 'Phishing')) {
                    agentMemory.performanceMetrics.falsePositives++;
                }
                
                // Note: We'll recalculate accuracy after moving to history
                // This ensures we count only reviewed emails, not all analyzed emails
                
                // Move reviewed email to history
                moveToHistory(result, 'reviewed');
                
                // Recalculate accuracy after moving to history
                recalculateAccuracy();
                
                saveAgentMemory();
                updateResultsDisplay();
                updateHistoryDisplay();
                updateAgentStatus();
                updateReviewDashboard(); // Update IT Review dashboard to reflect changes
                showQuarantinedEmails(); // Update quarantine display if email was quarantined
                updateDashboard(); // Update main dashboard AI Performance metrics
            } else {
                console.error('Result not found for ID:', resultId);
                console.error('Available IDs:', analysisResults.map(r => r.id));
                alert('Error: Could not find email to update. Please refresh the page.');
            }
        }

        // Learn from feedback to improve future analysis
        function learnFromFeedback(result, feedback) {
            const sender = result.sender;
            const subject = result.subject;
            const body = result.body;
            const emailHash = generateEmailHash(sender, subject, body);
            
            // Store exact email match
            agentMemory.learnedPatterns[emailHash] = {
                classification: result.classification,
                feedback: feedback,
                timestamp: new Date().toISOString()
            };
            
            // Learn sender patterns
            const senderKey = `sender:${sender}`;
            if (!agentMemory.learnedPatterns[senderKey]) {
                agentMemory.learnedPatterns[senderKey] = {
                    classification: result.classification,
                    count: 0,
                    feedback: feedback
                };
            }
            agentMemory.learnedPatterns[senderKey].count++;
            
            // Learn keyword patterns
            const keywords = extractKeywords(subject + ' ' + body);
            keywords.forEach(keyword => {
                const keywordKey = `keyword:${keyword}`;
                if (!agentMemory.learnedPatterns[keywordKey]) {
                    agentMemory.learnedPatterns[keywordKey] = {
                        classification: result.classification,
                        count: 0,
                        feedback: feedback
                    };
                }
                agentMemory.learnedPatterns[keywordKey].count++;
            });
            
            // Store role-specific patterns
            if (result.userRole) {
                if (!agentMemory.rolePatterns[result.userRole]) {
                    agentMemory.rolePatterns[result.userRole] = {};
                }
                
                // Learn role-specific sender patterns
                const roleSenderKey = `${result.userRole}:sender:${sender}`;
                if (!agentMemory.rolePatterns[result.userRole][roleSenderKey]) {
                    agentMemory.rolePatterns[result.userRole][roleSenderKey] = {
                        classification: result.classification,
                        count: 0,
                        feedback: feedback,
                        lastSeen: new Date().toISOString()
                    };
                }
                agentMemory.rolePatterns[result.userRole][roleSenderKey].count++;
                agentMemory.rolePatterns[result.userRole][roleSenderKey].lastSeen = new Date().toISOString();
                
                // Learn role-specific content patterns for role mismatches
                if (result.roleCheck && result.roleCheck.roleMismatch) {
                    const roleMismatchKey = `${result.userRole}:mismatch:${result.roleCheck.severity}`;
                    if (!agentMemory.rolePatterns[result.userRole][roleMismatchKey]) {
                        agentMemory.rolePatterns[result.userRole][roleMismatchKey] = {
                            classification: result.classification,
                            count: 0,
                            feedback: feedback,
                            lastSeen: new Date().toISOString()
                        };
                    }
                    agentMemory.rolePatterns[result.userRole][roleMismatchKey].count++;
                    agentMemory.rolePatterns[result.userRole][roleMismatchKey].lastSeen = new Date().toISOString();
                    
                    // Track role mismatch metrics
                    agentMemory.performanceMetrics.roleMismatches++;
                }
            }
            
            // Store feedback history
            agentMemory.feedbackHistory.push({
                id: result.id,
                classification: result.classification,
                feedback: feedback,
                timestamp: new Date().toISOString(),
                sender: sender,
                subject: subject,
                userRole: result.userRole || null,
                roleMismatch: result.roleCheck ? result.roleCheck.roleMismatch : false
            });
            
            console.log(' Learning from feedback:', feedback, 'for', result.classification, 'role:', result.userRole);
        }

        // Move email to history log
        function moveToHistory(result, reason = 'reviewed') {
            const historyItem = {
                ...result,
                movedToHistory: new Date().toISOString(),
                moveReason: reason
            };

            historyResults.unshift(historyItem);

            // Remove from active results
            analysisResults = analysisResults.filter(r => r.id !== result.id);

            // Save both history and active results
            localStorage.setItem('healthcareHistoryResults', JSON.stringify(historyResults));
            localStorage.setItem('healthcareActiveResults', JSON.stringify(analysisResults));

            console.log(' Moved email to history:', reason, '- Total history items:', historyResults.length);
        }

        // Update history display
        function updateHistoryDisplay() {
            try {
                const container = document.getElementById('history-container');
                if (!container) {
                    console.log('updateHistoryDisplay: history-container not found');
                    return;
                }
                
                if (historyResults.length === 0) {
                    container.innerHTML = '<div class="no-results">No emails in history yet. Reviewed emails and safe emails will appear here.</div>';
                    return;
                }

            const tableHTML = `
                <table class="results-table history-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Recipient</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Moved</th>
                            <th>Investigation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${historyResults.map(result => `
                            <tr>
                                <td title="${result.sender}">${result.sender.length > 25 ? result.sender.substring(0, 25) + '...' : result.sender}</td>
                                <td title="${result.recipientEmail || 'Unknown'}">${result.recipientInfo ? result.recipientInfo.name : (result.recipientEmail || 'Unknown')}</td>
                                <td title="${result.subject}">${result.subject.length > 30 ? result.subject.substring(0, 30) + '...' : result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                    ${result.roleCheck && result.roleCheck.roleMismatch ? '<br><span class="role-mismatch-indicator"> Role Issue</span>' : ''}
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                    <span class="confidence-icon" onclick="openConfidenceBreakdown(${result.id})" title="View confidence breakdown"></span>
                                </td>
                                <td>
                                    <span class="history-status ${result.moveReason}">
                                        ${result.moveReason === 'auto_safe' ? 'Auto-Approved' :
                                          result.moveReason === 'auto_quarantine' ? 'Auto-Quarantined' :
                                          result.moveReason === 'auto_learned' ? 'Auto-Learned' :
                                          result.feedback === 'correct' ? 'IT Quarantined' : 'IT Approved'}
                                    </span>
                                </td>
                                <td>
                                    <span class="moved-time">${new Date(result.movedToHistory).toLocaleString()}</span>
                                </td>
                                <td>
                                    <div class="investigation-actions">
                                        <button class="investigate-btn" onclick="openHistoryReview(${result.id})" title="Full Investigation">
                                             Review
                                        </button>
                                        ${result.reasoningReport ? `
                                            <button class="reasoning-btn" onclick="openHistoryReasoningReport(${result.id})" title="AI Reasoning">
                                                 Reasoning
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

                container.innerHTML = tableHTML;
            } catch (error) {
                console.log('updateHistoryDisplay: Error updating history display', error);
            }
        }

        // Filter and search history
        let filteredHistoryResults = [];
        
        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const classificationFilter = document.getElementById('classificationFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredHistoryResults = historyResults.filter(result => {
                // Search filter
                const searchMatch = !searchTerm || 
                    result.sender.toLowerCase().includes(searchTerm) ||
                    result.subject.toLowerCase().includes(searchTerm) ||
                    (result.recipientEmail && result.recipientEmail.toLowerCase().includes(searchTerm)) ||
                    (result.recipientInfo && result.recipientInfo.name.toLowerCase().includes(searchTerm));
                
                // Classification filter
                const classificationMatch = !classificationFilter || 
                    result.classification.toLowerCase() === classificationFilter;
                
                // Status filter
                let statusMatch = true;
                if (statusFilter) {
                    switch (statusFilter) {
                        case 'auto_safe':
                            statusMatch = result.moveReason === 'auto_safe';
                            break;
                        case 'auto_learned':
                            statusMatch = result.moveReason === 'auto_learned';
                            break;
                        case 'it_quarantined':
                            statusMatch = result.feedback === 'correct';
                            break;
                        case 'it_approved':
                            statusMatch = result.feedback === 'incorrect';
                            break;
                    }
                }
                
                return searchMatch && classificationMatch && statusMatch;
            });
            
            updateFilteredHistoryDisplay();
        }
        
        function updateFilteredHistoryDisplay() {
            const container = document.getElementById('history-container');
            const resultsToDisplay = filteredHistoryResults.length > 0 ? filteredHistoryResults : 
                (historyResults.length === 0 ? [] : historyResults);
            
            if (resultsToDisplay.length === 0) {
                if (historyResults.length === 0) {
                container.innerHTML = '<div class="no-results">No emails in history yet. Reviewed emails and safe emails will appear here.</div>';
                } else {
                    container.innerHTML = '<div class="no-results">No results match your search criteria. Try adjusting your filters.</div>';
                }
                return;
            }

            const tableHTML = `
                <table class="results-table history-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Recipient</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Moved</th>
                            <th>Investigation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${resultsToDisplay.map(result => `
                            <tr>
                                <td title="${result.sender}">${result.sender.length > 25 ? result.sender.substring(0, 25) + '...' : result.sender}</td>
                                <td title="${result.recipientEmail || 'Unknown'}">${result.recipientInfo ? result.recipientInfo.name : (result.recipientEmail || 'Unknown')}</td>
                                <td title="${result.subject}">${result.subject.length > 30 ? result.subject.substring(0, 30) + '...' : result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                    ${result.roleCheck && result.roleCheck.roleMismatch ? '<br><span class="role-mismatch-indicator"> Role Issue</span>' : ''}
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                    <span class="confidence-icon" onclick="openConfidenceBreakdown(${result.id})" title="View confidence breakdown"></span>
                                </td>
                                <td>
                                    <span class="history-status ${result.moveReason}">
                                        ${result.moveReason === 'auto_safe' ? 'Auto-Approved' :
                                          result.moveReason === 'auto_quarantine' ? 'Auto-Quarantined' :
                                          result.moveReason === 'auto_learned' ? 'Auto-Learned' :
                                          result.feedback === 'correct' ? 'IT Quarantined' : 'IT Approved'}
                                    </span>
                                </td>
                                <td>
                                    <span class="moved-time">${new Date(result.movedToHistory).toLocaleString()}</span>
                                </td>
                                <td>
                                    <div class="investigation-actions">
                                        <button class="investigation-btn" onclick="openHistoryReview(${result.id})" title="Full Investigation">
                                             Review
                                        </button>
                                        ${result.reasoningReport ? `
                                            <button class="investigation-btn" onclick="openHistoryReasoningReport(${result.id})" title="AI Reasoning">
                                                 Reasoning
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }
        
        function clearFilters() {
            console.log(' clearFilters() called');
            try {
                const searchInput = document.getElementById('historySearch');
                const classFilter = document.getElementById('classificationFilter');
                const statusFilter = document.getElementById('statusFilter');

                if (searchInput) {
                    searchInput.value = '';
                    console.log(' Search input cleared');
                } else {
                    console.error(' historySearch element not found');
                }

                if (classFilter) {
                    classFilter.value = '';
                    console.log(' Classification filter cleared');
                } else {
                    console.error(' classificationFilter element not found');
                }

                if (statusFilter) {
                    statusFilter.value = '';
                    console.log(' Status filter cleared');
                } else {
                    console.error(' statusFilter element not found');
                }

                filteredHistoryResults = [];
                console.log(' Filtered results array cleared');

                updateHistoryDisplay();
                console.log(' History display updated');
                console.log(' Filters cleared successfully');
            } catch (error) {
                console.error(' Error in clearFilters():', error);
                alert('Error clearing filters: ' + error.message);
            }
        }

        // Update agent status display
        function updateAgentStatus() {
            const metrics = agentMemory.performanceMetrics;
            const historyCount = historyResults.length;
            const activeCount = analysisResults.length;
            
            const statusHTML = `
                <div class="agent-status">
                    <div class="agent-status-header">
                        <h3> Agent Status</h3>
                        <div class="agent-controls">
                            <button class="refresh-stats-btn" onclick="refreshAgentStats()" title="Refresh stats">
                                
                            </button>
                            <button class="clear-history-btn" onclick="clearAllHistory()" title="Clear all history and reset agent">
                                
                            </button>
                        </div>
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Emails Analyzed:</span>
                            <span class="status-value">${metrics.totalAnalyzed}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Accuracy Rate:</span>
                            <span class="status-value">${metrics.accuracyRate.toFixed(1)}%</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Patterns Learned:</span>
                            <span class="status-value">${Object.keys(agentMemory.learnedPatterns).length}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Active Reviews:</span>
                            <span class="status-value">${activeCount}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">History Log:</span>
                            <span class="status-value">${historyCount}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Phishing Caught:</span>
                            <span class="status-value">${metrics.phishingCaught}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">High Threats:</span>
                            <span class="status-value">${metrics.highThreatEmails}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">False Positives:</span>
                            <span class="status-value">${metrics.falsePositives}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Role Mismatches:</span>
                            <span class="status-value">${metrics.roleMismatches || 0}</span>
                        </div>
                    </div>
                    <div class="last-updated">
                        Last updated: ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            try {
                let statusContainer = document.getElementById('agent-status');
                if (statusContainer) {
                    statusContainer.innerHTML = statusHTML;
                } else {
                    // Status container doesn't exist, which is expected since results section was removed
                    console.log('Agent status update (no container):', statusHTML);
                }
            } catch (error) {
                console.log('updateAgentStatus: Error updating status (expected)', error);
            }
        }

        // Refresh agent stats manually
        function refreshAgentStats() {
            console.log(' Refreshing agent stats...');
            
            // Reload data from localStorage to ensure we have latest
            loadAgentMemory();
            
            // Recalculate accuracy based on actual feedback history
            recalculateAccuracy();
            
            // Update all displays
            updateResultsDisplay();
            updateHistoryDisplay();
            updateAgentStatus();
            
            // Add visual feedback
            const refreshBtn = document.querySelector('.refresh-stats-btn');
            if (refreshBtn) {
                refreshBtn.style.transform = 'rotate(360deg)';
                refreshBtn.style.transition = 'transform 0.5s ease';
                setTimeout(() => {
                    refreshBtn.style.transform = 'rotate(0deg)';
                }, 500);
            }
            
            console.log(' Agent stats refreshed');
        }

        // Clear all history and reset agent
        function clearAllHistory() {
            console.log(' clearAllHistory() function called');

            if (!confirm('Are you sure you want to clear all history and reset the agent? This will delete all learned patterns, feedback history, and metrics.')) {
                console.log('User cancelled clear operation');
                return;
            }

            console.log('User confirmed - starting clear operation...');
            
            // Reset all data structures
            analysisResults = [];
            historyResults = [];
            generationCounter = 0;
            lastGeneratedType = null;
            
            // Reset agent memory to defaults
            agentMemory = {
                learnedPatterns: {},
                feedbackHistory: [],
                threatIntelligence: {},
                rolePatterns: {
                    'doctor': {},
                    'nurse': {},
                    'admin': {},
                    'billing': {},
                    'pharmacy': {},
                    'it_staff': {},
                    'healthcare worker': {}
                },
                performanceMetrics: {
                    totalAnalyzed: 0,
                    correctPredictions: 0,
                    accuracyRate: 0,
                    phishingCaught: 0,
                    falsePositives: 0,
                    securityThreatsBlocked: 0,
                    highThreatEmails: 0,
                    roleMismatches: 0
                },
                autoActions: {
                    quarantineThreshold: 85,
                    escalationThreshold: 90,
                    autoQuarantineEnabled: true
                }
            };

            // Reset security metrics
            securityMetrics = {
                rateLimits: {
                    requestTimestamps: [],
                    totalBlocked: 0,
                    lastBlockedTime: null
                },
                cache: {
                    emailCache: {},
                    cacheHits: 0,
                    cacheMisses: 0
                },
                preFilter: {
                    totalPreFiltered: 0,
                    safePasses: 0,
                    phishingCaught: 0
                },
                autoTriage: {
                    autoApproved: 0,
                    autoQuarantined: 0,
                    manualReview: 0
                },
                monitoring: {
                    totalRequests: 0,
                    aiCallsSaved: 0,
                    tokensSaved: 0
                }
            };

            // Clear localStorage
            localStorage.removeItem('healthcareAgentMemory');
            localStorage.removeItem('healthcareHistoryResults');
            localStorage.removeItem('healthcareActiveResults');
            localStorage.removeItem('securityMetrics');

            // Update all displays (wrapped in try-catch to prevent errors from blocking)
            try {
                updateResultsDisplay();
                console.log(' Results display updated');
            } catch (e) {
                console.error('Error updating results display:', e);
            }

            try {
                updateHistoryDisplay();
                console.log(' History display updated');
            } catch (e) {
                console.error('Error updating history display:', e);
            }

            try {
                updateAgentStatus();
                console.log(' Agent status updated');
            } catch (e) {
                console.error('Error updating agent status:', e);
            }

            try {
                updateReviewDashboard();
                console.log(' Review dashboard updated');
            } catch (e) {
                console.error('Error updating review dashboard:', e);
            }

            try {
                updateDashboard();
                console.log(' Main dashboard updated');
            } catch (e) {
                console.error('Error updating main dashboard:', e);
            }

            try {
                showQuarantinedEmails();
                console.log(' Quarantine display updated');
            } catch (e) {
                console.error('Error updating quarantine display:', e);
            }

            try {
                updateMonitoringDisplay();
                console.log(' Security monitor updated');
            } catch (e) {
                console.error('Error updating security monitor:', e);
            }

            console.log(' All history cleared and agent reset');
            
            // Show confirmation message
            const statusContainer = document.getElementById('agent-status');
            if (statusContainer) {
                const originalContent = statusContainer.innerHTML;
                statusContainer.innerHTML = `
                    <div class="agent-status" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">
                        <h3> Agent Reset Complete</h3>
                        <p style="margin: 10px 0; opacity: 0.9;">All history cleared and agent reset to initial state.</p>
                    </div>
                `;
                
                setTimeout(() => {
                    statusContainer.innerHTML = originalContent;
                    updateAgentStatus();
                }, 3000);
            }
        }

        // Reset entire system (comprehensive reset from dashboard)
        function resetEntireSystem() {
            console.log(' resetEntireSystem() called');

            const confirmed = confirm(
                ' COMPLETE SYSTEM RESET\n\n' +
                'This will permanently delete ALL data:\n\n' +
                ' All email analysis results\n' +
                ' Complete history log\n' +
                ' IT review queue\n' +
                ' Quarantined emails\n' +
                ' All learned patterns\n' +
                ' Performance metrics\n' +
                ' Security metrics (DDOS protection stats)\n' +
                ' AI feedback and training data\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Are you absolutely sure you want to proceed?'
            );

            if (!confirmed) {
                console.log('User cancelled system reset');
                return;
            }

            // Double confirmation for safety
            const doubleConfirm = confirm(
                ' FINAL CONFIRMATION\n\n' +
                'You are about to PERMANENTLY DELETE all system data.\n\n' +
                'Click OK to proceed with COMPLETE SYSTEM RESET.'
            );

            if (!doubleConfirm) {
                console.log('User cancelled on second confirmation');
                return;
            }

            console.log('User confirmed - performing complete system reset...');

            try {
                // Reset all data structures
                analysisResults = [];
                historyResults = [];
                filteredHistoryResults = [];
                generationCounter = 0;
                lastGeneratedType = null;

                // Reset agent memory to defaults
                agentMemory = {
                    learnedPatterns: {},
                    feedbackHistory: [],
                    threatIntelligence: {},
                    rolePatterns: {
                        'doctor': {},
                        'nurse': {},
                        'admin': {},
                        'billing': {},
                        'pharmacy': {},
                        'it_staff': {},
                        'healthcare worker': {}
                    },
                    performanceMetrics: {
                        totalAnalyzed: 0,
                        correctPredictions: 0,
                        accuracyRate: 0,
                        phishingCaught: 0,
                        falsePositives: 0,
                        securityThreatsBlocked: 0,
                        highThreatEmails: 0,
                        roleMismatches: 0
                    },
                    autoActions: {
                        quarantineThreshold: 85,
                        escalationThreshold: 90,
                        autoQuarantineEnabled: true
                    }
                };

                // Reset security metrics (DDOS protection)
                securityMetrics = {
                    rateLimits: {
                        requestTimestamps: [],
                        totalBlocked: 0,
                        lastBlockedTime: null
                    },
                    cache: {
                        emailCache: {},
                        cacheHits: 0,
                        cacheMisses: 0
                    },
                    preFilter: {
                        totalPreFiltered: 0,
                        safePasses: 0,
                        phishingCaught: 0
                    },
                    autoTriage: {
                        autoApproved: 0,
                        autoQuarantined: 0,
                        manualReview: 0
                    },
                    monitoring: {
                        totalRequests: 0,
                        aiCallsSaved: 0,
                        tokensSaved: 0
                    }
                };

                // Clear all localStorage
                localStorage.removeItem('healthcareAgentMemory');
                localStorage.removeItem('healthcareHistoryResults');
                localStorage.removeItem('healthcareActiveResults');
                localStorage.removeItem('securityMetrics');
                console.log(' All localStorage cleared');

                // Update all displays with error handling
                const updates = [
                    { fn: updateResultsDisplay, name: 'Results display' },
                    { fn: updateHistoryDisplay, name: 'History display' },
                    { fn: updateAgentStatus, name: 'Agent status' },
                    { fn: updateReviewDashboard, name: 'Review dashboard' },
                    { fn: updateDashboard, name: 'Main dashboard' },
                    { fn: showQuarantinedEmails, name: 'Quarantine display' },
                    { fn: updateMonitoringDisplay, name: 'Security monitor' }
                ];

                updates.forEach(({ fn, name }) => {
                    try {
                        fn();
                        console.log(` ${name} updated`);
                    } catch (e) {
                        console.error(`Error updating ${name}:`, e);
                    }
                });

                console.log(' Complete system reset successful');

                // Show success notification
                alert(
                    ' SYSTEM RESET COMPLETE\n\n' +
                    'All data has been permanently deleted.\n' +
                    'The system has been reset to its initial state.\n\n' +
                    'You can now start fresh with new email analysis.'
                );

            } catch (error) {
                console.error(' Error during system reset:', error);
                alert(
                    ' ERROR DURING RESET\n\n' +
                    'An error occurred while resetting the system:\n\n' +
                    error.message + '\n\n' +
                    'Please refresh the page and try again.'
                );
            }
        }

        // Tab Navigation Functions
        function showTab(tabName) {
            // Hide all tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Update dashboard if dashboard tab is selected
            if (tabName === 'dashboard') {
                updateDashboard();
            }

            // Update quarantine display if quarantine tab is selected
            if (tabName === 'quarantine') {
                showQuarantinedEmails(); // Always show quarantined emails, not flagged emails
            }

            // Update IT review dashboard if review tab is selected
            if (tabName === 'review') {
                updateReviewDashboard();
            }

            // Update history display if history tab is selected
            if (tabName === 'history') {
                updateHistoryDisplay();
            }

            // Initialize metrics charts if metrics tab is selected
            if (tabName === 'metrics') {
                setTimeout(() => initMetricsCharts(), 100); // Small delay to ensure DOM is ready
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            updateMetricsCards();
            updateCharts();
            updatePerformanceMetrics();
        }

        function updateMetricsCards() {
            // Calculate real metrics from history data
            const totalEmails = historyResults.length;
            const totalReviewed = historyResults.filter(item => item.feedback).length;
            const correctPredictions = historyResults.filter(item => item.feedback === 'correct').length;
            const accuracy = totalReviewed > 0 ? (correctPredictions / totalReviewed) * 100 : 0;
            
            // Transparent threat calculation: phishing + security threats (no double counting)
            const phishingCaught = agentMemory.performanceMetrics.phishingCaught;
            const securityThreats = agentMemory.performanceMetrics.securityThreatsBlocked;
            const threatsBlocked = phishingCaught + securityThreats;
            
            // Update metric displays
            document.getElementById('totalEmailsMetric').textContent = totalEmails;
            document.getElementById('accuracyMetric').textContent = accuracy.toFixed(1) + '%';
            document.getElementById('threatsBlockedMetric').textContent = threatsBlocked;
            
            // Console log for debugging and reporting
            console.log(`Metrics calculated: Total=${totalEmails}, Accuracy=${accuracy.toFixed(1)}%, Threats=${threatsBlocked}`);
            console.log(`Formulas: Total=${totalEmails} emails in history, Accuracy=${correctPredictions}/${totalReviewed}  100 = ${accuracy.toFixed(1)}%, Threats=${phishingCaught} + ${securityThreats} = ${threatsBlocked}`);
        }

        function updateCharts() {
            updateClassificationChart();
            updateThreatTrends();
        }

        function updateClassificationChart() {
            const safeCount = historyResults.filter(r => r.classification === 'Safe').length;
            const suspiciousCount = historyResults.filter(r => r.classification === 'Suspicious').length;
            const phishingCount = historyResults.filter(r => r.classification === 'Phishing').length;
            
            const chartContainer = document.getElementById('classificationChart');
            
            if (safeCount + suspiciousCount + phishingCount === 0) {
                chartContainer.innerHTML = '<div class="chart-placeholder">No classification data available yet</div>';
                return;
            }
            
            const total = safeCount + suspiciousCount + phishingCount;
            const safePercent = (safeCount / total * 100).toFixed(1);
            const suspiciousPercent = (suspiciousCount / total * 100).toFixed(1);
            const phishingPercent = (phishingCount / total * 100).toFixed(1);
            
            chartContainer.innerHTML = `
                <div class="chart-bars">
                    <div class="chart-bar">
                        <div class="bar-label">Safe (${safeCount})</div>
                        <div class="bar-fill safe" style="width: ${safePercent}%">${safePercent}%</div>
                    </div>
                    <div class="chart-bar">
                        <div class="bar-label">Suspicious (${suspiciousCount})</div>
                        <div class="bar-fill suspicious" style="width: ${suspiciousPercent}%">${suspiciousPercent}%</div>
                    </div>
                    <div class="chart-bar">
                        <div class="bar-label">Phishing (${phishingCount})</div>
                        <div class="bar-fill phishing" style="width: ${phishingPercent}%">${phishingPercent}%</div>
                    </div>
                </div>
            `;
        }

        function updateThreatTrends() {
            const threatTrends = document.getElementById('threatTrends');
            const recentThreats = historyResults.filter(r => 
                r.classification === 'Suspicious' || r.classification === 'Phishing'
            ).slice(-7); // Last 7 threats
            
            if (recentThreats.length === 0) {
                threatTrends.innerHTML = '<div class="chart-placeholder">No recent threats detected</div>';
                return;
            }
            
            threatTrends.innerHTML = `
                <div class="threat-list">
                    ${recentThreats.map(threat => `
                        <div class="threat-item">
                            <span class="threat-type ${threat.classification.toLowerCase()}">${threat.classification}</span>
                            <span class="threat-sender">${threat.sender.length > 25 ? threat.sender.substring(0, 25) + '...' : threat.sender}</span>
                            <span class="threat-date">${new Date(threat.movedToHistory).toLocaleDateString()}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }


        function updatePerformanceMetrics() {
            const totalReviewed = historyResults.filter(item => item.feedback).length;
            const falsePositives = historyResults.filter(item => 
                item.feedback === 'incorrect' && (item.classification === 'Suspicious' || item.classification === 'Phishing')
            ).length;
            const falseNegatives = historyResults.filter(item => 
                item.feedback === 'incorrect' && item.classification === 'Safe'
            ).length;
            
            const falsePositiveRate = totalReviewed > 0 ? (falsePositives / totalReviewed * 100).toFixed(1) : 0;
            const falseNegativeRate = totalReviewed > 0 ? (falseNegatives / totalReviewed * 100).toFixed(1) : 0;
            
            document.getElementById('falsePositiveRate').textContent = falsePositiveRate + '%';
            document.getElementById('falseNegativeRate').textContent = falseNegativeRate + '%';
        }

        // Quarantine Display Functions
        function updateQuarantineDisplay() {
            const container = document.getElementById('quarantine-container');
            const quarantineItems = analysisResults.filter(result => 
                result.classification === 'Suspicious' || result.classification === 'Phishing'
            );
            
            if (quarantineItems.length === 0) {
                container.innerHTML = '<div class="no-results">No emails in quarantine. Suspicious emails will appear here for investigation.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="results-table quarantine-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Recipient</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quarantineItems.map(result => `
                            <tr>
                                <td title="${result.sender}">${result.sender.length > 25 ? result.sender.substring(0, 25) + '...' : result.sender}</td>
                                <td title="${result.recipientEmail || 'Unknown'}">${result.recipientInfo ? result.recipientInfo.name : (result.recipientEmail || 'Unknown')}</td>
                                <td title="${result.subject}">${result.subject.length > 30 ? result.subject.substring(0, 30) + '...' : result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                    <span class="confidence-icon" onclick="openConfidenceBreakdown(${result.id})" title="View confidence breakdown"></span>
                                </td>
                                <td>
                                    <div class="quarantine-actions">
                                        <button class="review-btn" onclick="openEmailModal(${result.id})" title="Review Email">
                                             Review
                                        </button>
                                        <button class="reasoning-btn" onclick="openReasoningModal(${result.id})" title="View AI Reasoning">
                                             Reasoning
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // Show quarantined emails (emails that were actually quarantined by IT decisions)
        function showQuarantinedEmails() {
            const container = document.getElementById('quarantine-container');

            // Get auto-quarantined emails from active results (shouldn't be any after our fix, but kept for safety)
            const autoQuarantinedActive = analysisResults.filter(result =>
                result.quarantined === true
            );

            // Get auto-quarantined emails from history
            const autoQuarantinedHistory = historyResults.filter(result =>
                result.moveReason === 'auto_quarantine' || result.quarantined === true
            );

            // Get IT-quarantined emails from history
            const itQuarantined = historyResults.filter(result =>
                result.feedback === 'correct' && result.moveReason !== 'auto_quarantine' // Emails that were quarantined by IT
            );

            // Combine all lists (remove duplicates by ID)
            const allQuarantined = [...autoQuarantinedActive, ...autoQuarantinedHistory, ...itQuarantined];
            const quarantinedItems = allQuarantined.filter((item, index, self) =>
                index === self.findIndex((t) => t.id === item.id)
            );

            if (quarantinedItems.length === 0) {
                container.innerHTML = '<div class="no-results">No emails have been quarantined yet. Auto-quarantined and IT-quarantined emails will appear here.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="results-table quarantine-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Recipient</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Quarantine Type</th>
                            <th>Quarantined Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quarantinedItems.map(result => {
                            const isAutoQuarantined = result.quarantined === true;
                            const quarantineDate = isAutoQuarantined ? result.quarantineDate : result.movedToHistory;
                            const quarantineType = isAutoQuarantined ? 'Auto-Quarantined' : 'IT Quarantined';

                            return `
                            <tr>
                                <td title="${result.sender}">${result.sender.length > 25 ? result.sender.substring(0, 25) + '...' : result.sender}</td>
                                <td title="${result.recipientEmail || 'Unknown'}">${result.recipientInfo ? result.recipientInfo.name : (result.recipientEmail || 'Unknown')}</td>
                                <td title="${result.subject}">${result.subject.length > 30 ? result.subject.substring(0, 30) + '...' : result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                    <span class="confidence-icon" onclick="openConfidenceBreakdown(${result.id})" title="View confidence breakdown"></span>
                                </td>
                                <td>
                                    <span class="history-status ${isAutoQuarantined ? 'auto_quarantine' : 'reviewed'}">
                                        ${quarantineType}
                                    </span>
                                </td>
                                <td>
                                    <span class="quarantine-date">${new Date(quarantineDate).toLocaleDateString()}</span>
                                </td>
                                <td>
                                    <div class="quarantine-actions">
                                        <button class="review-btn" onclick="openEmailModal(${result.id})" title="Review Email">
                                             Review
                                        </button>
                                        ${result.reasoningReport ? `
                                            <button class="reasoning-btn" onclick="openReasoningModal(${result.id})" title="View AI Reasoning">
                                                 Reasoning
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // IT Review Dashboard Functions
        function updateReviewDashboard() {
            updateReviewStats();
            updateReviewQueue();
            updateRecentDecisions();
        }

        function updateReviewStats() {
            // Count ALL emails in analysisResults that aren't quarantined (includes low-confidence Safe emails)
            const pendingReview = analysisResults.filter(result =>
                !result.quarantined
            ).length;
            
            const reviewedToday = historyResults.filter(result => {
                const today = new Date().toDateString();
                const resultDate = new Date(result.movedToHistory).toDateString();
                return resultDate === today && result.feedback;
            }).length;
            
            const totalReviewed = historyResults.filter(result => result.feedback).length;
            const correctDecisions = historyResults.filter(result => result.feedback === 'correct').length;
            const reviewAccuracy = totalReviewed > 0 ? (correctDecisions / totalReviewed * 100).toFixed(1) : 0;
            
            document.getElementById('pendingReviewCount').textContent = pendingReview;
            document.getElementById('reviewedToday').textContent = reviewedToday;
            document.getElementById('reviewAccuracy').textContent = reviewAccuracy + '%';
        }

        function updateReviewQueue() {
            const container = document.getElementById('review-queue-container');

            console.log(' updateReviewQueue called');
            console.log('   Total analysisResults:', analysisResults.length);
            console.log('   All results:', analysisResults.map(r => `${r.id}:${r.classification}:${r.confidence}%`));

            // Show ALL emails in analysisResults that aren't quarantined
            // This includes Safe emails with low confidence (<90%) that need review
            const reviewItems = analysisResults.filter(result => !result.quarantined);

            console.log('   After filtering for IT Review:', reviewItems.length);
            console.log('   Filtered items:', reviewItems.map(r => `${r.id}:${r.classification}:${r.confidence}%`));
            
            // Sort by priority: Urgent first, then Suspicious/Phishing, then Safe low-confidence, then by timestamp
            reviewItems.sort((a, b) => {
                // Urgent emails always first
                if (a.urgency === 'Urgent' && b.urgency !== 'Urgent') return -1;
                if (b.urgency === 'Urgent' && a.urgency !== 'Urgent') return 1;

                // Within same urgency: Suspicious/Phishing before Safe
                if (a.urgency === b.urgency) {
                    const aThreat = (a.classification === 'Suspicious' || a.classification === 'Phishing');
                    const bThreat = (b.classification === 'Suspicious' || b.classification === 'Phishing');
                    if (aThreat && !bThreat) return -1;
                    if (!aThreat && bThreat) return 1;
                }

                return new Date(b.timestamp) - new Date(a.timestamp); // Newer first within same priority level
            });
            
            if (reviewItems.length === 0) {
                container.innerHTML = '<div class="no-results">No emails pending review. All emails requiring manual oversight will appear here.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="results-table review-queue-table">
                    <thead>
                        <tr>
                            <th>Priority</th>
                            <th>Sender</th>
                            <th>Recipient</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reviewItems.map(result => {
                            const isThreat = (result.classification === 'Suspicious' || result.classification === 'Phishing');
                            const isLowConfidenceSafe = (result.classification === 'Safe' && result.confidence < 90);
                            return `
                            <tr class="${result.urgency === 'Urgent' ? 'urgent-row' : ''}">
                                <td>
                                    ${result.urgency === 'Urgent' ?
                                        `<button class="urgency-badge urgent clickable" onclick="openUrgencyReasoning(${result.id})" title="View urgency classification reasoning"> URGENT</button>` :
                                        (isThreat || isLowConfidenceSafe) ? `<button class="urgency-badge normal clickable" style="background: #ffa502; color: white;" onclick="openUrgencyReasoning(${result.id})" title="View priority classification"> MEDIUM</button>` :
                                        `<button class="urgency-badge normal clickable" style="background: #48bb78; color: white;" onclick="openUrgencyReasoning(${result.id})" title="View priority classification"> LOW</button>`
                                    }
                                </td>
                                <td title="${result.sender}">${result.sender}</td>
                                <td title="${result.recipientInfo ? result.recipientInfo.name : (result.recipientEmail || 'Unknown')}">${result.recipientInfo ? result.recipientInfo.name : (result.recipientEmail || 'Unknown')}</td>
                                <td title="${result.subject}">${result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                    ${result.roleCheck && result.roleCheck.roleMismatch ? '<br><span class="role-mismatch-indicator"> Role Issue</span>' : ''}
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                    <span class="confidence-icon" onclick="openConfidenceBreakdown(${result.id})" title="View confidence breakdown"></span>
                                </td>
                                <td>
                                    <div class="review-actions">
                                        <button class="approve-btn" onclick="approveEmail(${result.id})" title="Send Email">
                                             Send
                                        </button>
                                        <button class="reject-btn" onclick="rejectEmail(${result.id})" title="Quarantine Email">
                                             Quarantine
                                        </button>
                                        <button class="review-btn" onclick="openEmailModal(${result.id})" title="Review Details">
                                             Details
                                        </button>
                                        ${result.reasoningReport ? `
                                            <button class="reasoning-btn" onclick="openReasoningModal(${result.id})" title="View AI Reasoning">
                                                 Reasoning
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function updateRecentDecisions() {
            const container = document.getElementById('recent-decisions-container');
            const recentDecisions = historyResults
                .filter(result => result.feedback)
                .sort((a, b) => new Date(b.movedToHistory) - new Date(a.movedToHistory))
                .slice(0, 10); // Last 10 decisions
            
            if (recentDecisions.length === 0) {
                container.innerHTML = '<div class="no-results">No recent decisions. Reviewed emails will appear here.</div>';
                return;
            }
            
            const decisionsHTML = recentDecisions.map(result => `
                <div class="recent-decision ${result.feedback === 'correct' ? 'clickable' : ''}" 
                     ${result.feedback === 'correct' ? `onclick="navigateToQuarantine(${result.id})"` : ''}>
                    <div class="decision-info">
                        <div class="decision-email">${result.sender}  ${result.recipientInfo ? result.recipientInfo.name : 'Unknown'}</div>
                        <div class="decision-details">
                            ${result.subject.length > 50 ? result.subject.substring(0, 50) + '...' : result.subject}  
                            ${new Date(result.movedToHistory).toLocaleDateString()}  
                            ${result.classification}
                            ${result.feedback === 'correct' ? '  <span class="click-hint">Click to view in quarantine</span>' : ''}
                        </div>
                    </div>
                    <div class="decision-badge ${result.feedback === 'correct' ? 'rejected' : 'approved'}">
                        ${result.feedback === 'correct' ? 'Quarantined' : 'Sent'}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = decisionsHTML;
        }

        // Email Review Action Functions (moved from the old quarantine actions)
        function approveEmail(id) {
            const result = analysisResults.find(r => r.id === id);
            if (!result) {
                console.error('Email not found in analysis results:', id);
                return;
            }

            confirmFeedback(id, 'incorrect', result.classification); // 'incorrect' means we disagree with AI's threat assessment
        }

        function rejectEmail(id) {
            const result = analysisResults.find(r => r.id === id);
            if (!result) {
                console.error('Email not found in analysis results:', id);
                return;
            }

            confirmFeedback(id, 'correct', result.classification); // 'correct' means we agree with AI's threat assessment
        }

        // Navigation function for quarantined emails
        function navigateToQuarantine(emailId) {
            // Switch to quarantine tab
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('quarantine-tab').classList.add('active');
            document.querySelector('[onclick="showTab(\'quarantine\')"]').classList.add('active');
            
            // Show quarantined emails (emails that were actually quarantined by IT decisions)
            showQuarantinedEmails();
            
            // Highlight the specific email if it exists in quarantine
            setTimeout(() => {
                const quarantineTable = document.querySelector('#quarantine-container table');
                if (quarantineTable) {
                    // Find and highlight the email row
                    const rows = quarantineTable.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        // Check if this row contains the email (basic matching by content)
                        const cells = row.querySelectorAll('td');
                        if (cells.length > 0) {
                            // Add a highlight class to draw attention
                            row.classList.add('highlighted-email');
                            
                            // Remove highlight after 3 seconds
                            setTimeout(() => {
                                row.classList.remove('highlighted-email');
                            }, 3000);
                        }
                    });
                    
                    // Scroll to the quarantine section
                    quarantineTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // Update recipient info display based on email input
        function updateRecipientInfo() {
            const emailInput = document.getElementById('recipientEmail');
            const recipientInfo = document.getElementById('recipientInfo');
            const recipientName = document.getElementById('recipientName');
            const recipientRole = document.getElementById('recipientRole');
            const recipientDepartment = document.getElementById('recipientDepartment');
            const unknownUserWarning = document.getElementById('unknownUserWarning');
            
            const email = emailInput.value.trim();
            
            if (!email) {
                recipientInfo.style.display = 'none';
                return;
            }
            
            const userInfo = detectRecipientRole(email);
            
            if (userInfo) {
                recipientInfo.style.display = 'block';
                recipientName.textContent = userInfo.name;
                recipientRole.textContent = userInfo.role.charAt(0).toUpperCase() + userInfo.role.slice(1);
                recipientDepartment.textContent = userInfo.department;
                
                if (userInfo.isKnownUser) {
                    unknownUserWarning.style.display = 'none';
                    recipientInfo.style.background = '#f0f9ff';
                    recipientInfo.style.borderColor = '#bfdbfe';
                } else {
                    unknownUserWarning.style.display = 'block';
                    recipientInfo.style.background = '#fef5e7';
                    recipientInfo.style.borderColor = '#f6cc8f';
                }
            } else {
                // Show unknown recipient info
                recipientInfo.style.display = 'block';
                recipientName.textContent = 'Unknown User';
                recipientRole.textContent = 'Healthcare Worker (Default)';
                recipientDepartment.textContent = 'Unknown Department';
                
                unknownUserWarning.style.display = 'block';
                unknownUserWarning.textContent = ' Unknown recipient - using default healthcare worker role for analysis';
                recipientInfo.style.background = '#fef5e7';
                recipientInfo.style.borderColor = '#f6cc8f';
            }
        }

        // Modal Functions
        function openEmailModal(resultId) {
            // Try to find in analysisResults first (active queue)
            let result = analysisResults.find(r => r.id === resultId);
            
            // If not found, try historyResults (reviewed emails)
            if (!result) {
                result = historyResults.find(r => r.id === resultId);
            }
            
            if (!result) {
                console.error('Result not found for ID:', resultId);
                return;
            }

            const modal = document.getElementById('emailModal');
            
            // Populate modal with email details
            document.getElementById('modalSender').textContent = result.sender;
            document.getElementById('modalRecipient').textContent = result.recipientEmail || 'Unknown';
            document.getElementById('modalSubject').textContent = result.subject;
            document.getElementById('modalBody').textContent = result.body;
            
            // Update analysis details
            const classificationSpan = document.getElementById('modalClassification');
            classificationSpan.innerHTML = `<span class="classification ${(result.classification || 'Unknown').toLowerCase()}">${result.classification || 'Unknown'}</span>`;
            
            document.getElementById('modalConfidence').textContent = `${result.confidence || 0}%`;
            document.getElementById('modalComment').textContent = result.comment || 'No comment available';
            
            // Show/hide reasoning report button
            const reasoningBtn = document.getElementById('modalReasoningBtn');
            if (result.reasoningReport) {
                reasoningBtn.style.display = 'inline-block';
                reasoningBtn.onclick = () => openReasoningFromModal(resultId);
            } else {
                reasoningBtn.style.display = 'none';
            }
            
            // Store result ID for feedback
            modal.dataset.resultId = resultId;
            
            modal.style.display = 'block';
        }

        function openReview(resultId) {
            const result = analysisResults.find(r => r.id === resultId);
            if (!result) return;

            console.log('Opening review for result:', result);
            console.log('Body content:', result.body);
            console.log('Body type:', typeof result.body);

            // Populate modal
            document.getElementById('modalSender').textContent = result.sender || 'No sender';
            document.getElementById('modalSubject').textContent = result.subject || 'No subject';
            
            const bodyContent = result.body || 'No body content';
            console.log('Body content to display:', bodyContent);
            document.getElementById('modalBody').innerHTML = bodyContent.replace(/\n/g, '<br>');
            
            const classificationSpan = document.getElementById('modalClassification');
            classificationSpan.innerHTML = `<span class="classification ${(result.classification || 'Unknown').toLowerCase()}">${result.classification || 'Unknown'}</span>`;
            
            document.getElementById('modalConfidence').textContent = `${result.confidence || 0}%`;
            document.getElementById('modalComment').textContent = result.comment || 'No comment available';
            
            // Store result ID for feedback
            document.getElementById('emailModal').dataset.resultId = resultId;
            
            // Show modal
            document.getElementById('emailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('emailModal').style.display = 'none';
        }


        function setFeedbackFromModal(feedback) {
            const resultId = parseInt(document.getElementById('emailModal').dataset.resultId);
            setFeedback(resultId, feedback);
            closeModal();
        }

        function openReasoningFromModal(resultId) {
            // Try to find in analysisResults first (active queue)
            let result = analysisResults.find(r => r.id === resultId);
            
            // If not found, try historyResults (reviewed emails)
            if (!result) {
                result = historyResults.find(r => r.id === resultId);
            }
            
            if (!result || !result.reasoningReport) {
                console.error('Reasoning report not found for result ID:', resultId);
                console.error('Result:', result);
                return;
            }

            console.log('Found reasoning report:', result.reasoningReport);

            // Close email modal first
            closeModal();
            
            // Open reasoning modal
            const reasoningModal = document.getElementById('reasoningModal');
            const modalContent = document.getElementById('reasoningModalContent');
            
            if (modalContent && result.reasoningReport) {
                modalContent.innerHTML = `
                    <div class="reasoning-section">
                        <h4> Analysis Summary</h4>
                        <p>${result.reasoningReport.summary || 'No summary available'}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Threat Indicators</h4>
                        <ul>
                            ${result.reasoningReport.threatIndicators ? result.reasoningReport.threatIndicators.map(indicator => `<li>${indicator}</li>`).join('') : '<li>No threat indicators detected</li>'}
                        </ul>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Role Analysis</h4>
                        <p>${result.reasoningReport.roleAnalysis || 'No role analysis available'}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Technical Findings</h4>
                        <ul>
                            ${result.reasoningReport.technicalFindings ? result.reasoningReport.technicalFindings.map(finding => `<li>${finding}</li>`).join('') : '<li>No technical findings</li>'}
                        </ul>
                    </div>
                    
                    <div class="reasoning-section recommendation">
                        <h4> Recommendation</h4>
                        <p>${result.reasoningReport.recommendation || 'No recommendation available'}</p>
                    </div>
                `;
            }
            
            reasoningModal.style.display = 'block';
        }

        // Opens reasoning report modal from any context (quarantine/review/history)
        function openReasoningModal(resultId) {
            console.log('openReasoningModal called with ID:', resultId);
            
            // Prefer active analysis results, then fall back to history
            let result = analysisResults.find(r => r.id === resultId);
            if (!result) {
                console.log('Not found in analysisResults, checking historyResults...');
                result = historyResults.find(r => r.id === resultId);
            }
            
            console.log('Found result:', result);
            console.log('Has reasoningReport:', result ? !!result.reasoningReport : 'no result');
            
            if (!result) {
                console.error('Result not found for ID:', resultId);
                return;
            }
            
            if (!result.reasoningReport) {
                console.error('No reasoning report for result ID:', resultId);
                console.error('Result data:', result);
                return;
            }

            const modal = document.getElementById('reasoningModal');
            const content = document.getElementById('reasoningModalContent');
            
            content.innerHTML = `
                <div class="reasoning-report-modal">
                    <div class="email-context">
                        <h3> Email Context</h3>
                        <div class="context-grid">
                            <div><strong>From:</strong> ${result.sender || 'Unknown'}</div>
                            <div><strong>To:</strong> ${result.recipientEmail || (result.recipientInfo ? result.recipientInfo.name : 'Unknown')}</div>
                            <div><strong>Subject:</strong> ${result.subject || 'No subject'}</div>
                            <div><strong>Classification:</strong> ${result.classification || 'Unknown'} (${result.confidence || 0}%)</div>
                        </div>
                    </div>

                    ${result.confidenceBreakdown ? `
                    <div class="reasoning-section confidence-breakdown">
                        <h4> Confidence Score Breakdown</h4>
                        <div class="confidence-details">
                            <div class="confidence-final">
                                <strong>Final Confidence:</strong>
                                <span class="confidence-value">${result.confidenceBreakdown.finalConfidence}%</span>
                                ${result.uncertainty ? `
                                    <span class="uncertainty-badge uncertainty-${result.uncertainty.level}">
                                        ${result.uncertainty.level} uncertainty
                                    </span>
                                ` : ''}
                            </div>

                            <div class="confidence-factors">
                                <h5>Contributing Factors:</h5>
                                <div class="factor-grid">
                                    <div class="factor-item">
                                        <span class="factor-name"> AI Analysis</span>
                                        <span class="factor-score">${result.confidenceBreakdown.aiScore.raw}%</span>
                                        <span class="factor-weight">(weight: ${result.confidenceBreakdown.aiScore.weight * 100}%)</span>
                                        <span class="factor-contribution">= ${result.confidenceBreakdown.aiScore.weighted.toFixed(1)}pts</span>
                                    </div>
                                    <div class="factor-item">
                                        <span class="factor-name"> Pattern Matching</span>
                                        <span class="factor-score">${result.confidenceBreakdown.patternScore.raw}%</span>
                                        <span class="factor-weight">(weight: ${result.confidenceBreakdown.patternScore.weight * 100}%)</span>
                                        <span class="factor-contribution">= ${result.confidenceBreakdown.patternScore.weighted.toFixed(1)}pts</span>
                                    </div>
                                    <div class="factor-item">
                                        <span class="factor-name"> Threat Intelligence</span>
                                        <span class="factor-score">${result.confidenceBreakdown.threatScore.raw}%</span>
                                        <span class="factor-weight">(weight: ${result.confidenceBreakdown.threatScore.weight * 100}%)</span>
                                        <span class="factor-contribution">= ${result.confidenceBreakdown.threatScore.weighted.toFixed(1)}pts</span>
                                    </div>
                                    <div class="factor-item">
                                        <span class="factor-name"> Role Alignment</span>
                                        <span class="factor-score">${result.confidenceBreakdown.roleScore.raw}%</span>
                                        <span class="factor-weight">(weight: ${result.confidenceBreakdown.roleScore.weight * 100}%)</span>
                                        <span class="factor-contribution">= ${result.confidenceBreakdown.roleScore.weighted.toFixed(1)}pts</span>
                                    </div>
                                    <div class="factor-item">
                                        <span class="factor-name"> Historical Feedback</span>
                                        <span class="factor-score">${result.confidenceBreakdown.feedbackScore.raw}%</span>
                                        <span class="factor-weight">(weight: ${result.confidenceBreakdown.feedbackScore.weight * 100}%)</span>
                                        <span class="factor-contribution">= ${result.confidenceBreakdown.feedbackScore.weighted.toFixed(1)}pts</span>
                                    </div>
                                </div>
                                <div class="base-confidence">
                                    <strong>Base Confidence:</strong> ${result.confidenceBreakdown.baseConfidence.toFixed(1)}%
                                </div>
                            </div>

                            ${result.confidenceBreakdown.adjustments && result.confidenceBreakdown.adjustments.length > 0 ? `
                            <div class="confidence-adjustments">
                                <h5>Adjustments Applied:</h5>
                                <ul>
                                    ${result.confidenceBreakdown.adjustments.map(adj =>
                                        `<li>${adj.reason}: <span class="${adj.adjustment > 0 ? 'positive' : 'negative'}">${adj.adjustment > 0 ? '+' : ''}${adj.adjustment}%</span></li>`
                                    ).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${result.confidenceBreakdown.calibration && result.confidenceBreakdown.calibration.adjustment !== 0 ? `
                            <div class="confidence-calibration">
                                <h5>Calibration:</h5>
                                <p>${result.confidenceBreakdown.calibration.reason}</p>
                                <p>Adjustment: <span class="${result.confidenceBreakdown.calibration.adjustment > 0 ? 'positive' : 'negative'}">
                                    ${result.confidenceBreakdown.calibration.adjustment > 0 ? '+' : ''}${result.confidenceBreakdown.calibration.adjustment}%
                                </span></p>
                            </div>
                            ` : ''}

                            ${result.uncertainty ? `
                            <div class="uncertainty-details">
                                <h5>Uncertainty Analysis:</h5>
                                <p><strong>Level:</strong> ${result.uncertainty.level.toUpperCase()} (score: ${result.uncertainty.score})</p>
                                <p>${result.uncertainty.description}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div class="reasoning-section">
                        <h4> Analysis Summary</h4>
                        <p>${result.reasoningReport.summary || 'No summary available'}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Threat Indicators</h4>
                        ${result.reasoningReport.threatIndicators && result.reasoningReport.threatIndicators.length > 0 ? `
                            <ul>
                                ${result.reasoningReport.threatIndicators.map(indicator => `<li>${indicator}</li>`).join('')}
                            </ul>
                        ` : '<p class="no-threats">No specific threat indicators detected.</p>'}
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Role Analysis</h4>
                        <p>${result.reasoningReport.roleAnalysis || 'No role analysis available'}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Technical Findings</h4>
                        ${result.reasoningReport.technicalFindings && result.reasoningReport.technicalFindings.length > 0 ? `
                            <ul>
                                ${result.reasoningReport.technicalFindings.map(finding => `<li>${finding}</li>`).join('')}
                            </ul>
                        ` : '<p>No technical findings.</p>'}
                    </div>
                    
                    <div class="reasoning-section recommendation">
                        <h4> Recommendation</h4>
                        <p><strong>${result.reasoningReport.recommendation || 'No recommendation available'}</strong></p>
                    </div>
                </div>
            `;

            console.log('About to show modal...');
            modal.style.display = 'block';
            console.log('Modal display set to block');
        }

        // Confirmation dialogs for feedback actions
        function confirmFeedback(resultId, feedback, classification) {
            const result = analysisResults.find(r => r.id === resultId);
            if (!result) return;

            let message, actionText;
            
            if (feedback === 'correct') {
                // IT chooses to quarantine
                if (classification === 'Phishing' || classification === 'Suspicious') {
                    message = `You are choosing to QUARANTINE this email (agreeing with AI's ${classification} assessment).\n\n This will INDEFINITELY STORE this email in quarantine and prevent delivery to the recipient.\n\nConfirm quarantine?`;
                    actionText = "Quarantine Email";
                } else {
                    message = `You are choosing to QUARANTINE this email (overriding AI's ${classification} assessment).\n\n This will move the email to quarantine for security review instead of allowing delivery.\n\nConfirm quarantine?`;
                    actionText = "Quarantine Email";
                }
            } else {
                // IT chooses to send email
                if (classification === 'Phishing' || classification === 'Suspicious') {
                    message = `You are choosing to SEND this email (overriding AI's ${classification} assessment).\n\n This will DELIVER this email to the intended recipient (${result.recipientEmail || 'recipient'}).\n\nAre you sure this email is safe to send?`;
                    actionText = "Send Email";
                } else {
                    message = `You are choosing to SEND this email (agreeing with AI's ${classification} assessment).\n\n This email will be delivered to the recipient and marked as reviewed.\n\nConfirm sending?`;
                    actionText = "Send Email";
                }
            }

            if (confirm(message)) {
                console.log(`${actionText} confirmed for email ID: ${resultId}`);
                setFeedback(resultId, feedback);
            }
        }

        function confirmFeedbackFromModal(feedback) {
            const resultId = parseInt(document.getElementById('emailModal').dataset.resultId);
            const result = analysisResults.find(r => r.id === resultId);
            if (!result) return;

            confirmFeedback(resultId, feedback, result.classification);
        }

        // Open reasoning report modal
        function openReasoningReport(resultId) {
            const result = analysisResults.find(r => r.id === resultId);
            if (!result || !result.reasoningReport) {
                console.error('Reasoning report not found for result ID:', resultId);
                return;
            }

            const modal = document.getElementById('reasoningModal');
            const content = document.getElementById('reasoningModalContent');
            
            content.innerHTML = `
                <div class="reasoning-report-modal">
                    <div class="email-context">
                        <h3> Email Context</h3>
                        <div class="context-grid">
                            <div><strong>From:</strong> ${result.sender}</div>
                            <div><strong>To:</strong> ${result.recipientEmail || 'Unknown Recipient'}</div>
                            <div><strong>Subject:</strong> ${result.subject}</div>
                            <div><strong>Classification:</strong> <span class="classification ${result.classification.toLowerCase()}">${result.classification}</span></div>
                        </div>
                        ${result.recipientInfo ? `
                            <div class="recipient-details-modal">
                                <h4> Recipient Details</h4>
                                <div class="context-grid">
                                    <div><strong>Name:</strong> ${result.recipientInfo.name}</div>
                                    <div><strong>Role:</strong> ${result.recipientInfo.role.charAt(0).toUpperCase() + result.recipientInfo.role.slice(1)}</div>
                                    <div><strong>Department:</strong> ${result.recipientInfo.department}</div>
                                    <div><strong>User Status:</strong> ${result.recipientInfo.isKnownUser ? ' Known User' : ' Unknown User (Role Inferred)'}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Analysis Summary</h4>
                        <p>${result.reasoningReport.summary}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Threat Indicators</h4>
                        ${result.reasoningReport.threatIndicators.length > 0 ? `
                            <ul>
                                ${result.reasoningReport.threatIndicators.map(indicator => `<li>${indicator}</li>`).join('')}
                            </ul>
                        ` : '<p class="no-threats">No specific threat indicators detected.</p>'}
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Role Analysis</h4>
                        <p>${result.reasoningReport.roleAnalysis}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Technical Findings</h4>
                        <ul>
                            ${result.reasoningReport.technicalFindings.map(finding => `<li>${finding}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="reasoning-section recommendation">
                        <h4> Recommendation</h4>
                        <p><strong>${result.reasoningReport.recommendation}</strong></p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Close reasoning report modal
        function closeReasoningModal() {
            document.getElementById('reasoningModal').style.display = 'none';
        }

        // Confidence Breakdown Modal Functions
        function openConfidenceBreakdown(resultId) {
            // Find result from either active results or history
            let result = analysisResults.find(r => r.id === resultId);
            if (!result) {
                result = historyResults.find(r => r.id === resultId);
            }

            if (!result) {
                console.error('Result not found for ID:', resultId);
                alert('Email result not found. Please try refreshing the page.');
                return;
            }

            let breakdown = result.confidenceBreakdown || result.breakdown;

            console.log('Opening confidence breakdown for result:', result);
            console.log('Breakdown data:', breakdown);

            // If no breakdown exists, generate one on-the-fly for demo purposes
            if (!breakdown || !breakdown.channels) {
                console.log(' No confidence breakdown found, generating one for demo...');
                breakdown = generatePatternBasedConfidenceBreakdown(
                    {
                        classification: result.classification,
                        confidence: result.confidence,
                        urgency: result.urgency,
                        reason: 'Reconstructed for display'
                    },
                    result.sender,
                    result.subject,
                    result.body
                );
            }

            // === OVERVIEW SECTION ===
            document.getElementById('confModalScore').textContent = result.confidence + '%';
            document.getElementById('confModalBand').textContent = breakdown.autonomyBand || 'N/A';
            const riskPercent = breakdown.riskRaw !== undefined ? (breakdown.riskRaw * 100).toFixed(1) : 'N/A';
            document.getElementById('confModalRisk').textContent = riskPercent + '%';

            // Add interpretation for low risk
            const riskElement = document.getElementById('confModalRisk');
            if (breakdown.riskRaw !== undefined && breakdown.riskRaw < 0.15) {
                riskElement.innerHTML = riskPercent + '% <span style="color: #48bb78; font-weight: 600; font-size: 0.9em;"> Clean</span>';
            } else {
                riskElement.textContent = riskPercent + '%';
            }

            document.getElementById('confModalDecision').textContent = breakdown.decision || 'N/A';

            // === CHANNELS SECTION ===
            const channelsContainer = document.getElementById('confModalChannels');
            channelsContainer.innerHTML = '';

            if (breakdown.channels) {
                const channelOrder = ['auth', 'content', 'url', 'attachment', 'context'];
                const channelNames = {
                    auth: 'AUTH/SENDER',
                    content: 'CONTENT/LANGUAGE',
                    url: 'URL/LINKS',
                    attachment: 'ATTACHMENT',
                    context: 'CONTEXT'
                };

                channelOrder.forEach(channelKey => {
                    if (!breakdown.channels[channelKey]) return;

                    const channelData = breakdown.channels[channelKey];
                    const channelDiv = document.createElement('div');
                    channelDiv.className = 'channel-item';

                    const scorePercent = (channelData.score * 100).toFixed(1);
                    const qualityPercent = (channelData.quality * 100).toFixed(1);
                    const weightPercent = (channelData.weight * 100).toFixed(0);
                    const vote = breakdown.votes ? breakdown.votes[channelKey] : 'N/A';
                    const contribution = (channelData.score * channelData.quality * channelData.weight * 100).toFixed(2);

                    let evidenceHTML = '';
                    if (channelData.evidence && channelData.evidence.length > 0) {
                        evidenceHTML = `
                            <div class="channel-evidence">
                                <strong>Evidence Found:</strong>
                                ${channelData.evidence.map(e => `<div class="channel-evidence-item"> ${e}</div>`).join('')}
                            </div>
                        `;
                    } else {
                        evidenceHTML = '<div class="channel-evidence"><em>No specific evidence detected</em></div>';
                    }

                    const scoreInterpretation = channelData.score === 0 ? '<span style="color: #48bb78; font-weight: 600;">  No Risk Detected</span>' :
                                                 channelData.score < 0.3 ? '<span style="color: #48bb78;"> (Low Risk)</span>' :
                                                 channelData.score < 0.7 ? '<span style="color: #ed8936;"> (Moderate Risk)</span>' :
                                                 '<span style="color: #f56565;"> (High Risk)</span>';

                    channelDiv.innerHTML = `
                        <div class="channel-header">
                            <span class="channel-name">${channelNames[channelKey]}</span>
                            <span class="channel-score">${scorePercent}%${scoreInterpretation}</span>
                        </div>
                        <div class="channel-details">
                            <span class="channel-detail"><strong>Raw Score:</strong> ${scorePercent}%</span>
                            <span class="channel-detail"><strong>Quality:</strong> ${qualityPercent}%</span>
                            <span class="channel-detail"><strong>Weight:</strong> ${weightPercent}%</span>
                            <span class="channel-detail"><strong>Vote:</strong> <span class="vote-badge vote-${vote}">${vote}</span></span>
                        </div>
                        <div class="channel-details" style="margin-top: 6px;">
                            <span class="channel-detail"><strong>Contribution to Risk:</strong> <span class="calc-step-value">${contribution}</span></span>
                            <span class="channel-detail" style="font-size: 11px; color: #718096;">(Score ${scorePercent}%  Quality ${qualityPercent}%  Weight ${weightPercent}%)</span>
                        </div>
                        ${evidenceHTML}
                    `;

                    channelsContainer.appendChild(channelDiv);
                });
            }

            // === AGGREGATION CALCULATION ===
            const aggregationContainer = document.getElementById('confModalAggregation');
            aggregationContainer.innerHTML = '';

            if (breakdown.channels) {
                let numeratorHTML = '<div class="calc-step"><span class="calc-step-label">Numerator:</span>';
                let denominatorHTML = '<div class="calc-step"><span class="calc-step-label">Denominator:</span>';

                let numeratorCalc = [];
                let denominatorCalc = [];

                for (const [channelKey, channelData] of Object.entries(breakdown.channels)) {
                    const w = channelData.weight;
                    const q = channelData.quality;
                    const s = channelData.score;

                    numeratorCalc.push(`(${(w*100).toFixed(0)}%  ${(q*100).toFixed(0)}%  ${(s*100).toFixed(1)}%)`);
                    denominatorCalc.push(`(${(w*100).toFixed(0)}%  ${(q*100).toFixed(0)}%)`);
                }

                numeratorHTML += numeratorCalc.join(' + ') + '</div>';
                denominatorHTML += denominatorCalc.join(' + ') + '</div>';

                aggregationContainer.innerHTML = numeratorHTML + denominatorHTML;

                // Calculate actual values
                let num = 0, den = 0;
                for (const channelData of Object.values(breakdown.channels)) {
                    num += channelData.weight * channelData.quality * channelData.score;
                    den += channelData.weight * channelData.quality;
                }

                aggregationContainer.innerHTML += `
                    <div class="calc-step">
                        <span class="calc-step-label">Result:</span>
                        <span class="calc-step-value">${(num*100).toFixed(2)} / ${(den*100).toFixed(2)} = ${((num/den)*100).toFixed(1)}%</span>
                    </div>
                `;
            }

            document.getElementById('confModalRawRisk').textContent = breakdown.riskRaw
                ? (breakdown.riskRaw * 100).toFixed(1) + '%'
                : 'N/A';

            // === QUALITY & AGREEMENT METRICS ===
            const votes = breakdown.votes ? Object.values(breakdown.votes) : [];
            const maliciousVotes = votes.filter(v => v === 'malicious').length;
            const benignVotes = votes.filter(v => v === 'benign').length;

            document.getElementById('confModalAgreement').textContent =
                breakdown.agreement ? (breakdown.agreement * 100).toFixed(0) + '%' : 'N/A';

            const agreementLevel = breakdown.agreement > 0.8 ? 'High agreement (channels mostly agree)' :
                                 breakdown.agreement > 0.5 ? 'Moderate agreement (some disagreement)' :
                                 'Low agreement (significant disagreement)';
            document.getElementById('confModalAgreementDesc').textContent = agreementLevel;

            // Vote breakdown
            let voteHTML = '<div>';
            for (const [channel, vote] of Object.entries(breakdown.votes || {})) {
                voteHTML += `<span class="vote-badge vote-${vote}">${channel.toUpperCase()}: ${vote}</span>`;
            }
            voteHTML += `</div><div style="margin-top: 8px; color: #4a5568;">
                <strong>${maliciousVotes}</strong> voted malicious,
                <strong>${benignVotes}</strong> voted benign
            </div>`;
            document.getElementById('confModalVotes').innerHTML = voteHTML;

            document.getElementById('confModalCompleteness').textContent =
                breakdown.completeness ? (breakdown.completeness * 100).toFixed(0) + '%' : 'N/A';

            document.getElementById('confModalUncertainty').textContent =
                breakdown.uncertainty ? (breakdown.uncertainty * 100).toFixed(0) + '%' : 'N/A';

            const uncertaintyLevel = breakdown.uncertainty > 0.3 ? 'High (conflicting signals or missing data)' :
                                    breakdown.uncertainty > 0.15 ? 'Moderate (some data quality issues)' :
                                    'Low (good data quality and consistency)';
            document.getElementById('confModalUncertaintyDesc').textContent = uncertaintyLevel;

            document.getElementById('confModalMargin').textContent =
                breakdown.margin ? (breakdown.margin * 100).toFixed(1) + '%' : 'N/A';

            // === FINAL CONFIDENCE CALCULATION ===
            const finalCalcContainer = document.getElementById('confModalFinalCalc');

            if (breakdown.riskRaw !== undefined) {
                const threshold = 0.5;
                const predictedMalicious = breakdown.riskRaw >= threshold;
                const chosenProb = predictedMalicious ? breakdown.riskRaw : (1 - breakdown.riskRaw);

                const probContrib = 0.55 * chosenProb;
                const marginContrib = 0.20 * (breakdown.margin || 0);
                const agreeContrib = 0.15 * (breakdown.agreement || 0);
                const completeContrib = 0.10 * (breakdown.completeness || 0);
                const uncertainPenalty = 0.10 * (breakdown.uncertainty || 0);

                finalCalcContainer.innerHTML = `
                    <div class="calc-step">
                        <span class="calc-step-label">Chosen Probability:</span>
                        <span class="calc-step-value">${(chosenProb * 100).toFixed(1)}%</span>
                        <span style="color: #718096; font-size: 11px; margin-left: 8px;">
                            (${predictedMalicious ? 'Malicious' : 'Benign'} predicted, using risk ${(breakdown.riskRaw * 100).toFixed(1)}%)
                        </span>
                    </div>
                    <div class="calc-step">
                        <span class="calc-step-label">Components:</span>
                    </div>
                    <div class="calc-step" style="padding-left: 24px;">
                        <span class="calc-step-label">55%  Probability:</span>
                        <span class="calc-step-value">0.55  ${(chosenProb*100).toFixed(1)}% = ${(probContrib*100).toFixed(1)}%</span>
                    </div>
                    <div class="calc-step" style="padding-left: 24px;">
                        <span class="calc-step-label">20%  Margin:</span>
                        <span class="calc-step-value">0.20  ${((breakdown.margin||0)*100).toFixed(1)}% = ${(marginContrib*100).toFixed(1)}%</span>
                    </div>
                    <div class="calc-step" style="padding-left: 24px;">
                        <span class="calc-step-label">15%  Agreement:</span>
                        <span class="calc-step-value">0.15  ${((breakdown.agreement||0)*100).toFixed(0)}% = ${(agreeContrib*100).toFixed(1)}%</span>
                    </div>
                    <div class="calc-step" style="padding-left: 24px;">
                        <span class="calc-step-label">10%  Completeness:</span>
                        <span class="calc-step-value">0.10  ${((breakdown.completeness||0)*100).toFixed(0)}% = ${(completeContrib*100).toFixed(1)}%</span>
                    </div>
                    <div class="calc-step" style="padding-left: 24px;">
                        <span class="calc-step-label">-10%  Uncertainty:</span>
                        <span class="calc-step-value">-0.10  ${((breakdown.uncertainty||0)*100).toFixed(0)}% = -${(uncertainPenalty*100).toFixed(1)}%</span>
                    </div>
                    <div class="calc-step" style="margin-top: 12px; border-top: 2px solid #e2e8f0; padding-top: 12px;">
                        <span class="calc-step-label">Base Confidence:</span>
                        <span class="calc-step-value">
                            ${(probContrib*100).toFixed(1)}% + ${(marginContrib*100).toFixed(1)}% + ${(agreeContrib*100).toFixed(1)}% +
                            ${(completeContrib*100).toFixed(1)}% - ${(uncertainPenalty*100).toFixed(1)}% =
                            ${((probContrib + marginContrib + agreeContrib + completeContrib - uncertainPenalty)*100).toFixed(1)}%
                        </span>
                    </div>
                `;
            }

            // === ADJUSTMENTS ===
            const adjustmentsContainer = document.getElementById('confModalAdjustments');
            const adjustmentsList = document.getElementById('confModalAdjustmentsList');

            if (breakdown.adjustments && breakdown.adjustments.length > 0) {
                adjustmentsContainer.style.display = 'block';
                adjustmentsList.innerHTML = '';

                breakdown.adjustments.forEach(adj => {
                    const adjDiv = document.createElement('div');
                    adjDiv.className = 'adjustment-item';
                    adjDiv.innerHTML = `
                        <span class="adjustment-reason">${adj.reason}</span>:
                        <span class="adjustment-value">${adj.adjustment}</span>
                    `;
                    adjustmentsList.appendChild(adjDiv);
                });
            } else {
                adjustmentsContainer.style.display = 'none';
            }

            // Show modal
            document.getElementById('confidenceModal').style.display = 'block';
        }

        function closeConfidenceModal() {
            document.getElementById('confidenceModal').style.display = 'none';
        }

        // Urgency Reasoning Modal Functions
        function openUrgencyReasoning(resultId) {
            // Find result from either active results or history
            let result = analysisResults.find(r => r.id === resultId);
            if (!result) {
                result = historyResults.find(r => r.id === resultId);
            }

            if (!result) {
                console.error('Result not found for ID:', resultId);
                alert('Email result not found. Please try refreshing the page.');
                return;
            }

            console.log('Opening urgency reasoning for:', result);

            // Populate email context
            const contextHTML = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div><strong>From:</strong> ${result.sender}</div>
                        <div><strong>To:</strong> ${result.recipientEmail || 'Unknown'}</div>
                        <div><strong>Subject:</strong> ${result.subject}</div>
                        <div><strong>Classification:</strong> <span class="classification ${result.classification.toLowerCase()}">${result.classification}</span></div>
                    </div>
                </div>
            `;
            document.getElementById('urgencyEmailContext').innerHTML = contextHTML;

            // Determine urgency classification (low, medium, urgent only)
            const isUrgent = result.urgency === 'Urgent';
            const isPhishing = result.classification === 'Phishing';
            const isSuspicious = result.classification === 'Suspicious';
            const isLowConfSafe = result.classification === 'Safe' && result.confidence < 90;

            let priorityLabel = ' LOW';
            let priorityColor = '#48bb78'; // Green for low priority
            if (isUrgent) {
                priorityLabel = ' URGENT';
                priorityColor = '#ff6b6b'; // Red
            } else if (isPhishing || isSuspicious) {
                priorityLabel = ' MEDIUM';
                priorityColor = '#ffa502'; // Orange
            } else if (isLowConfSafe) {
                priorityLabel = ' MEDIUM';
                priorityColor = '#ffa502'; // Orange - low confidence safe also gets medium
            }

            document.getElementById('urgencyClassification').textContent = priorityLabel;
            document.getElementById('urgencyClassification').parentElement.style.background =
                `linear-gradient(135deg, ${priorityColor} 0%, ${adjustColor(priorityColor, -20)} 100%)`;

            // A. Security Checks
            const securityChecks = analyzeSecurityChecks(result);
            document.getElementById('urgencySecurityChecks').innerHTML = securityChecks;

            // B. Context & Intent
            const contextIntent = analyzeContextIntent(result);
            document.getElementById('urgencyContextIntent').innerHTML = contextIntent;

            // C. Time & Behavior
            const timeBehavior = analyzeTimeBehavior(result);
            document.getElementById('urgencyTimeBehavior').innerHTML = timeBehavior;

            // Final Summary
            const finalSummary = generateUrgencySummary(result, isUrgent, isPhishing, isSuspicious, isLowConfSafe);
            document.getElementById('urgencyFinalSummary').innerHTML = finalSummary;

            // Show modal
            document.getElementById('urgencyModal').style.display = 'block';
        }

        function closeUrgencyModal() {
            document.getElementById('urgencyModal').style.display = 'none';
        }

        // Performance Metrics Functions
        let fpChart, accChart, confChart;

        function toggleMetricCard(card) {
            card.classList.toggle('active');
        }

        function calculateFP() {
            const total = parseInt(document.getElementById('fp-total').value);
            const falsePositives = parseInt(document.getElementById('fp-false').value);

            if (falsePositives > total) {
                alert('False positives cannot exceed total emails!');
                return;
            }

            const fpr = ((falsePositives / total) * 100).toFixed(2);
            const result = document.getElementById('fp-result');
            result.style.display = 'block';

            let assessment = '';
            if (fpr < 5) assessment = 'Excellent! ';
            else if (fpr < 10) assessment = 'Good ';
            else if (fpr < 20) assessment = 'Needs Improvement ';
            else assessment = 'High Alert Fatigue Risk ';

            result.innerHTML = `False Positive Rate: ${fpr}%<br><small>${assessment}</small>`;

            updateFPChart();
        }

        function calculateAccuracy() {
            const total = parseInt(document.getElementById('acc-total').value);
            const correct = parseInt(document.getElementById('acc-correct').value);

            if (correct > total) {
                alert('Correct judgments cannot exceed total emails!');
                return;
            }

            const accuracy = ((correct / total) * 100).toFixed(2);
            const result = document.getElementById('acc-result');
            result.style.display = 'block';

            let assessment = '';
            if (accuracy >= 95) assessment = 'Extremely Trustworthy! ';
            else if (accuracy >= 90) assessment = 'Highly Reliable ';
            else if (accuracy >= 80) assessment = 'Reasonably Trustworthy ';
            else assessment = 'Needs More Training ';

            result.innerHTML = `Accuracy Rate: ${accuracy}%<br><small>${assessment}</small>`;

            updateAccChart();
        }

        function calculateConfidence() {
            const signals = parseInt(document.getElementById('conf-signals').value);
            const totalSignals = parseInt(document.getElementById('conf-total-signals').value);

            if (signals > totalSignals) {
                alert('Detected signals cannot exceed total signals!');
                return;
            }

            const confidence = ((signals / totalSignals) * 100).toFixed(1);
            const result = document.getElementById('conf-result');
            result.style.display = 'block';

            let action = '';
            if (confidence >= 70) action = 'Auto-Handle ';
            else action = 'Requires Human Review ';

            result.innerHTML = `Confidence Score: ${confidence}%<br><small>${action}</small>`;

            updateConfChart();
        }

        function initMetricsCharts() {
            if (typeof Chart === 'undefined') {
                console.log('Chart.js not loaded yet, will initialize when metrics tab is shown');
                return;
            }

            initFPChart();
            initAccChart();
            initConfChart();
        }

        function initFPChart() {
            const canvas = document.getElementById('fpChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (fpChart) fpChart.destroy();

            fpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    datasets: [{
                        label: 'False Positive Rate (%)',
                        data: [18, 15, 12, 8, 6, 5],
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Simulated: FPR Improvement Over Time (Learning Trend)'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20,
                            title: {
                                display: true,
                                text: 'False Positive Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function initAccChart() {
            const canvas = document.getElementById('accChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (accChart) accChart.destroy();

            accChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    datasets: [{
                        label: 'Accuracy Rate (%)',
                        data: [78, 82, 86, 89, 92, 94],
                        borderColor: '#00f2fe',
                        backgroundColor: 'rgba(0, 242, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Simulated: Accuracy Improvement via Reinforcement Learning'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 70,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Accuracy Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function initConfChart() {
            const canvas = document.getElementById('confChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (confChart) confChart.destroy();

            confChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High Confidence\n(>70%)', 'Medium Confidence\n(40-70%)', 'Low Confidence\n(<40%)'],
                    datasets: [{
                        label: 'Number of Cases',
                        data: [720, 200, 80],
                        backgroundColor: [
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(245, 87, 108, 0.8)'
                        ],
                        borderColor: [
                            '#43e97b',
                            '#ffc107',
                            '#f5576c'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Simulated: Confidence Score Distribution (1000 emails)'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Cases'
                            }
                        }
                    }
                }
            });
        }

        function updateFPChart() {
            if (!fpChart) return;

            const total = parseInt(document.getElementById('fp-total').value);
            const falsePositives = parseInt(document.getElementById('fp-false').value);
            const currentFPR = ((falsePositives / total) * 100).toFixed(2);

            const newData = [18, 15, 12, 8, parseFloat(currentFPR) + 1, parseFloat(currentFPR)];
            fpChart.data.datasets[0].data = newData;
            fpChart.update();
        }

        function updateAccChart() {
            if (!accChart) return;

            const total = parseInt(document.getElementById('acc-total').value);
            const correct = parseInt(document.getElementById('acc-correct').value);
            const currentAcc = ((correct / total) * 100).toFixed(2);

            const newData = [78, 82, 86, parseFloat(currentAcc) - 3, parseFloat(currentAcc) - 1, parseFloat(currentAcc)];
            accChart.data.datasets[0].data = newData;
            accChart.update();
        }

        function updateConfChart() {
            if (!confChart) return;

            const signals = parseInt(document.getElementById('conf-signals').value);
            const totalSignals = parseInt(document.getElementById('conf-total-signals').value);
            const confidence = ((signals / totalSignals) * 100).toFixed(1);

            let high, medium, low;
            if (confidence >= 70) {
                high = 720;
                medium = 200;
                low = 80;
            } else if (confidence >= 40) {
                high = 500;
                medium = 350;
                low = 150;
            } else {
                high = 300;
                medium = 400;
                low = 300;
            }

            confChart.data.datasets[0].data = [high, medium, low];
            confChart.update();
        }

        function adjustColor(color, percent) {
            // Simple color adjuster for gradient
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) + amt));
            const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        function analyzeSecurityChecks(result) {
            const domain = result.sender.split('@')[1] || '';
            const trustedDomains = ['hospital.org', 'clinic.gov', 'generalhospital.org', '.gov', '.edu'];
            const suspiciousDomains = ['medical-alert.net', 'hospital-security.com', 'healthcare-emergency.net'];
            const personalEmailDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com'];

            const isTrusted = trustedDomains.some(td => domain.toLowerCase().includes(td));
            const isSuspicious = suspiciousDomains.includes(domain.toLowerCase());
            const isPersonal = personalEmailDomains.some(pd => domain.toLowerCase().includes(pd));

            // Links/Attachments analysis
            const body = result.body || '';
            const hasLinks = /https?:\/\//.test(body);
            const hasShortLinks = /(bit\.ly|tinyurl|t\.co|goo\.gl)/.test(body);
            const hasSuspiciousAttachments = /\.(exe|vbs|js|bat|zip)/.test(body.toLowerCase());
            const hasMacroContent = /macro|enable content|enable editing/i.test(body);

            return `
                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Sender/Domain Analysis</span>
                        <span class="metric-detail-value ${isTrusted ? 'vote-benign' : 'vote-malicious'}">${isTrusted ? '' : (isSuspicious || isPersonal) ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        <div><strong>Domain:</strong> ${domain}</div>
                        <div style="margin-top: 5px;">
                            ${isTrusted ? ' <strong>Trusted domain</strong> (hospital.org / .gov / .edu)' : ''}
                            ${isSuspicious ? ' <strong>Known suspicious domain</strong>' : ''}
                            ${isPersonal ? ' <strong>Personal email domain</strong> (Gmail/Yahoo/Hotmail)' : ''}
                            ${!isTrusted && !isSuspicious && !isPersonal ? ' <strong>Unknown/untrusted domain</strong>' : ''}
                        </div>
                    </div>
                </div>

                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Links & Attachments</span>
                        <span class="metric-detail-value ${!hasShortLinks && !hasSuspiciousAttachments && !hasMacroContent ? 'vote-benign' : 'vote-malicious'}">${!hasShortLinks && !hasSuspiciousAttachments && !hasMacroContent ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        ${!hasLinks ? '<div> No links detected</div>' : ''}
                        ${hasLinks && !hasShortLinks && !hasSuspiciousAttachments ? '<div> Links present, appear safe</div>' : ''}
                        ${hasShortLinks ? '<div> <strong>URL shorteners detected</strong> (bit.ly, tinyurl, etc.)</div>' : ''}
                        ${hasSuspiciousAttachments ? '<div> <strong>Suspicious file types mentioned</strong> (.exe, .zip, .vbs)</div>' : ''}
                        ${hasMacroContent ? '<div> <strong>Macro-enabled content</strong> ("enable content" detected)</div>' : ''}
                    </div>
                </div>
            `;
        }

        function analyzeContextIntent(result) {
            const body = result.body || '';
            const subject = result.subject || '';
            const combined = `${subject} ${body}`.toLowerCase();

            // Tone/Urgency analysis
            const urgencyTerms = ['urgent', 'immediately', 'asap', 'stat', 'emergency', 'critical'];
            const urgencyMatches = urgencyTerms.filter(term => combined.includes(term));
            const clinicalTerms = ['patient', 'surgery', 'or schedule', 'mrn', 'stat', 'code blue', 'ehr'];
            const clinicalMatches = clinicalTerms.filter(term => combined.includes(term));
            const genericPressure = /click here|take action now|verify immediately|act now/.test(combined);

            // Content Request analysis
            const credentialRequest = /password|username|login|credentials|verify account/.test(combined);
            const financialRequest = /wire transfer|payment|invoice|bank account|payroll/.test(combined);
            const actionRequest = /confirm|review|approve|schedule|update/.test(combined);

            // Healthcare Context
            const hasMRN = /mrn|medical record number|patient id/i.test(combined);
            const hasSpecificClinical = /diagnosis|prescription|lab results|imaging|vital signs/.test(combined);

            return `
                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Tone & Urgency</span>
                        <span class="metric-detail-value ${(clinicalMatches.length > 0 && !genericPressure) ? 'vote-benign' : 'vote-malicious'}">${(clinicalMatches.length > 0 && !genericPressure) ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        ${clinicalMatches.length > 0 ? `<div> <strong>Clinical urgency terms:</strong> ${clinicalMatches.join(', ')}</div>` : ''}
                        ${urgencyMatches.length > 0 && clinicalMatches.length === 0 ? `<div> <strong>Urgency terms:</strong> ${urgencyMatches.join(', ')}</div>` : ''}
                        ${genericPressure ? '<div> <strong>Generic pressure tactics</strong> ("click here", "act now")</div>' : ''}
                        ${urgencyMatches.length === 0 && clinicalMatches.length === 0 ? '<div> No urgency indicators</div>' : ''}
                    </div>
                </div>

                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Content Request</span>
                        <span class="metric-detail-value ${actionRequest && !credentialRequest && !financialRequest ? 'vote-benign' : 'vote-malicious'}">${actionRequest && !credentialRequest && !financialRequest ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        ${actionRequest ? '<div> Action/confirmation request (legitimate workflow)</div>' : ''}
                        ${credentialRequest ? '<div> <strong>Credential request detected</strong> (password, login)</div>' : ''}
                        ${financialRequest ? '<div> <strong>Financial request detected</strong> (payment, wire transfer)</div>' : ''}
                        ${!actionRequest && !credentialRequest && !financialRequest ? '<div> No specific request detected</div>' : ''}
                    </div>
                </div>

                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Healthcare Context</span>
                        <span class="metric-detail-value ${(hasMRN || hasSpecificClinical) ? 'vote-benign' : 'vote-malicious'}">${(hasMRN || hasSpecificClinical) ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        ${hasMRN ? '<div> <strong>Patient identifiers present</strong> (MRN, Patient ID)</div>' : ''}
                        ${hasSpecificClinical ? '<div> <strong>Specific clinical terms</strong> (diagnosis, prescription, labs)</div>' : ''}
                        ${!hasMRN && !hasSpecificClinical ? '<div> <strong>Vague/general healthcare wording</strong></div>' : ''}
                    </div>
                </div>
            `;
        }

        function analyzeTimeBehavior(result) {
            const timestamp = new Date(result.timestamp || Date.now());
            const hour = timestamp.getHours();
            const day = timestamp.getDay(); // 0 = Sunday, 6 = Saturday
            const isWeekend = (day === 0 || day === 6);
            const isOffHours = (hour < 6 || hour > 20);
            const timeAnomaly = isWeekend || isOffHours;

            // Pattern matching
            const hasPatternMatch = result.learningApplied || (result.agentActions && result.agentActions.includes('pattern'));
            const isKnownPhish = hasPatternMatch && result.classification === 'Phishing';
            const isKnownSafe = hasPatternMatch && result.classification === 'Safe';

            return `
                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Time Anomalies</span>
                        <span class="metric-detail-value ${!timeAnomaly ? 'vote-benign' : 'vote-malicious'}">${!timeAnomaly ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        <div><strong>Received:</strong> ${timestamp.toLocaleString()}</div>
                        ${isWeekend ? '<div> <strong>Weekend delivery</strong> (unusual for healthcare ops)</div>' : ''}
                        ${isOffHours ? '<div> <strong>Off-hours</strong> (before 6am or after 8pm)</div>' : ''}
                        ${!timeAnomaly ? '<div> Normal business hours</div>' : ''}
                    </div>
                </div>

                <div class="metric-detail-item">
                    <div class="metric-detail-header">
                        <span class="metric-detail-label">Pattern Matching</span>
                        <span class="metric-detail-value ${hasPatternMatch ? 'vote-benign' : ''}">${hasPatternMatch ? '' : ''}</span>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                        ${isKnownPhish ? '<div> <strong>Matches known phishing template</strong> (HITL-learned)</div>' : ''}
                        ${isKnownSafe ? '<div> <strong>Matches known safe pattern</strong> (HITL-learned)</div>' : ''}
                        ${!hasPatternMatch ? '<div> No pattern match (first-time sender/content)</div>' : ''}
                        ${result.learningApplied ? '<div> <strong>Learning applied</strong> from previous feedback</div>' : ''}
                    </div>
                </div>
            `;
        }

        function generateUrgencySummary(result, isUrgent, isPhishing, isSuspicious, isLowConfSafe) {
            let summary = '';
            let reasons = [];

            if (isUrgent) {
                reasons.push('Contains clinical urgency terms (STAT, emergency, critical)');
                reasons.push('Requires immediate medical attention or action');
                reasons.push('May impact patient care if delayed');
                summary = '<div style="background: #fff5f5; border-left: 4px solid #ff6b6b; padding: 15px; border-radius: 6px;"><strong> URGENT Classification:</strong> This email has been flagged for immediate review due to clinical urgency indicators. Healthcare operations may be time-sensitive.</div>';
            } else if (isPhishing || isSuspicious) {
                reasons.push('Classified as ' + result.classification);
                reasons.push('Contains suspicious patterns or phishing indicators');
                reasons.push('Requires security review before action');
                summary = '<div style="background: #fff7e6; border-left: 4px solid #ffa502; padding: 15px; border-radius: 6px;"><strong> REVIEW Classification:</strong> This email requires manual security review due to potential threats. Do not take action until verified.</div>';
            } else if (isLowConfSafe) {
                reasons.push('Classified as Safe but with low confidence (' + result.confidence + '%)');
                reasons.push('Insufficient evidence for automatic approval');
                reasons.push('Recommend human review for final decision');
                summary = '<div style="background: #e0e7ff; border-left: 4px solid #3730a3; padding: 15px; border-radius: 6px;"><strong> LOW CONFIDENCE Classification:</strong> The AI system has low confidence in this classification. Human review recommended for final decision.</div>';
            } else {
                reasons.push('Normal business email');
                reasons.push('No urgency or threat indicators detected');
                reasons.push('Standard processing workflow');
                summary = '<div style="background: #f0f9ff; border-left: 4px solid #74b9ff; padding: 15px; border-radius: 6px;"><strong> NORMAL Classification:</strong> This email follows standard business patterns with no urgency or threat indicators.</div>';
            }

            const reasonsList = reasons.map(r => `<li>${r}</li>`).join('');

            return summary + `
                <div style="margin-top: 15px; background: white; padding: 15px; border-radius: 6px;">
                    <strong>Contributing Factors:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${reasonsList}
                    </ul>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                        <strong>Confidence Score:</strong> ${result.confidence}%<br>
                        <strong>Classification:</strong> ${result.classification}
                    </div>
                </div>
            `;
        }

        // Investigation functions for history log
        function openHistoryReview(resultId) {
            // Find result in history
            const result = historyResults.find(r => r.id === resultId);
            if (!result) {
                console.error('History result not found for ID:', resultId);
                return;
            }

            console.log('Opening history review for result:', result);

            // Populate modal with full email details
            document.getElementById('modalSender').textContent = result.sender || 'No sender';
            document.getElementById('modalSubject').textContent = result.subject || 'No subject';
            
            const bodyContent = result.body || 'No body content';
            document.getElementById('modalBody').innerHTML = bodyContent.replace(/\n/g, '<br>');
            
            const classificationSpan = document.getElementById('modalClassification');
            classificationSpan.innerHTML = `<span class="classification ${(result.classification || 'Unknown').toLowerCase()}">${result.classification || 'Unknown'}</span>`;
            
            document.getElementById('modalConfidence').textContent = `${result.confidence || 0}%`;
            document.getElementById('modalComment').textContent = result.comment || 'No comment available';
            
            // Add investigation context
            const modalHeader = document.querySelector('#emailModal .modal-header h2');
            modalHeader.innerHTML = ` Investigation Review - ${result.moveReason === 'auto_safe' ? 'Auto-Approved' : result.moveReason === 'auto_learned' ? 'Auto-Learned' : 'IT Reviewed'}`;
            
            // Hide feedback buttons for history items
            const modalActions = document.querySelector('#emailModal .modal-actions');
            modalActions.innerHTML = `
                <div class="investigation-info">
                    <p><strong>Recipient:</strong> ${result.recipientEmail || 'Unknown'} (${result.recipientInfo ? result.recipientInfo.role : 'Unknown role'})</p>
                    <p><strong>Moved to History:</strong> ${new Date(result.movedToHistory).toLocaleString()}</p>
                    <p><strong>Final Status:</strong> ${result.moveReason === 'auto_safe' ? 'Auto-approved and delivered' : 
                                                       result.moveReason === 'auto_learned' ? 'Approved via pattern learning' :
                                                       result.feedback === 'correct' ? 'IT quarantined' : 'IT approved for delivery'}</p>
                    ${result.roleCheck && result.roleCheck.roleMismatch ? `<p><strong> Role Issue:</strong> ${result.roleCheck.reason}</p>` : ''}
                </div>
                <button class="modal-close-btn" onclick="closeModal()">Close Investigation</button>
            `;
            
            // Store result ID for potential reasoning report access
            document.getElementById('emailModal').dataset.resultId = resultId;
            
            // Show modal
            document.getElementById('emailModal').style.display = 'block';
        }

        function openHistoryReasoningReport(resultId) {
            // Find result in history
            const result = historyResults.find(r => r.id === resultId);
            if (!result || !result.reasoningReport) {
                console.error('History reasoning report not found for result ID:', resultId);
                return;
            }

            // Use existing reasoning report modal with history context
            const modal = document.getElementById('reasoningModal');
            const content = document.getElementById('reasoningModalContent');
            
            content.innerHTML = `
                <div class="reasoning-report-modal">
                    <div class="investigation-banner">
                        <h3> Historical Investigation Report</h3>
                        <p><strong>Final Outcome:</strong> ${result.moveReason === 'auto_safe' ? 'Auto-approved and delivered to recipient' : 
                                                           result.moveReason === 'auto_learned' ? 'Approved via pattern learning' :
                                                           result.feedback === 'correct' ? 'IT quarantined email' : 'IT approved and delivered email'}</p>
                        <p><strong>Processed:</strong> ${new Date(result.movedToHistory).toLocaleString()}</p>
                    </div>
                    
                    <div class="email-context">
                        <h3> Email Context</h3>
                        <div class="context-grid">
                            <div><strong>From:</strong> ${result.sender}</div>
                            <div><strong>To:</strong> ${result.recipientEmail || 'Unknown Recipient'}</div>
                            <div><strong>Subject:</strong> ${result.subject}</div>
                            <div><strong>AI Classification:</strong> <span class="classification ${result.classification.toLowerCase()}">${result.classification}</span></div>
                        </div>
                        ${result.recipientInfo ? `
                            <div class="recipient-details-modal">
                                <h4> Recipient Details</h4>
                                <div class="context-grid">
                                    <div><strong>Name:</strong> ${result.recipientInfo.name}</div>
                                    <div><strong>Role:</strong> ${result.recipientInfo.role.charAt(0).toUpperCase() + result.recipientInfo.role.slice(1)}</div>
                                    <div><strong>Department:</strong> ${result.recipientInfo.department}</div>
                                    <div><strong>User Status:</strong> ${result.recipientInfo.isKnownUser ? ' Known User' : ' Unknown User (Role Inferred)'}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> AI Analysis Summary</h4>
                        <p>${result.reasoningReport.summary}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Threat Indicators</h4>
                        ${result.reasoningReport.threatIndicators.length > 0 ? `
                            <ul>
                                ${result.reasoningReport.threatIndicators.map(indicator => `<li>${indicator}</li>`).join('')}
                            </ul>
                        ` : '<p class="no-threats">No specific threat indicators detected.</p>'}
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Role Analysis</h4>
                        <p>${result.reasoningReport.roleAnalysis}</p>
                    </div>
                    
                    <div class="reasoning-section">
                        <h4> Technical Findings</h4>
                        <ul>
                            ${result.reasoningReport.technicalFindings.map(finding => `<li>${finding}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="reasoning-section recommendation">
                        <h4> AI Recommendation</h4>
                        <p><strong>${result.reasoningReport.recommendation}</strong></p>
                    </div>
                    
                    ${result.feedback ? `
                        <div class="reasoning-section it-decision">
                            <h4> IT Decision</h4>
                            <p><strong>IT ${result.feedback === 'correct' ? 'Quarantined' : 'Approved'} this email</strong> 
                            ${result.feedback === 'correct' ? '(agreed with AI threat assessment)' : '(overrode AI assessment)'}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const emailModal = document.getElementById('emailModal');
            const reasoningModal = document.getElementById('reasoningModal');
            
            if (event.target === emailModal) {
                closeModal();
            } else if (event.target === reasoningModal) {
                closeReasoningModal();
            }
        }

        // Recalculate accuracy based on actual feedback
        function recalculateAccuracy() {
            // Count total emails that have been reviewed (have feedback)
            const totalReviewed = historyResults.filter(item => item.feedback).length;
            
            // Count correct predictions
            const correctPredictions = historyResults.filter(item => item.feedback === 'correct').length;
            
            // Update metrics
            agentMemory.performanceMetrics.correctPredictions = correctPredictions;
            
            if (totalReviewed > 0) {
                agentMemory.performanceMetrics.accuracyRate = (correctPredictions / totalReviewed) * 100;
            } else {
                agentMemory.performanceMetrics.accuracyRate = 0;
            }
            
            console.log(` Recalculated accuracy: ${correctPredictions}/${totalReviewed} = ${agentMemory.performanceMetrics.accuracyRate.toFixed(1)}%`);
            
            // Save updated metrics
            saveAgentMemory();
        }

        // Example email templates
        const exampleEmails = [
            {
                type: "Safe",
                sender: "hr@generalhospital.org",
                subject: "Staff Training Reminder - HIPAA Compliance",
                body: "Dear Healthcare Team, This is a reminder that our quarterly HIPAA compliance training session is scheduled for next Tuesday at 2 PM in Conference Room A. Please bring your employee ID and complete the pre-training questionnaire by Monday. Contact HR if you have any questions."
            },
            {
                type: "Suspicious",
                sender: "urgent@medical-alert.net",
                subject: "URGENT: Patient Database Maintenance Required",
                body: "We need to verify your patient database credentials immediately to prevent system lockout. Please click the link below to update your information. This is required for HIPAA compliance and system security. Failure to respond within 24 hours will result in account suspension."
            },
            {
                type: "Phishing",
                sender: "security@hospital-security.com",
                subject: "HIPAA Violation Alert - Immediate Action Required",
                body: "Your account has been flagged for HIPAA violations. Click this link immediately to avoid legal action and account suspension. Your access will be terminated in 2 hours if you don't verify your identity. This is your final warning."
            },
            {
                type: "Suspicious",
                sender: "billing@medicare-updates.org",
                subject: "Medicare Reimbursement Changes",
                body: "Important changes to Medicare billing procedures require immediate attention. Click here to download the new billing software and update your patient records. This update is mandatory for all healthcare providers to maintain compliance."
            },
            {
                type: "Safe",
                sender: "noreply@hospital.org",
                subject: "Monthly Staff Meeting Reminder",
                body: "Dear Staff, This is a reminder about our monthly staff meeting scheduled for next Friday at 2 PM in the main conference room. Please confirm your attendance by replying to this email."
            },
            {
                type: "Phishing",
                sender: "admin@healthcare-emergency.net",
                subject: "URGENT: Medical Records Compromise Detected",
                body: "We have detected unauthorized access to your medical records system. Click here immediately to secure your account and prevent data breach. Your patient information is at risk. Respond within 30 minutes or face legal consequences."
            }
        ];

        // Pre-written test email examples
        const testEmails = {
            safe1: {
                recipient: 'dr.smith@generalhospital.org',
                sender: 'hr@generalhospital.org',
                subject: 'Monthly Staff Meeting Reminder',
                body: `Dear Dr. Smith,

This is a friendly reminder about our monthly staff meeting scheduled for next Friday, December 15th at 2:00 PM in the main conference room.

Agenda items include:
- Q4 Performance Review Updates
- New HIPAA Compliance Procedures
- Holiday Schedule Announcements
- Equipment Maintenance Schedule

Please confirm your attendance by replying to this email by Wednesday. Coffee and light refreshments will be provided.

Best regards,
Human Resources Team
General Hospital`
            },
            safe2: {
                recipient: 'nurse.johnson@memorialmedical.org',
                sender: 'compliance@memorialmedical.org',
                subject: 'URGENT: HIPAA Training Completion Required',
                body: `Dear Nurse Johnson,

This is an urgent reminder that your HIPAA compliance training must be completed by this Friday, December 8th, to maintain your active status.

Our records show that your annual HIPAA training is overdue. This is a mandatory requirement for all healthcare staff and must be completed immediately to avoid any compliance issues.

Please log into the staff portal at your earliest convenience and complete the 30-minute training module. The training covers:
- Patient privacy protection
- Data handling procedures
- Breach reporting protocols
- Recent regulation updates

Failure to complete this training may result in temporary suspension of system access.

Please contact the compliance department if you have any questions.

Compliance Department
Memorial Medical Center`
            },
            suspicious1: {
                recipient: 'admin.wilson@cityhealthclinic.org',
                sender: 'it-support@external-service.com',
                subject: 'Unusual System Access Request',
                body: `Hello Admin Wilson,

I'm writing from IT Support regarding an unusual access request we received for your clinic's patient database system.

Someone claiming to be from your clinic requested elevated access to patient records, citing "emergency medical research needs." However, the request came from an external email address and didn't follow our standard verification procedures.

Could you please confirm if this request is legitimate? The requestor provided the following details:
- Name: Dr. Sarah Martinez
- Email: smartinez@research-partners.com
- Request: Full patient database access for "critical research project"
- Timeline: Immediate access needed

This seems unusual as Dr. Martinez is not listed in your staff directory, and research access typically requires formal approval through proper channels.

Please advise if this is a legitimate request or if we should deny access.

IT Support Team`
            },
            suspicious2: {
                recipient: 'manager.davis@communitymedical.org',
                sender: 'executive@communitymedical.org',
                subject: 'URGENT: Immediate Policy Change Required',
                body: `Manager Davis,

URGENT: We need to implement an immediate policy change regarding patient data sharing due to a regulatory compliance issue discovered this morning.

Effective immediately, all patient information must be shared with our new research partner, MedData Analytics, for "quality improvement purposes." This is a temporary measure while we resolve the compliance issue.

Action Required:
1. Grant access to patient databases to meddata@external-research.org
2. Share all patient records from the last 6 months
3. Provide administrative credentials for their research team
4. Do not inform patients about this data sharing

This is urgent and must be completed by end of business today. Failure to comply may result in regulatory penalties.

Please confirm completion immediately.

Executive Office
Community Medical`
            },
            phishing1: {
                recipient: 'coordinator.taylor@universitymedical.org',
                sender: 'security-alert@universitymedical-security.com',
                subject: 'Your Account Will Be Suspended - Action Required',
                body: `Dear Coordinator Taylor,

We have detected suspicious activity on your University Medical Center account. Your access will be suspended within 24 hours unless you verify your identity immediately.

Security Alert Details:
- Multiple failed login attempts detected
- Unusual access from foreign IP addresses
- Potential data breach in progress

To prevent account suspension, please click the link below and verify your credentials:

[VERIFY ACCOUNT NOW] - Click here to secure your account

If you do not verify your account within 24 hours:
- Your account will be permanently suspended
- All patient data access will be revoked
- Legal action may be taken

This is your final warning. Do not ignore this message.

Security Department
University Medical Center`
            },
            phishing2: {
                recipient: 'specialist.garcia@stmaryshospital.org',
                sender: 'emergency-response@hospital-security.org',
                subject: 'EMERGENCY: Critical Security Breach Detected',
                body: `EMERGENCY ALERT - Specialist Garcia

CRITICAL SECURITY BREACH DETECTED: Our hospital systems have been compromised by a sophisticated cyber attack. Patient data is at immediate risk of exposure.

EMERGENCY ACTION REQUIRED:
- Click here immediately to secure your account
- Enter your login credentials to activate emergency protocols
- Provide your social security number for identity verification
- Download our emergency security patch

The breach is spreading rapidly. Every second counts. Failure to act immediately may result in:
- Complete patient data exposure
- HIPAA violation penalties
- Personal liability for data breaches
- Immediate termination

This is a genuine emergency. Do not delay.

Emergency Response Team
St. Mary's Hospital Security`
            }
        };

        function selectTestEmail(emailKey) {
            const email = testEmails[emailKey];
            if (!email) {
                console.error('Test email not found:', emailKey);
                return;
            }

            // Fill the form fields
            document.getElementById('recipientEmail').value = email.recipient;
            document.getElementById('sender').value = email.sender;
            document.getElementById('subject').value = email.subject;
            document.getElementById('body').value = email.body;

            // Update recipient info display
            updateRecipientInfo();

            // Add visual feedback
            const inputs = ['recipientEmail', 'sender', 'subject', 'body'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                element.style.backgroundColor = '#f0f9ff';
                element.style.borderColor = '#38a169';
                
                setTimeout(() => {
                    element.style.backgroundColor = '';
                    element.style.borderColor = '';
                }, 2000);
            });

            console.log(` Selected test email: ${emailKey}`);
        }

        async function generateExample() {
            if (!openrouterApiKey) {
                alert('OpenRouter API key not configured. Please ensure OPENROUTER_API_KEY is set in environment variables.');
                return;
            }

            const exampleBtn = document.querySelector('.example-btn');
            const originalText = exampleBtn.innerHTML;
            
            // Show loading state
            exampleBtn.disabled = true;
            exampleBtn.innerHTML = ' Generating...';
            
            try {
                // Generate a real-time email using AI
                const generatedEmail = await generateRealTimeEmail(openrouterApiKey);
                
                // Fill the form fields
                document.getElementById('recipientEmail').value = generatedEmail.recipient || '';
                document.getElementById('sender').value = generatedEmail.sender;
                document.getElementById('subject').value = generatedEmail.subject;
                document.getElementById('body').value = generatedEmail.body;
                
                // Add a subtle highlight to show it was generated
                const inputs = ['recipientEmail', 'sender', 'subject', 'body'];
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    element.style.backgroundColor = '#f0f9ff';
                    element.style.borderColor = '#38a169';
                    
                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                        element.style.borderColor = '';
                    }, 2000);
                });
                
                console.log(` Generated unique email #${generationCounter}:`, generatedEmail.type, 'from', randomHospital, randomDept);
                
            } catch (error) {
                console.error('Error generating email:', error);
                // Fallback to template if AI generation fails
                const randomExample = exampleEmails[Math.floor(Math.random() * exampleEmails.length)];
                document.getElementById('recipientEmail').value = 'dr.smith@generalhospital.org'; // Default recipient
                document.getElementById('sender').value = randomExample.sender;
                document.getElementById('subject').value = randomExample.subject;
                document.getElementById('body').value = randomExample.body;
            } finally {
                // Restore button state
                exampleBtn.disabled = false;
                exampleBtn.innerHTML = originalText;
            }
        }

        async function generateRealTimeEmail(apiKey) {
            const emailTypes = ['Safe', 'Suspicious', 'Phishing'];
            
            // Avoid generating the same type consecutively for more variety
            let availableTypes = emailTypes.filter(type => type !== lastGeneratedType);
            if (availableTypes.length === 0) availableTypes = emailTypes; // Fallback if all types were used
            
            const randomType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            lastGeneratedType = randomType;
            generationCounter++;
            
            // Add randomization elements for more uniqueness
            const hospitalNames = ['General Hospital', 'Memorial Medical Center', 'City Health Clinic', 'Regional Hospital', 'Community Medical', 'University Medical Center', 'St. Mary\'s Hospital', 'Children\'s Hospital'];
            const departments = ['IT', 'HR', 'Administration', 'Security', 'Billing', 'Medical Records', 'Compliance', 'Emergency Services', 'Pharmacy', 'Laboratory'];
            const roles = ['Administrator', 'Manager', 'Director', 'Coordinator', 'Specialist', 'Supervisor', 'Officer', 'Representative'];
            const timeframes = ['immediately', 'within 24 hours', 'by end of week', 'urgently', 'as soon as possible', 'today', 'this afternoon', 'by tomorrow'];
            
            const randomHospital = hospitalNames[Math.floor(Math.random() * hospitalNames.length)];
            const randomDept = departments[Math.floor(Math.random() * departments.length)];
            const randomRole = roles[Math.floor(Math.random() * roles.length)];
            const randomTime = timeframes[Math.floor(Math.random() * timeframes.length)];
            
            // Add timestamp and random elements for uniqueness
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 8);
            
            // Add recipient variety
            const recipientTypes = [
                'dr.johnson@generalhospital.org',
                'nurse.smith@memorialmedical.org', 
                'admin.wilson@cityhealthclinic.org',
                'dr.brown@regionalhospital.org',
                'manager.davis@communitymedical.org',
                'coordinator.taylor@universitymedical.org',
                'specialist.garcia@stmaryshospital.org',
                'director.martinez@childrenshospital.org'
            ];
            const randomRecipient = recipientTypes[Math.floor(Math.random() * recipientTypes.length)];

            const prompt = `Generate a unique, realistic healthcare email that would be classified as "${randomType}". 

Context: ${randomHospital} - ${randomDept} Department
Sender Role: ${randomRole}
Recipient: ${randomRecipient}
Urgency: ${randomTime}
Generation #${generationCounter}
Unique ID: ${randomId}
Timestamp: ${timestamp}

Requirements:
- Make it completely unique and different from typical examples
- Include specific healthcare details, terminology, and context for ${randomHospital}
- Use realistic sender domains and professional language
- Address the email appropriately to the recipient: ${randomRecipient}
- For Safe: Normal hospital communications (schedules, reminders, announcements, policy updates, training notifications)
- For Suspicious: Unusual requests that might be legitimate but raise questions (access requests, data sharing, policy changes)
- For Phishing: Clear malicious intent targeting healthcare workers/patients (credential theft, fake alerts, urgent actions)

Be creative and avoid common patterns. Make each email feel like a real, unique communication.

Respond ONLY with this JSON format:
{
  "type": "${randomType}",
  "sender": "realistic.email@domain.com",
  "recipient": "${randomRecipient}",
  "subject": "Unique realistic subject line",
  "body": "Detailed unique email body content"
}

Make the email detailed, believable, and completely unique.`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'Healthcare Email Defense Demo'
                },
                body: JSON.stringify({
                    model: 'microsoft/wizardlm-2-8x22b:free',
                    max_tokens: 300,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ]
                })
            });

            console.log('API Response status:', response.status);
            console.log('API Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error response:', errorText);
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            
            try {
                // Try to parse JSON response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    return {
                        type: result.type,
                        sender: result.sender,
                        subject: result.subject,
                        body: result.body
                    };
                } else {
                    throw new Error('No JSON found in response');
                }
            } catch (parseError) {
                console.warn('Failed to parse AI response, using fallback');
                throw new Error('Failed to parse generated email');
            }
        }

        // Initialize display
        updateResultsDisplay();
        updateHistoryDisplay();
        
        // Initialize dashboard as default tab
        document.addEventListener('DOMContentLoaded', function() {
            // Update dashboard on page load
            updateDashboard();
            
            // Update agent status display
            updateAgentStatus();
        });
    </script>
</body>
</html>
