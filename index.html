<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Email Defense Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .input-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .input-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
        }

        .analyze-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .example-btn {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 30px;
        }

        .results-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .results-table tr:hover {
            background: #f8fafc;
        }

        .classification {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .classification.safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .classification.suspicious {
            background: #fef5e7;
            color: #744210;
        }

        .classification.phishing {
            background: #fed7d7;
            color: #742a2a;
        }

        .confidence {
            font-weight: 600;
            color: #2d3748;
        }

        .ai-comment {
            font-style: italic;
            color: #718096;
            max-width: 300px;
        }

        .feedback-section {
            margin-top: 10px;
        }

        .review-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            width: 100%;
        }

        .review-btn:hover {
            background: #5a67d8;
        }


        .feedback-buttons {
            display: flex;
            gap: 10px;
        }

        .feedback-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .feedback-btn.correct {
            border-color: #38a169;
            color: #38a169;
        }

        .feedback-btn.correct:hover {
            background: #38a169;
            color: white;
        }

        .feedback-btn.incorrect {
            border-color: #e53e3e;
            color: #e53e3e;
        }

        .feedback-btn.incorrect:hover {
            background: #e53e3e;
            color: white;
        }

        .feedback-btn.selected {
            color: white;
        }

        .feedback-btn.selected.correct {
            background: #38a169;
            border-color: #38a169;
        }

        .feedback-btn.selected.incorrect {
            background: #e53e3e;
            border-color: #e53e3e;
        }

        .no-results {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 40px;
        }

        .agent-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .agent-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .agent-status h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .refresh-stats-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .refresh-stats-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .agent-controls {
            display: flex;
            gap: 8px;
        }

        .clear-history-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .clear-history-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            transform: scale(1.05);
        }


        .last-updated {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
            font-style: italic;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .status-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .agent-actions {
            margin-top: 8px;
        }

        .agent-action {
            display: inline-block;
            background: #fef5e7;
            color: #744210;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 3px;
        }

        .agent-action.quarantine {
            background: #fed7d7;
            color: #742a2a;
        }

        .agent-action.escalate {
            background: #fef5e7;
            color: #744210;
        }

        .agent-action.pattern_based {
            background: #c6f6d5;
            color: #22543d;
        }

        .learning-indicator {
            color: #38a169;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .security-details {
            margin-top: 5px;
            padding: 5px;
            background: #f7fafc;
            border-radius: 4px;
            border-left: 3px solid #e53e3e;
        }

        .security-details small {
            color: #4a5568;
            font-size: 0.8rem;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .history-table {
            font-size: 14px;
        }

        .history-table th,
        .history-table td {
            padding: 12px 8px;
        }

        .history-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .history-status.auto_safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .history-status.auto_learned {
            background: #e6fffa;
            color: #234e52;
        }

        .history-status.reviewed {
            background: #bee3f8;
            color: #2a69ac;
        }

        .moved-time {
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 25px;
        }

        .email-details {
            margin-bottom: 25px;
        }

        .email-field {
            margin-bottom: 15px;
        }

        .field-label {
            font-weight: 600;
            color: #4a5568;
            display: block;
            margin-bottom: 5px;
        }

        .email-value {
            background: #f7fafc;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            word-break: break-all;
        }

        .email-body {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .analysis-details {
            margin-bottom: 25px;
        }

        .analysis-details h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .analysis-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .analysis-item .field-label {
            font-weight: 600;
            color: #4a5568;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .analysis-item span {
            color: #2d3748;
            font-size: 0.95rem;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .modal-close-btn {
            background: #718096;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-close-btn:hover {
            background: #4a5568;
        }



        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .results-table {
                font-size: 14px;
            }

            .results-table th,
            .results-table td {
                padding: 10px 8px;
            }

            .ai-comment {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Healthcare Email Defense Agent</h1>
            <p>AI-Powered Email Security Analysis for Healthcare Organizations</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>📧 Email Analysis</h2>
                

                <div class="form-group">
                    <label for="sender">Sender Email:</label>
                    <input type="text" id="sender" placeholder="e.g., admin@hospital.com">
                </div>

                <div class="form-group">
                    <label for="subject">Subject:</label>
                    <input type="text" id="subject" placeholder="Email subject line">
                </div>

                <div class="form-group">
                    <label for="body">Email Body:</label>
                    <textarea id="body" placeholder="Paste the email content here..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="analyze-btn" onclick="analyzeEmail()">🔍 Analyze Email</button>
                    <button class="example-btn" onclick="generateExample()">🎲 Generate Example</button>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing email with AI...</p>
                </div>
            </div>

            <div class="results-section">
                <h2>📊 Analysis Results</h2>
                <div id="results-container">
                    <div class="no-results">
                        No emails analyzed yet. Submit an email above to see results.
                    </div>
                </div>
            </div>

            <div class="history-section">
                <h2>📋 History Log</h2>
                <div id="history-container">
                    <div class="no-results">
                        No emails in history yet. Reviewed emails and safe emails will appear here.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Review Modal -->
    <div id="emailModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📧 Email Review</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="email-details">
                    <div class="email-field">
                        <div class="field-label">From:</div>
                        <div class="email-value" id="modalSender"></div>
                    </div>
                    <div class="email-field">
                        <div class="field-label">Subject:</div>
                        <div class="email-value" id="modalSubject"></div>
                    </div>
                    <div class="email-field">
                        <div class="field-label">Body:</div>
                        <div class="email-body" id="modalBody"></div>
                    </div>
                </div>
                
                <div class="analysis-details">
                    <h3>🔍 AI Analysis</h3>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="field-label">Classification:</div>
                            <span id="modalClassification"></span>
                        </div>
                        <div class="analysis-item">
                            <div class="field-label">Confidence:</div>
                            <span id="modalConfidence"></span>
                        </div>
                        <div class="analysis-item">
                            <div class="field-label">Threat Score:</div>
                            <span id="modalThreatScore"></span>
                        </div>
                        <div class="analysis-item">
                            <div class="field-label">AI Comment:</div>
                            <span id="modalComment"></span>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="feedback-btn correct" onclick="setFeedbackFromModal('correct')">
                        ✓ Correct
                    </button>
                    <button class="feedback-btn incorrect" onclick="setFeedbackFromModal('incorrect')">
                        ✗ Incorrect
                    </button>
                    <button class="modal-close-btn" onclick="closeModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisResults = [];
        let historyResults = [];
        let openrouterApiKey = '';
        let generationCounter = 0;
        let lastGeneratedType = null;
        
        // Agentic capabilities - persistent memory and learning
        let agentMemory = {
            learnedPatterns: {},
            feedbackHistory: [],
            threatIntelligence: {},
            performanceMetrics: {
                totalAnalyzed: 0,
                correctPredictions: 0,
                accuracyRate: 0,
                phishingCaught: 0,
                falsePositives: 0,
                securityThreatsBlocked: 0,
                highThreatEmails: 0
            },
            autoActions: {
                quarantineThreshold: 85,
                escalationThreshold: 90,
                autoQuarantineEnabled: true
            }
        };

        // Load API key from server on page load
        async function loadApiKey() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                openrouterApiKey = config.openrouterApiKey;
                
                console.log('API key loaded:', openrouterApiKey ? 'Yes' : 'No');
                console.log('API key length:', openrouterApiKey ? openrouterApiKey.length : 0);
                if (!openrouterApiKey) {
                    console.error('No API key found! Make sure OPENROUTER_API_KEY is set in .env file');
                }
                
                // Hide API key section if key is available
                if (openrouterApiKey) {
                    const apiKeySection = document.querySelector('.api-key-section');
                    apiKeySection.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading API key:', error);
                console.log('Running in static mode - API key must be entered manually');
            }
        }

        // Load API key and agent memory when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadAgentMemory();
            recalculateAccuracy(); // Fix any existing accuracy calculations
            updateResultsDisplay(); // Make sure to update displays
            updateHistoryDisplay();
            updateAgentStatus();
        });

        // Load agent memory from localStorage
        function loadAgentMemory() {
            const saved = localStorage.getItem('healthcareAgentMemory');
            if (saved) {
                agentMemory = { ...agentMemory, ...JSON.parse(saved) };
                console.log('Agent memory loaded:', agentMemory);
            }
            
            // Load history results
            const savedHistory = localStorage.getItem('healthcareHistoryResults');
            if (savedHistory) {
                historyResults = JSON.parse(savedHistory);
                console.log('History results loaded:', historyResults.length, 'items');
            }
            
            // Load active review results
            const savedActiveResults = localStorage.getItem('healthcareActiveResults');
            if (savedActiveResults) {
                analysisResults = JSON.parse(savedActiveResults);
                console.log('Active review results loaded:', analysisResults.length, 'items');
            }
        }

        // Save agent memory to localStorage
        function saveAgentMemory() {
            localStorage.setItem('healthcareAgentMemory', JSON.stringify(agentMemory));
            localStorage.setItem('healthcareHistoryResults', JSON.stringify(historyResults));
            localStorage.setItem('healthcareActiveResults', JSON.stringify(analysisResults));
        }

        async function analyzeEmail() {
            const sender = document.getElementById('sender').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('body').value.trim();

            if (!openrouterApiKey) {
                alert('OpenRouter API key not configured. Please ensure OPENROUTER_API_KEY is set in environment variables.');
                return;
            }

            if (!sender || !subject || !body) {
                alert('Please fill in all fields: sender, subject, and email body.');
                return;
            }

            const analyzeBtn = document.querySelector('.analyze-btn');
            const loading = document.getElementById('loading');

            analyzeBtn.disabled = true;
            loading.style.display = 'block';

            try {
                // Multi-step agentic analysis
                const result = await performAgenticAnalysis(openrouterApiKey, sender, subject, body);
                
                // Add to results array
                const analysisResult = {
                    id: Date.now(),
                    sender: sender,
                    subject: subject,
                    body: body,
                    classification: result.classification,
                    confidence: result.confidence,
                    comment: result.comment,
                    feedback: null,
                    timestamp: new Date().toLocaleString(),
                    agentActions: result.agentActions || [],
                    learningApplied: result.learningApplied || false,
                    threatIntel: result.threatIntel || null
                };
                
                analysisResults.unshift(analysisResult);
                
                // Update agent performance metrics
                agentMemory.performanceMetrics.totalAnalyzed++;
                
                // Track security metrics
                if (result.classification === 'Phishing') {
                    agentMemory.performanceMetrics.phishingCaught++;
                }
                if (result.threatIntel && result.threatIntel.threatLevel === 'HIGH') {
                    agentMemory.performanceMetrics.highThreatEmails++;
                }
                if (result.threatIntel && result.threatIntel.threatScore > 0) {
                    agentMemory.performanceMetrics.securityThreatsBlocked++;
                }
                
                // Only auto-move safe emails - learned patterns still need review for safety
                if (result.classification === 'Safe') {
                    // Safe emails always auto-move
                    moveToHistory(analysisResult, 'auto_safe');
                }
                // Note: Suspicious/Phishing emails with learned patterns still require manual review
                // This follows the "fail-safe default" principle - unsure? -> quarantine for review
                
                saveAgentMemory();

                // Update display
                updateResultsDisplay();
                updateHistoryDisplay();
                updateAgentStatus();
                
                // Save active results to persist review queue
                saveAgentMemory();
                
                // Clear form
                document.getElementById('sender').value = '';
                document.getElementById('subject').value = '';
                document.getElementById('body').value = '';

            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error analyzing email: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // Multi-step agentic analysis with learning and autonomous actions
        async function performAgenticAnalysis(apiKey, sender, subject, body) {
            console.log('🤖 Agent starting multi-step analysis...');
            
            // Step 1: Pattern Recognition - Check learned patterns
            const patternMatch = checkLearnedPatterns(sender, subject, body);
            console.log('📊 Pattern recognition result:', patternMatch);
            
            // Step 2: Threat Intelligence Check
            const threatIntel = await checkThreatIntelligence(sender, subject, body);
            console.log('🔍 Threat intelligence result:', threatIntel);
            
            // Step 3: AI Analysis with context
            const aiResult = await analyzeWithAI(apiKey, sender, subject, body, patternMatch, threatIntel);
            console.log('🧠 AI analysis result:', aiResult);
            
            // Step 4: Autonomous Decision Making
            const agentActions = determineAutonomousActions(aiResult, patternMatch, threatIntel);
            console.log('⚡ Autonomous actions:', agentActions);
            
            // Step 5: Apply Learning Context
            const learningApplied = applyLearnedContext(aiResult, patternMatch);
            
            return {
                ...aiResult,
                agentActions,
                learningApplied,
                patternMatch,
                threatIntel
            };
        }

        // Check learned patterns from previous feedback
        function checkLearnedPatterns(sender, subject, body) {
            const emailHash = generateEmailHash(sender, subject, body);
            
            // Check for exact matches
            if (agentMemory.learnedPatterns[emailHash]) {
                return {
                    type: 'exact_match',
                    confidence: 95,
                    classification: agentMemory.learnedPatterns[emailHash].classification,
                    reason: 'Previously analyzed email'
                };
            }
            
            // Check for sender patterns
            const senderPattern = agentMemory.learnedPatterns[`sender:${sender}`];
            if (senderPattern && senderPattern.count > 2) {
                return {
                    type: 'sender_pattern',
                    confidence: Math.min(85, 60 + (senderPattern.count * 5)),
                    classification: senderPattern.classification,
                    reason: `Known ${senderPattern.classification.toLowerCase()} sender (${senderPattern.count} instances)`
                };
            }
            
            // Check for subject patterns
            const subjectKeywords = extractKeywords(subject);
            for (const keyword of subjectKeywords) {
                const keywordPattern = agentMemory.learnedPatterns[`keyword:${keyword}`];
                if (keywordPattern && keywordPattern.count > 1) {
                    return {
                        type: 'keyword_pattern',
                        confidence: Math.min(75, 50 + (keywordPattern.count * 10)),
                        classification: keywordPattern.classification,
                        reason: `Known ${keywordPattern.classification.toLowerCase()} keyword pattern`
                    };
                }
            }
            
            return null;
        }

        // Enhanced threat intelligence check with security analysis
        async function checkThreatIntelligence(sender, subject, body) {
            const domain = sender.split('@')[1];
            
            // 1. Domain Analysis
            const suspiciousDomains = ['medical-alert.net', 'hospital-security.com', 'healthcare-emergency.net', 'medicare-updates.org'];
            const isSuspiciousDomain = suspiciousDomains.includes(domain);
            
            // 2. Link Analysis (simulated)
            const links = extractLinks(body);
            const suspiciousLinks = links.filter(link => {
                return link.includes('h0spital') || // Lookalike domains
                       link.includes('hospita1') ||
                       link.includes('medica1') ||
                       link.includes('bit.ly') || // Shortened URLs
                       link.includes('tinyurl');
            });
            
            // 3. Header Analysis (simulated)
            const headerAnalysis = analyzeHeaders(sender, subject);
            
            // 4. Content Analysis
            const bodyLower = body.toLowerCase();
            const phishingKeywords = ['urgent', 'immediately', 'click here', 'verify', 'suspended', 'violation', 'compromise', 'breach'];
            const phishingScore = phishingKeywords.filter(keyword => bodyLower.includes(keyword)).length;
            
            // 5. MIME/Attachment Analysis (simulated)
            const attachmentAnalysis = analyzeAttachments(body);
            
            // 6. Threat Level Calculation
            let threatScore = 0;
            if (isSuspiciousDomain) threatScore += 40;
            if (suspiciousLinks.length > 0) threatScore += 30;
            if (headerAnalysis.spoofing) threatScore += 25;
            if (phishingScore > 2) threatScore += 20;
            if (attachmentAnalysis.suspicious) threatScore += 15;
            
            const threatLevel = threatScore >= 70 ? 'HIGH' : threatScore >= 40 ? 'MEDIUM' : 'LOW';
            
            return {
                suspiciousDomain: isSuspiciousDomain,
                phishingScore,
                suspiciousLinks: suspiciousLinks.length,
                headerIssues: headerAnalysis.issues,
                attachmentIssues: attachmentAnalysis.issues,
                threatScore,
                threatLevel,
                confidence: Math.min(95, threatScore + 10)
            };
        }

        // Extract links from email body
        function extractLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.match(urlRegex) || [];
        }

        // Analyze email headers for spoofing
        function analyzeHeaders(sender, subject) {
            const issues = [];
            let spoofing = false;
            
            // Check for suspicious sender patterns
            if (sender.includes('noreply') && subject.toLowerCase().includes('urgent')) {
                issues.push('Urgent subject from noreply sender');
                spoofing = true;
            }
            
            // Check for suspicious domains
            const suspiciousPatterns = ['@gmail.com', '@yahoo.com', '@hotmail.com'];
            if (suspiciousPatterns.some(pattern => sender.includes(pattern)) && subject.toLowerCase().includes('hospital')) {
                issues.push('Personal email claiming to be from hospital');
                spoofing = true;
            }
            
            return { issues, spoofing };
        }

        // Analyze attachments (simulated)
        function analyzeAttachments(text) {
            const issues = [];
            let suspicious = false;
            
            // Look for attachment mentions
            const attachmentKeywords = ['attachment', 'document', 'file', '.exe', '.zip', '.pdf'];
            const hasAttachments = attachmentKeywords.some(keyword => text.toLowerCase().includes(keyword));
            
            if (hasAttachments && text.toLowerCase().includes('password')) {
                issues.push('Password-protected attachment');
                suspicious = true;
            }
            
            if (text.toLowerCase().includes('macro') || text.toLowerCase().includes('enable content')) {
                issues.push('Macro-enabled document');
                suspicious = true;
            }
            
            return { issues, suspicious };
        }

        // Determine autonomous actions based on analysis
        function determineAutonomousActions(aiResult, patternMatch, threatIntel) {
            const actions = [];
            
            // Auto-quarantine high-confidence phishing
            if (aiResult.classification === 'Phishing' && aiResult.confidence >= agentMemory.autoActions.quarantineThreshold) {
                actions.push({
                    type: 'quarantine',
                    reason: `High-confidence phishing (${aiResult.confidence}%)`,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Escalate high-threat situations
            if (threatIntel.threatLevel === 'HIGH' || aiResult.confidence >= agentMemory.autoActions.escalationThreshold) {
                actions.push({
                    type: 'escalate',
                    reason: 'High threat level detected',
                    timestamp: new Date().toISOString()
                });
            }
            
            // Apply pattern-based actions
            if (patternMatch && patternMatch.confidence > 80) {
                actions.push({
                    type: 'pattern_based',
                    reason: patternMatch.reason,
                    timestamp: new Date().toISOString()
                });
            }
            
            return actions;
        }

        // Apply learned context to improve analysis
        function applyLearnedContext(aiResult, patternMatch) {
            let learningApplied = false;
            
            if (patternMatch && patternMatch.confidence > 70) {
                // Boost confidence if pattern matches
                aiResult.confidence = Math.min(95, aiResult.confidence + 10);
                aiResult.comment = `[Learning Applied] ${aiResult.comment}`;
                learningApplied = true;
                
                // For exact matches with high confidence, use the learned classification
                if (patternMatch.type === 'exact_match' && patternMatch.confidence >= 95) {
                    aiResult.classification = patternMatch.classification;
                    aiResult.confidence = patternMatch.confidence;
                    aiResult.comment = `[Auto-Classified] Previously analyzed: ${patternMatch.classification}`;
                }
            }
            
            return learningApplied;
        }

        // Helper functions
        function generateEmailHash(sender, subject, body) {
            return btoa(sender + subject + body).substring(0, 16);
        }

        function extractKeywords(text) {
            return text.toLowerCase().split(/\W+/).filter(word => word.length > 3);
        }

        async function analyzeWithAI(apiKey, sender, subject, body, patternMatch = null, threatIntel = null) {
            const emailContent = `Subject: ${subject}\nFrom: ${sender}\n\n${body}`;
            
            const prompt = `You are a healthcare email security analyst. Analyze this email and respond with ONLY valid JSON.

Email:
Subject: ${subject}
From: ${sender}
Body: ${body}

IMPORTANT: Respond with ONLY this exact JSON format (no other text):
{
  "classification": "Safe",
  "confidence": 75,
  "comment": "Brief explanation"
}

Classification rules:
- "Safe": Legitimate healthcare communications, normal business emails
- "Suspicious": Unusual requests, unclear sources, potentially harmful
- "Phishing": Clear malicious intent, fake urgency, credential theft attempts

Confidence: Use realistic scores (50-95). Higher confidence for clearer threats.
Comment: Brief 1-2 sentence explanation of your decision.

Respond with ONLY the JSON object:`;

            console.log('Making API request to OpenRouter...');
            console.log('Using model: alibaba/tongyi-deepresearch-30b-a3b:free');
            
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'Healthcare Email Defense Demo'
                },
                body: JSON.stringify({
                    model: 'alibaba/tongyi-deepresearch-30b-a3b:free',
                    max_tokens: 200,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ]
                })
            });

            console.log('API Response status:', response.status);
            console.log('API Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error response:', errorText);
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            
            try {
                // Clean the response content
                const cleanContent = content.trim();
                console.log('AI Response:', cleanContent);
                
                // Try multiple JSON extraction methods
                let result;
                let jsonString = cleanContent;
                
                // Method 1: Try parsing the entire response
                try {
                    result = JSON.parse(jsonString);
                } catch {
                    // Method 2: Extract JSON using regex
                    const jsonMatch = jsonString.match(/\{[\s\S]*?\}/);
                    if (jsonMatch) {
                        try {
                            result = JSON.parse(jsonMatch[0]);
                        } catch {
                            // Method 3: Try to find JSON between backticks or code blocks
                            const codeBlockMatch = jsonString.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                            if (codeBlockMatch) {
                                result = JSON.parse(codeBlockMatch[1]);
                            } else {
                                throw new Error('No valid JSON found');
                            }
                        }
                    } else {
                        throw new Error('No JSON pattern found');
                    }
                }
                
                console.log('Parsed result:', result);
                
                // Validate and normalize the result structure
                if (result && typeof result === 'object') {
                    const classification = result.classification || 'Suspicious';
                    const confidence = Math.round(Number(result.confidence) || 70);
                    const comment = result.comment || 'Analysis completed';
                    
                    // Ensure classification is one of the valid values
                    const validClassifications = ['Safe', 'Suspicious', 'Phishing'];
                    const finalClassification = validClassifications.includes(classification) 
                        ? classification 
                        : 'Suspicious';
                    
                    // Ensure confidence is within reasonable bounds
                    const finalConfidence = Math.max(50, Math.min(95, confidence));
                    
                    return {
                        classification: finalClassification,
                        confidence: finalConfidence,
                        comment: comment
                    };
                } else {
                    throw new Error('Invalid result structure');
                }
            } catch (parseError) {
                console.warn('Failed to parse AI response:', parseError);
                console.log('Raw response:', content);
                
                // Improved fallback parsing - analyze the email content directly
                const lowerContent = content.toLowerCase();
                const emailLower = emailContent.toLowerCase();
                let classification = 'Suspicious';
                let confidence = 70;
                let comment = 'AI analysis completed - manual review recommended';
                
                // Analyze email content for threat indicators
                const phishingKeywords = ['urgent', 'immediately', 'click here', 'verify account', 'suspended', 'violation', 'compromise', 'breach', 'password expired', 'account locked', 'click here', 'verify now', 'action required', 'account suspended'];
                const safeKeywords = ['appointment', 'schedule', 'medical', 'patient', 'doctor', 'nurse', 'hospital', 'clinic', 'treatment', 'prescription', 'hipaa', 'compliance', 'training', 'reminder', 'policy', 'staff', 'internal', 'meeting', 'conference'];
                
                // Check for legitimate hospital/healthcare domains
                const legitimateDomains = ['generalhospital.org', 'hospital.org', 'clinic.org', 'medical.org', 'healthcare.org', '.gov', '.edu'];
                const isLegitimateDomain = legitimateDomains.some(domain => sender.toLowerCase().includes(domain));
                
                const phishingScore = phishingKeywords.filter(keyword => emailLower.includes(keyword)).length;
                const safeScore = safeKeywords.filter(keyword => emailLower.includes(keyword)).length;
                
                // Determine classification based on content analysis
                // Priority 1: Legitimate domains with healthcare content
                if (isLegitimateDomain && (safeScore >= 1 || emailLower.includes('hipaa') || emailLower.includes('training') || emailLower.includes('compliance'))) {
                    classification = 'Safe';
                    confidence = Math.max(80, 85 + safeScore * 2);
                    comment = 'Legitimate healthcare domain with appropriate content';
                }
                // Priority 2: Clear phishing indicators
                else if (phishingScore >= 2 || emailLower.includes('phishing') || emailLower.includes('malicious')) {
                    classification = 'Phishing';
                    confidence = Math.min(95, 75 + (phishingScore * 5));
                    comment = 'Multiple threat indicators detected';
                }
                // Priority 3: Strong safe indicators
                else if (safeScore >= 2 && phishingScore === 0) {
                    classification = 'Safe';
                    confidence = Math.max(70, 80 - (safeScore * 2));
                    comment = 'Appears to be legitimate healthcare communication';
                }
                // Priority 4: AI explicitly marked as safe
                else if (lowerContent.includes('safe') && !lowerContent.includes('not safe')) {
                    classification = 'Safe';
                    confidence = 70;
                    comment = 'Marked as safe by AI analysis';
                }
                // Priority 5: AI explicitly marked as suspicious
                else if (lowerContent.includes('suspicious')) {
                    classification = 'Suspicious';
                    confidence = 75;
                    comment = 'Suspicious indicators detected';
                }
                // Priority 6: Default based on content analysis
                else {
                    if (phishingScore > safeScore) {
                        classification = 'Suspicious';
                        confidence = 65 + phishingScore * 5;
                    } else if (safeScore > 0) {
                        classification = 'Safe';
                        confidence = 60 + safeScore * 3;
                    } else {
                        classification = 'Suspicious';
                        confidence = 70;
                        comment = 'No clear indicators - defaulting to suspicious for safety';
                    }
                }
                
                // Ensure confidence stays within bounds
                confidence = Math.max(50, Math.min(95, confidence));
                
                return {
                    classification,
                    confidence,
                    comment
                };
            }
        }

        function updateResultsDisplay() {
            const container = document.getElementById('results-container');
            
            if (analysisResults.length === 0) {
                container.innerHTML = '<div class="no-results">No emails analyzed yet. Submit an email above to see results.</div>';
                return;
            }

            const tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>AI Comment</th>
                            <th>Agent Actions</th>
                            <th>IT Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysisResults.map(result => `
                            <tr>
                                <td>${result.sender}</td>
                                <td>${result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                    ${result.learningApplied ? '<div class="learning-indicator">🧠 Learning Applied</div>' : ''}
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                </td>
                                <td>
                                    <div class="ai-comment">${result.comment}</div>
                                    ${result.threatIntel ? `
                                        <div class="security-details">
                                            <small>Threat Score: ${result.threatIntel.threatScore}/100</small>
                                            ${result.threatIntel.suspiciousLinks > 0 ? `<br><small>⚠️ ${result.threatIntel.suspiciousLinks} suspicious links</small>` : ''}
                                            ${result.threatIntel.headerIssues.length > 0 ? `<br><small>⚠️ ${result.threatIntel.headerIssues.length} header issues</small>` : ''}
                                            ${result.threatIntel.attachmentIssues.length > 0 ? `<br><small>⚠️ ${result.threatIntel.attachmentIssues.length} attachment issues</small>` : ''}
                                        </div>
                                    ` : ''}
                                </td>
                                <td>
                                    <div class="agent-actions">
                                        ${result.agentActions && result.agentActions.length > 0 ? 
                                            result.agentActions.map(action => 
                                                `<span class="agent-action ${action.type}">${action.type.replace('_', ' ')}</span>`
                                            ).join('') : 
                                            '<span style="color: #718096; font-style: italic;">No actions</span>'
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="feedback-section">
                                        <button class="review-btn" onclick="openReview(${result.id})" title="Review full email">
                                            👁️ Review
                                        </button>
                                        <div class="feedback-buttons">
                                            <button class="feedback-btn correct ${result.feedback === 'correct' ? 'selected' : ''}" 
                                                    onclick="setFeedback(parseInt('${result.id}'), 'correct')">
                                                ✓ Correct
                                            </button>
                                            <button class="feedback-btn incorrect ${result.feedback === 'incorrect' ? 'selected' : ''}" 
                                                    onclick="setFeedback(parseInt('${result.id}'), 'incorrect')">
                                                ✗ Incorrect
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function setFeedback(resultId, feedback) {
            const result = analysisResults.find(r => r.id === resultId);
            if (result) {
                // Only update metrics if this is the first feedback for this email
                const isFirstFeedback = !result.feedback;
                const previousFeedback = result.feedback;
                
                result.feedback = feedback;
                
                // Learn from feedback
                learnFromFeedback(result, feedback);
                
                // Track false positives
                if (feedback === 'incorrect' && (result.classification === 'Suspicious' || result.classification === 'Phishing')) {
                    agentMemory.performanceMetrics.falsePositives++;
                }
                
                // Note: We'll recalculate accuracy after moving to history
                // This ensures we count only reviewed emails, not all analyzed emails
                
                // Move reviewed email to history
                moveToHistory(result, 'reviewed');
                
                // Recalculate accuracy after moving to history
                recalculateAccuracy();
                
                saveAgentMemory();
                updateResultsDisplay();
                updateHistoryDisplay();
                updateAgentStatus();
            }
        }

        // Learn from feedback to improve future analysis
        function learnFromFeedback(result, feedback) {
            const sender = result.sender;
            const subject = result.subject;
            const body = result.body;
            const emailHash = generateEmailHash(sender, subject, body);
            
            // Store exact email match
            agentMemory.learnedPatterns[emailHash] = {
                classification: result.classification,
                feedback: feedback,
                timestamp: new Date().toISOString()
            };
            
            // Learn sender patterns
            const senderKey = `sender:${sender}`;
            if (!agentMemory.learnedPatterns[senderKey]) {
                agentMemory.learnedPatterns[senderKey] = {
                    classification: result.classification,
                    count: 0,
                    feedback: feedback
                };
            }
            agentMemory.learnedPatterns[senderKey].count++;
            
            // Learn keyword patterns
            const keywords = extractKeywords(subject + ' ' + body);
            keywords.forEach(keyword => {
                const keywordKey = `keyword:${keyword}`;
                if (!agentMemory.learnedPatterns[keywordKey]) {
                    agentMemory.learnedPatterns[keywordKey] = {
                        classification: result.classification,
                        count: 0,
                        feedback: feedback
                    };
                }
                agentMemory.learnedPatterns[keywordKey].count++;
            });
            
            // Store feedback history
            agentMemory.feedbackHistory.push({
                id: result.id,
                classification: result.classification,
                feedback: feedback,
                timestamp: new Date().toISOString(),
                sender: sender,
                subject: subject
            });
            
            console.log('🧠 Learning from feedback:', feedback, 'for', result.classification);
        }

        // Move email to history log
        function moveToHistory(result, reason = 'reviewed') {
            const historyItem = {
                ...result,
                movedToHistory: new Date().toISOString(),
                moveReason: reason
            };
            
            historyResults.unshift(historyItem);
            
            // Remove from active results
            analysisResults = analysisResults.filter(r => r.id !== result.id);
            
            // Save the updated active results
            localStorage.setItem('healthcareActiveResults', JSON.stringify(analysisResults));
            
            console.log('📋 Moved email to history:', reason);
        }

        // Update history display
        function updateHistoryDisplay() {
            const container = document.getElementById('history-container');
            
            if (historyResults.length === 0) {
                container.innerHTML = '<div class="no-results">No emails in history yet. Reviewed emails and safe emails will appear here.</div>';
                return;
            }

            const tableHTML = `
                <table class="results-table history-table">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Subject</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Moved</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${historyResults.map(result => `
                            <tr>
                                <td>${result.sender}</td>
                                <td>${result.subject}</td>
                                <td>
                                    <span class="classification ${result.classification.toLowerCase()}">
                                        ${result.classification}
                                    </span>
                                </td>
                                <td>
                                    <span class="confidence">${result.confidence}%</span>
                                </td>
                                <td>
                                    <span class="history-status ${result.moveReason}">
                                        ${result.moveReason === 'auto_safe' ? 'Auto-Safe' : 
                                          result.moveReason === 'auto_learned' ? 'Auto-Learned' :
                                          result.feedback === 'correct' ? 'Approved' : 'Rejected'}
                                    </span>
                                </td>
                                <td>
                                    <span class="moved-time">${new Date(result.movedToHistory).toLocaleString()}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Update agent status display
        function updateAgentStatus() {
            const metrics = agentMemory.performanceMetrics;
            const historyCount = historyResults.length;
            const activeCount = analysisResults.length;
            
            const statusHTML = `
                <div class="agent-status">
                    <div class="agent-status-header">
                        <h3>🤖 Agent Status</h3>
                        <div class="agent-controls">
                            <button class="refresh-stats-btn" onclick="refreshAgentStats()" title="Refresh stats">
                                🔄
                            </button>
                            <button class="clear-history-btn" onclick="clearAllHistory()" title="Clear all history and reset agent">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Emails Analyzed:</span>
                            <span class="status-value">${metrics.totalAnalyzed}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Accuracy Rate:</span>
                            <span class="status-value">${metrics.accuracyRate.toFixed(1)}%</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Patterns Learned:</span>
                            <span class="status-value">${Object.keys(agentMemory.learnedPatterns).length}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Active Reviews:</span>
                            <span class="status-value">${activeCount}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">History Log:</span>
                            <span class="status-value">${historyCount}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Phishing Caught:</span>
                            <span class="status-value">${metrics.phishingCaught}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">High Threats:</span>
                            <span class="status-value">${metrics.highThreatEmails}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">False Positives:</span>
                            <span class="status-value">${metrics.falsePositives}</span>
                        </div>
                    </div>
                    <div class="last-updated">
                        Last updated: ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            let statusContainer = document.getElementById('agent-status');
            if (!statusContainer) {
                statusContainer = document.createElement('div');
                statusContainer.id = 'agent-status';
                document.querySelector('.results-section').insertBefore(statusContainer, document.getElementById('results-container'));
            }
            statusContainer.innerHTML = statusHTML;
        }

        // Refresh agent stats manually
        function refreshAgentStats() {
            console.log('🔄 Refreshing agent stats...');
            
            // Reload data from localStorage to ensure we have latest
            loadAgentMemory();
            
            // Recalculate accuracy based on actual feedback history
            recalculateAccuracy();
            
            // Update all displays
            updateResultsDisplay();
            updateHistoryDisplay();
            updateAgentStatus();
            
            // Add visual feedback
            const refreshBtn = document.querySelector('.refresh-stats-btn');
            if (refreshBtn) {
                refreshBtn.style.transform = 'rotate(360deg)';
                refreshBtn.style.transition = 'transform 0.5s ease';
                setTimeout(() => {
                    refreshBtn.style.transform = 'rotate(0deg)';
                }, 500);
            }
            
            console.log('✅ Agent stats refreshed');
        }

        // Clear all history and reset agent
        function clearAllHistory() {
            if (!confirm('Are you sure you want to clear all history and reset the agent? This will delete all learned patterns, feedback history, and metrics.')) {
                return;
            }

            console.log('🗑️ Clearing all history and resetting agent...');
            
            // Reset all data structures
            analysisResults = [];
            historyResults = [];
            generationCounter = 0;
            lastGeneratedType = null;
            
            // Reset agent memory to defaults
            agentMemory = {
                learnedPatterns: {},
                feedbackHistory: [],
                threatIntelligence: {},
                performanceMetrics: {
                    totalAnalyzed: 0,
                    correctPredictions: 0,
                    accuracyRate: 0,
                    phishingCaught: 0,
                    falsePositives: 0,
                    securityThreatsBlocked: 0,
                    highThreatEmails: 0
                },
                autoActions: {
                    quarantineThreshold: 85,
                    escalationThreshold: 90,
                    autoQuarantineEnabled: true
                }
            };
            
            // Clear localStorage
            localStorage.removeItem('healthcareAgentMemory');
            localStorage.removeItem('healthcareHistoryResults');
            localStorage.removeItem('healthcareActiveResults');
            
            // Update all displays
            updateResultsDisplay();
            updateHistoryDisplay();
            updateAgentStatus();
            
            console.log('✅ All history cleared and agent reset');
            
            // Show confirmation message
            const statusContainer = document.getElementById('agent-status');
            if (statusContainer) {
                const originalContent = statusContainer.innerHTML;
                statusContainer.innerHTML = `
                    <div class="agent-status" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">
                        <h3>✅ Agent Reset Complete</h3>
                        <p style="margin: 10px 0; opacity: 0.9;">All history cleared and agent reset to initial state.</p>
                    </div>
                `;
                
                setTimeout(() => {
                    statusContainer.innerHTML = originalContent;
                    updateAgentStatus();
                }, 3000);
            }
        }


        // Modal Functions
        function openReview(resultId) {
            const result = analysisResults.find(r => r.id === resultId);
            if (!result) return;

            console.log('Opening review for result:', result);
            console.log('Body content:', result.body);
            console.log('Body type:', typeof result.body);

            // Populate modal
            document.getElementById('modalSender').textContent = result.sender || 'No sender';
            document.getElementById('modalSubject').textContent = result.subject || 'No subject';
            
            const bodyContent = result.body || 'No body content';
            console.log('Body content to display:', bodyContent);
            document.getElementById('modalBody').innerHTML = bodyContent.replace(/\n/g, '<br>');
            
            const classificationSpan = document.getElementById('modalClassification');
            classificationSpan.innerHTML = `<span class="classification ${(result.classification || 'Unknown').toLowerCase()}">${result.classification || 'Unknown'}</span>`;
            
            document.getElementById('modalConfidence').textContent = `${result.confidence || 0}%`;
            document.getElementById('modalThreatScore').textContent = result.threatIntel ? `${result.threatIntel.threatScore}/100` : 'N/A';
            document.getElementById('modalComment').textContent = result.comment || 'No comment available';
            
            // Store result ID for feedback
            document.getElementById('emailModal').dataset.resultId = resultId;
            
            // Show modal
            document.getElementById('emailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('emailModal').style.display = 'none';
        }


        function setFeedbackFromModal(feedback) {
            const resultId = parseInt(document.getElementById('emailModal').dataset.resultId);
            setFeedback(resultId, feedback);
            closeModal();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('emailModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Recalculate accuracy based on actual feedback
        function recalculateAccuracy() {
            // Count total emails that have been reviewed (have feedback)
            const totalReviewed = historyResults.filter(item => item.feedback).length;
            
            // Count correct predictions
            const correctPredictions = historyResults.filter(item => item.feedback === 'correct').length;
            
            // Update metrics
            agentMemory.performanceMetrics.correctPredictions = correctPredictions;
            
            if (totalReviewed > 0) {
                agentMemory.performanceMetrics.accuracyRate = (correctPredictions / totalReviewed) * 100;
            } else {
                agentMemory.performanceMetrics.accuracyRate = 0;
            }
            
            console.log(`📊 Recalculated accuracy: ${correctPredictions}/${totalReviewed} = ${agentMemory.performanceMetrics.accuracyRate.toFixed(1)}%`);
            
            // Save updated metrics
            saveAgentMemory();
        }

        // Example email templates
        const exampleEmails = [
            {
                type: "Safe",
                sender: "hr@generalhospital.org",
                subject: "Staff Training Reminder - HIPAA Compliance",
                body: "Dear Healthcare Team, This is a reminder that our quarterly HIPAA compliance training session is scheduled for next Tuesday at 2 PM in Conference Room A. Please bring your employee ID and complete the pre-training questionnaire by Monday. Contact HR if you have any questions."
            },
            {
                type: "Suspicious",
                sender: "urgent@medical-alert.net",
                subject: "URGENT: Patient Database Maintenance Required",
                body: "We need to verify your patient database credentials immediately to prevent system lockout. Please click the link below to update your information. This is required for HIPAA compliance and system security. Failure to respond within 24 hours will result in account suspension."
            },
            {
                type: "Phishing",
                sender: "security@hospital-security.com",
                subject: "HIPAA Violation Alert - Immediate Action Required",
                body: "Your account has been flagged for HIPAA violations. Click this link immediately to avoid legal action and account suspension. Your access will be terminated in 2 hours if you don't verify your identity. This is your final warning."
            },
            {
                type: "Suspicious",
                sender: "billing@medicare-updates.org",
                subject: "Medicare Reimbursement Changes",
                body: "Important changes to Medicare billing procedures require immediate attention. Click here to download the new billing software and update your patient records. This update is mandatory for all healthcare providers to maintain compliance."
            },
            {
                type: "Safe",
                sender: "noreply@hospital.org",
                subject: "Monthly Staff Meeting Reminder",
                body: "Dear Staff, This is a reminder about our monthly staff meeting scheduled for next Friday at 2 PM in the main conference room. Please confirm your attendance by replying to this email."
            },
            {
                type: "Phishing",
                sender: "admin@healthcare-emergency.net",
                subject: "URGENT: Medical Records Compromise Detected",
                body: "We have detected unauthorized access to your medical records system. Click here immediately to secure your account and prevent data breach. Your patient information is at risk. Respond within 30 minutes or face legal consequences."
            }
        ];

        async function generateExample() {
            if (!openrouterApiKey) {
                alert('OpenRouter API key not configured. Please ensure OPENROUTER_API_KEY is set in environment variables.');
                return;
            }

            const exampleBtn = document.querySelector('.example-btn');
            const originalText = exampleBtn.innerHTML;
            
            // Show loading state
            exampleBtn.disabled = true;
            exampleBtn.innerHTML = '🎲 Generating...';
            
            try {
                // Generate a real-time email using AI
                const generatedEmail = await generateRealTimeEmail(openrouterApiKey);
                
                // Fill the form fields
                document.getElementById('sender').value = generatedEmail.sender;
                document.getElementById('subject').value = generatedEmail.subject;
                document.getElementById('body').value = generatedEmail.body;
                
                // Add a subtle highlight to show it was generated
                const inputs = ['sender', 'subject', 'body'];
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    element.style.backgroundColor = '#f0f9ff';
                    element.style.borderColor = '#38a169';
                    
                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                        element.style.borderColor = '';
                    }, 2000);
                });
                
                console.log(`✅ Generated unique email #${generationCounter}:`, generatedEmail.type, 'from', randomHospital, randomDept);
                
            } catch (error) {
                console.error('Error generating email:', error);
                // Fallback to template if AI generation fails
                const randomExample = exampleEmails[Math.floor(Math.random() * exampleEmails.length)];
                document.getElementById('sender').value = randomExample.sender;
                document.getElementById('subject').value = randomExample.subject;
                document.getElementById('body').value = randomExample.body;
            } finally {
                // Restore button state
                exampleBtn.disabled = false;
                exampleBtn.innerHTML = originalText;
            }
        }

        async function generateRealTimeEmail(apiKey) {
            const emailTypes = ['Safe', 'Suspicious', 'Phishing'];
            
            // Avoid generating the same type consecutively for more variety
            let availableTypes = emailTypes.filter(type => type !== lastGeneratedType);
            if (availableTypes.length === 0) availableTypes = emailTypes; // Fallback if all types were used
            
            const randomType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            lastGeneratedType = randomType;
            generationCounter++;
            
            // Add randomization elements for more uniqueness
            const hospitalNames = ['General Hospital', 'Memorial Medical Center', 'City Health Clinic', 'Regional Hospital', 'Community Medical', 'University Medical Center', 'St. Mary\'s Hospital', 'Children\'s Hospital'];
            const departments = ['IT', 'HR', 'Administration', 'Security', 'Billing', 'Medical Records', 'Compliance', 'Emergency Services', 'Pharmacy', 'Laboratory'];
            const roles = ['Administrator', 'Manager', 'Director', 'Coordinator', 'Specialist', 'Supervisor', 'Officer', 'Representative'];
            const timeframes = ['immediately', 'within 24 hours', 'by end of week', 'urgently', 'as soon as possible', 'today', 'this afternoon', 'by tomorrow'];
            
            const randomHospital = hospitalNames[Math.floor(Math.random() * hospitalNames.length)];
            const randomDept = departments[Math.floor(Math.random() * departments.length)];
            const randomRole = roles[Math.floor(Math.random() * roles.length)];
            const randomTime = timeframes[Math.floor(Math.random() * timeframes.length)];
            
            // Add timestamp and random elements for uniqueness
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 8);
            
            const prompt = `Generate a unique, realistic healthcare email that would be classified as "${randomType}". 

Context: ${randomHospital} - ${randomDept} Department
Sender Role: ${randomRole}
Urgency: ${randomTime}
Generation #${generationCounter}
Unique ID: ${randomId}
Timestamp: ${timestamp}

Requirements:
- Make it completely unique and different from typical examples
- Include specific healthcare details, terminology, and context for ${randomHospital}
- Use realistic sender domains and professional language
- For Safe: Normal hospital communications (schedules, reminders, announcements, policy updates, training notifications)
- For Suspicious: Unusual requests that might be legitimate but raise questions (access requests, data sharing, policy changes)
- For Phishing: Clear malicious intent targeting healthcare workers/patients (credential theft, fake alerts, urgent actions)

Be creative and avoid common patterns. Make each email feel like a real, unique communication.

Respond ONLY with this JSON format:
{
  "type": "${randomType}",
  "sender": "realistic.email@domain.com",
  "subject": "Unique realistic subject line",
  "body": "Detailed unique email body content"
}

Make the email detailed, believable, and completely unique.`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'Healthcare Email Defense Demo'
                },
                body: JSON.stringify({
                    model: 'alibaba/tongyi-deepresearch-30b-a3b:free',
                    max_tokens: 300,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ]
                })
            });

            console.log('API Response status:', response.status);
            console.log('API Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error response:', errorText);
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            
            try {
                // Try to parse JSON response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    return {
                        type: result.type,
                        sender: result.sender,
                        subject: result.subject,
                        body: result.body
                    };
                } else {
                    throw new Error('No JSON found in response');
                }
            } catch (parseError) {
                console.warn('Failed to parse AI response, using fallback');
                throw new Error('Failed to parse generated email');
            }
        }

        // Initialize display
        updateResultsDisplay();
        updateHistoryDisplay();
    </script>
</body>
</html>
