<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Basket - EPIC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f2f3f5;
            min-height: 100vh;
            font-size: 13px;
        }

        .top-bar {
            background: #0072CE;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 13px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 13px;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 40px);
        }

        /* Folder Panel */
        .folder-panel {
            width: 200px;
            background: white;
            border-right: 1px solid #E4E8EF;
            overflow-y: auto;
            padding: 15px 0;
        }

        .folder-panel h3 {
            color: #2d3748;
            font-size: 13px;
            font-weight: 600;
            padding: 0 15px 10px 15px;
            border-bottom: 1px solid #E4E8EF;
            margin-bottom: 10px;
        }

        .folder-list {
            list-style: none;
        }

        .folder-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #4a5568;
            font-size: 13px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-item:hover {
            background: #f7f9fc;
            color: #0072CE;
        }

        .folder-item.active {
            background: #E4E8EF;
            color: #0072CE;
            border-left-color: #0072CE;
            font-weight: 600;
        }

        .folder-count {
            background: #0072CE;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Quarantine Panel */
        .quarantine-panel {
            width: 400px;
            background: #f7f9fc;
            border-right: 1px solid #E4E8EF;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: white;
            padding: 12px 15px;
            border-bottom: 1px solid #E4E8EF;
        }

        .panel-header h2 {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
        }

        .email-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .email-card {
            background: white;
            border: 1px solid #E4E8EF;
            border-left: 3px solid transparent;
            padding: 12px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .email-card:hover {
            border-left-color: #0072CE;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .email-card.selected {
            border-left-color: #0072CE;
            background: #E4E8EF;
        }

        .email-card.reported {
            border-left-color: #ff9800;
        }

        .email-card.released {
            border-left-color: #28a745;
        }

        .email-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .email-sender {
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
        }

        .email-timestamp {
            color: #718096;
            font-size: 11px;
        }

        .email-subject {
            font-size: 13px;
            color: #2d3748;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .email-patient-info {
            font-size: 11px;
            color: #4a5568;
            margin-bottom: 6px;
        }

        .email-labels {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }

        .label {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .label.urgent {
            background: #fed7d7;
            color: #c53030;
        }

        .label.reported {
            background: #ff9800;
            color: white;
            font-size: 10px;
        }

        .label.released {
            background: #28a745;
            color: white;
            font-size: 10px;
        }

        .status-info {
            font-size: 11px;
            color: #4a5568;
            margin-top: 6px;
        }

        .status-info.reported {
            color: #ff9800;
        }

        .status-info.released {
            color: #28a745;
        }

        /* Detail Panel */
        .detail-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .detail-panel.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            font-size: 13px;
        }

        .detail-header {
            background: #f7f9fc;
            padding: 12px 20px;
            border-bottom: 1px solid #E4E8EF;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-header h2 {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
        }

        .detail-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #E4E8EF;
            background: white;
        }

        .detail-tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 13px;
            color: #4a5568;
            transition: all 0.2s;
        }

        .detail-tab:hover {
            color: #0072CE;
        }

        .detail-tab.active {
            color: #0072CE;
            border-bottom-color: #0072CE;
            font-weight: 600;
        }

        .detail-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .email-content-section {
            background: #f7f9fc;
            border: 1px solid #E4E8EF;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .email-content-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #E4E8EF;
        }

        .email-field {
            margin-bottom: 10px;
        }

        .email-field-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .email-field-value {
            color: #2d3748;
            font-size: 13px;
        }

        .email-body {
            margin-top: 15px;
            color: #2d3748;
            line-height: 1.6;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .info-section {
            background: #f7f9fc;
            border: 1px solid #E4E8EF;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-row {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 12px;
            min-width: 140px;
        }

        .info-value {
            color: #2d3748;
            font-size: 13px;
            text-align: right;
            flex: 1;
        }

        .risk-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }

        .risk-badge.medium {
            background: #ffc107;
            color: #856404;
        }

        .detection-rationale {
            background: #fff5f5;
            border-left: 3px solid #e53e3e;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #4a5568;
            line-height: 1.6;
            font-size: 13px;
        }

        .comment-section {
            background: #e7f3ff;
            border-left: 3px solid #0072CE;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #4a5568;
            line-height: 1.6;
            font-size: 13px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-release {
            background: #28a745;
            color: white;
        }

        .btn-release:hover {
            background: #218838;
        }

        .btn-quarantine {
            background: #6c757d;
            color: white;
        }

        .btn-quarantine:hover {
            background: #5a6268;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 4px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
        }

        .modal-header {
            margin-bottom: 15px;
        }

        .modal-header h3 {
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-body {
            color: #4a5568;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 13px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal.confirm {
            background: #28a745;
            color: white;
        }

        .btn-modal.confirm:hover {
            background: #218838;
        }

        .btn-modal.cancel {
            background: #6c757d;
            color: white;
        }

        .btn-modal.cancel:hover {
            background: #5a6268;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 400px;
            font-size: 13px;
        }

        .toast.show {
            display: block;
        }

        .audit-notification {
            position: fixed;
            top: 60px;
            right: 30px;
            background: white;
            border: 2px solid #28a745;
            border-radius: 4px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 280px;
        }

        .audit-notification.show {
            display: block;
        }

        .audit-notification h4 {
            color: #28a745;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .audit-notification p {
            color: #4a5568;
            font-size: 11px;
            margin: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="user-info">
            <div class="user-name" id="userName">Dr. Chen (Department Lead)</div>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('quarantine')">Quarantine Queue</button>
            <button class="nav-tab" onclick="switchTab('statistics')">Statistics</button>
            <button class="nav-tab" onclick="switchTab('profile')">Profile</button>
            <button class="nav-tab" onclick="resetDemo()" style="background: rgba(255, 255, 255, 0.15);">üîÑ Reset</button>
            <button class="nav-tab" onclick="signOut()" style="background: rgba(255, 255, 255, 0.15);">üö™ Sign Out</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Folder Panel -->
        <div class="folder-panel">
            <h3>In Basket</h3>
            <ul class="folder-list">
                <li class="folder-item active" onclick="switchFolder('Quarantine')">
                    <span>Quarantine</span>
                    <span class="folder-count" id="countQuarantine">0</span>
                </li>
                <li class="folder-item" onclick="switchFolder('All')">
                    <span>All Messages</span>
                    <span class="folder-count" id="countAll">0</span>
                </li>
                <li class="folder-item" onclick="switchFolder('Results')">
                    <span>Results</span>
                    <span class="folder-count" id="countResults">0</span>
                </li>
                <li class="folder-item" onclick="switchFolder('Team Messages')">
                    <span>Team Messages</span>
                    <span class="folder-count" id="countTeam">0</span>
                </li>
            </ul>
        </div>

        <!-- Quarantine Panel -->
        <div class="quarantine-panel">
            <div class="panel-header">
                <h2 id="folderTitle">Quarantine Queue</h2>
            </div>
            <div class="email-list-container" id="emailList">
                <!-- Emails will be rendered here -->
            </div>
        </div>

        <!-- Detail Panel -->
        <div class="detail-panel empty" id="detailPanel">
            <div>Select an email to review</div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Release</h3>
            </div>
            <div class="modal-body">
                Confirm release? This action will be logged.
            </div>
            <div class="modal-actions">
                <button class="btn-modal cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-modal confirm" onclick="confirmRelease()">Confirm</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="audit-notification" id="auditNotification">
        <h4>Audit Record Created</h4>
        <p id="auditId"></p>
    </div>

    <script>
        // Check authentication
        if (sessionStorage.getItem('authenticated') !== 'true' || sessionStorage.getItem('role') !== 'lead') {
            window.location.href = 'nurse-login.html';
        }

        // Set user name from session
        const userName = sessionStorage.getItem('username') || 'Dr. Chen';
        document.getElementById('userName').textContent = userName + ' (Department Lead)';

        let selectedEmailId = null;
        let pendingReleaseEmailId = null;
        let currentFolder = 'Quarantine';

        // Base email data
        const baseEmails = [
            {
                id: 'email1',
                sender: 'Lab Results System',
                to: 'Nurse Li',
                subject: 'Lab Results: Patient #2387',
                timestamp: '2 hours ago',
                labels: ['Urgent', 'Suspicious'],
                confidence: 0.67,
                rationale: 'New domain detected; unverified link contained in message body.',
                status: 'suspicious',
                folder: 'Results',
                patient: { name: 'Jane Doe', mrn: '2387', dob: '05/15/1982' },
                encounter: 'ER Visit 10/29/2025',
                attachments: ['LabReport_2387.pdf'],
                domainReputation: 'Medium Risk',
                content: `Dear Healthcare Provider,

We have received lab results for Patient #2387 (Jane Doe, DOB: 05/15/1982).

URGENT: Abnormal test results detected.

Please review the attached report by clicking here: [View Results](https://medlab-info.com/results/verify?id=2387)

Critical values:
- Hemoglobin: 8.2 g/dL (Low - Normal: 12.0-15.5)
- Platelet count: 95,000/ŒºL (Low - Normal: 150,000-450,000)

Immediate action may be required. Please contact the lab if you have any questions.

Best regards,
Medical Lab Services
lab-report@medlab-info.com`
            }
        ];

        // Load reported emails from localStorage
        function loadReportedEmails() {
            const reportedEmails = [];
            
            baseEmails.forEach(email => {
                const reportData = localStorage.getItem(`emailReport_${email.id}`);
                if (reportData) {
                    const report = JSON.parse(reportData);
                    if (report.status === 'reported' || report.status === 'released') {
                        reportedEmails.push({
                            ...email,
                            status: report.status,
                            reportedBy: report.reportedBy || 'Nurse Li',
                            reportedTime: report.reportedTime || '30 minutes ago',
                            releasedBy: report.releasedBy,
                            releasedTime: report.releasedTime,
                            auditId: report.auditId,
                            domainReputation: email.domainReputation || 'Medium Risk'
                        });
                    }
                }
            });
            
            // Also check if there are any emails reported from nurse-view
            const allReportKeys = Object.keys(localStorage).filter(key => key.startsWith('emailReport_'));
            allReportKeys.forEach(key => {
                const emailId = key.replace('emailReport_', '');
                const reportData = JSON.parse(localStorage.getItem(key));
                if (reportData && reportData.status === 'reported') {
                    const exists = reportedEmails.find(e => e.id === emailId);
                    if (!exists) {
                        const baseEmail = baseEmails.find(e => e.id === emailId);
                        if (baseEmail) {
                            reportedEmails.push({
                                ...baseEmail,
                                status: 'reported',
                                reportedBy: reportData.reportedBy || 'Nurse Li',
                                reportedTime: reportData.reportedTime || '30 minutes ago'
                            });
                        }
                    }
                }
            });

            return reportedEmails;
        }

        function switchFolder(folder) {
            currentFolder = folder;
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.folder-item').classList.add('active');
            document.getElementById('folderTitle').textContent = folder === 'Quarantine' ? 'Quarantine Queue' : folder;
            renderEmailList();
            renderEmptyDetail();
            selectedEmailId = null;
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (tab === 'quarantine') {
                renderEmailList();
            }
        }

        function updateFolderCounts() {
            const emails = loadReportedEmails();
            const counts = {
                'Quarantine': emails.filter(e => e.status === 'reported').length,
                'All': emails.length,
                'Results': emails.filter(e => e.folder === 'Results').length,
                'Team Messages': emails.filter(e => e.folder === 'Team Messages').length
            };

            document.getElementById('countQuarantine').textContent = counts['Quarantine'];
            document.getElementById('countAll').textContent = counts['All'];
            document.getElementById('countResults').textContent = counts['Results'];
            document.getElementById('countTeam').textContent = counts['Team Messages'];
        }

        function renderEmailList() {
            const container = document.getElementById('emailList');
            let emails = loadReportedEmails();
            
            // Filter by folder
            if (currentFolder === 'Quarantine') {
                emails = emails.filter(e => e.status === 'reported');
            } else if (currentFolder !== 'All') {
                emails = emails.filter(e => e.folder === currentFolder);
            }
            
            if (emails.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üì≠</div>
                        <div>No emails in ${currentFolder.toLowerCase()}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = emails.map(email => {
                const isSelected = email.id === selectedEmailId;
                const isReported = email.status === 'reported';
                const isReleased = email.status === 'released';
                
                return `
                    <div class="email-card ${isReported ? 'reported' : ''} ${isReleased ? 'released' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectEmail('${email.id}')">
                        <div class="email-header-row">
                            <div class="email-sender">${email.sender}</div>
                            <div class="email-timestamp">${email.timestamp}</div>
                        </div>
                        <div class="email-subject">${email.subject}</div>
                        ${email.patient ? `
                            <div class="email-patient-info">
                                Patient: ${email.patient.name} (MRN: ${email.patient.mrn})
                            </div>
                        ` : ''}
                        <div class="email-labels">
                            ${email.labels.includes('Urgent') ? `<span class="label urgent">Urgent</span>` : ''}
                            ${isReported ? `<span class="label reported">Reported</span>` : ''}
                            ${isReleased ? `<span class="label released">Released ‚úÖ</span>` : ''}
                        </div>
                        <div class="status-info ${email.status}">
                            ${isReported ? `üìã Status: Reported by ${email.reportedBy}` : ''}
                            ${isReleased ? `‚úÖ Status: Released by ${email.releasedBy || userName}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectEmail(emailId) {
            selectedEmailId = emailId;
            const emails = loadReportedEmails();
            const email = emails.find(e => e.id === emailId);
            
            renderEmailList();
            
            if (email) {
                renderDetailPanel(email);
            } else {
                renderEmptyDetail();
            }
        }

        function renderDetailPanel(email) {
            const panel = document.getElementById('detailPanel');
            panel.className = 'detail-panel';
            
            const isReported = email.status === 'reported';
            const isUrgent = email.labels.includes('Urgent');
            
            panel.innerHTML = `
                <div class="detail-header">
                    <h2>Message Detail View</h2>
                </div>
                <div class="detail-tabs">
                    <button class="detail-tab active" onclick="switchDetailTab('message', '${email.id}')">Message</button>
                    <button class="detail-tab" onclick="switchDetailTab('patient', '${email.id}')">Patient Info</button>
                    <button class="detail-tab" onclick="switchDetailTab('audit', '${email.id}')">Audit Trail</button>
                </div>
                <div class="detail-content" id="detailContent">
                    ${renderMessageTab(email)}
                </div>
            `;
        }

        function renderMessageTab(email) {
            const isReported = email.status === 'reported';
            const isUrgent = email.labels.includes('Urgent');
            
            return `
                <div class="email-content-section">
                    <div class="email-content-header">
                        <div class="email-field">
                            <div class="email-field-label">From:</div>
                            <div class="email-field-value">${email.sender}</div>
                        </div>
                        <div class="email-field">
                            <div class="email-field-label">To:</div>
                            <div class="email-field-value">${email.to}</div>
                        </div>
                        <div class="email-field">
                            <div class="email-field-label">Subject:</div>
                            <div class="email-field-value">${email.subject}</div>
                        </div>
                        <div class="email-field">
                            <div class="email-field-label">Received:</div>
                            <div class="email-field-value">${email.timestamp}</div>
                        </div>
                        ${email.patient ? `
                            <div class="email-field">
                                <div class="email-field-label">Patient:</div>
                                <div class="email-field-value">${email.patient.name} (MRN: ${email.patient.mrn})</div>
                            </div>
                        ` : ''}
                        ${email.encounter ? `
                            <div class="email-field">
                                <div class="email-field-label">Encounter:</div>
                                <div class="email-field-value">${email.encounter}</div>
                            </div>
                        ` : ''}
                        ${email.attachments && email.attachments.length > 0 ? `
                            <div class="email-field">
                                <div class="email-field-label">Attachments:</div>
                                <div class="email-field-value">${email.attachments.map(att => `<span style="color: #0072CE; cursor: pointer;">${att}</span>`).join(', ')}</div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="email-body">
${email.content || 'No content available.'}
                    </div>
                </div>
                <div class="info-section">
                    <div class="info-row">
                        <div class="info-label">Sender Domain Reputation:</div>
                        <div class="info-value">
                            <span class="risk-badge medium">${email.domainReputation || 'Medium Risk'}</span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Confidence Score:</div>
                        <div class="info-value">${email.confidence}</div>
                    </div>
                </div>
                <div class="detection-rationale">
                    <strong>Why flagged?</strong><br>
                    ${email.rationale}
                </div>
                ${email.reportedBy ? `
                    <div class="comment-section">
                        <strong>Comment:</strong><br>
                        Reported by ${email.reportedBy} ‚Äì requires review.
                    </div>
                ` : ''}
                ${isReported && isUrgent ? `
                    <div class="action-buttons">
                        <button class="btn btn-release" onclick="showReleaseModal('${email.id}')">
                            Release Urgent
                        </button>
                        <button class="btn btn-quarantine" onclick="keepQuarantined('${email.id}')">
                            Keep Quarantined
                        </button>
                    </div>
                ` : ''}
            `;
        }

        function renderPatientTab(email) {
            if (!email.patient) {
                return '<div style="padding: 20px; color: #718096;">No patient information available.</div>';
            }
            return `
                <div class="info-section">
                    <div class="info-row">
                        <div class="info-label">Patient Name:</div>
                        <div class="info-value">${email.patient.name}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">MRN:</div>
                        <div class="info-value">${email.patient.mrn}</div>
                    </div>
                    ${email.patient.dob ? `
                        <div class="info-row">
                            <div class="info-label">Date of Birth:</div>
                            <div class="info-value">${email.patient.dob}</div>
                        </div>
                    ` : ''}
                    ${email.encounter ? `
                        <div class="info-row">
                            <div class="info-label">Encounter:</div>
                            <div class="info-value">${email.encounter}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAuditTab(email) {
            const reportData = localStorage.getItem(`emailReport_${email.id}`);
            let auditLog = [];
            
            if (reportData) {
                const report = JSON.parse(reportData);
                if (report.reportedBy) {
                    auditLog.push({
                        time: report.reportedTime || new Date().toISOString(),
                        action: 'Reported',
                        actor: report.reportedBy,
                        role: 'nurse'
                    });
                }
                if (report.releasedBy) {
                    auditLog.push({
                        time: report.releasedTime || new Date().toISOString(),
                        action: 'Released',
                        actor: report.releasedBy,
                        role: 'lead',
                        auditId: report.auditId
                    });
                }
            }
            
            if (auditLog.length === 0) {
                return '<div style="padding: 20px; color: #718096;">No audit trail available.</div>';
            }
            
            return `
                <div class="info-section">
                    ${auditLog.map(log => `
                        <div class="info-row" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E4E8EF;">
                            <div>
                                <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">${log.action}</div>
                                <div style="font-size: 11px; color: #718096;">${log.actor} (${log.role})</div>
                                <div style="font-size: 11px; color: #718096;">${new Date(log.time).toLocaleString()}</div>
                                ${log.auditId ? `<div style="font-size: 11px; color: #0072CE; margin-top: 4px;">Audit ID: ${log.auditId}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function switchDetailTab(tab, emailId) {
            const emails = loadReportedEmails();
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const content = document.getElementById('detailContent');
            if (tab === 'message') {
                content.innerHTML = renderMessageTab(email);
            } else if (tab === 'patient') {
                content.innerHTML = renderPatientTab(email);
            } else if (tab === 'audit') {
                content.innerHTML = renderAuditTab(email);
            }
        }

        function renderEmptyDetail() {
            const panel = document.getElementById('detailPanel');
            panel.className = 'detail-panel empty';
            panel.innerHTML = '<div>Select an email to review</div>';
        }

        function showReleaseModal(emailId) {
            pendingReleaseEmailId = emailId;
            const modal = document.getElementById('confirmModal');
            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
            pendingReleaseEmailId = null;
        }

        function confirmRelease() {
            if (!pendingReleaseEmailId) return;
            
            const emailId = pendingReleaseEmailId;
            const reportData = localStorage.getItem(`emailReport_${emailId}`);
            
            if (reportData) {
                const report = JSON.parse(reportData);
                report.status = 'released';
                report.releasedBy = userName;
                report.releasedTime = new Date().toISOString();
                
                // Generate audit ID
                const auditId = '#A' + Math.floor(1000 + Math.random() * 9000);
                report.auditId = auditId;
                
                localStorage.setItem(`emailReport_${emailId}`, JSON.stringify(report));
                
                // Show toast
                showToast('Released with audit record.');
                
                // Show audit notification
                showAuditNotification(auditId);
                
                // Close modal
                closeModal();
                
                // Refresh UI
                renderEmailList();
                selectEmail(emailId);
                updateFolderCounts();
            }
        }

        function keepQuarantined(emailId) {
            showToast('Email remains in quarantine.');
            renderEmailList();
            renderEmptyDetail();
            selectedEmailId = null;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showAuditNotification(auditId) {
            const notification = document.getElementById('auditNotification');
            const auditIdElement = document.getElementById('auditId');
            auditIdElement.textContent = `Audit ID: ${auditId} recorded.`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function resetDemo() {
            if (confirm('Reset all report records? This will clear all reported and released email statuses.')) {
                // Ê∏ÖÈô§ÊâÄÊúâÊä•ÂëäËÆ∞ÂΩï
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('emailReport_') || key === 'emailState') {
                        localStorage.removeItem(key);
                    }
                });
                
                // ÈáçÊñ∞Ê∏≤Êüì
                selectedEmailId = null;
                renderEmailList();
                renderEmptyDetail();
                updateFolderCounts();
                
                showToast('All report records cleared. Demo reset.');
            }
        }

        function signOut() {
            if (confirm('Sign out?')) {
                sessionStorage.clear();
                window.location.href = 'nurse-login.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize
        updateFolderCounts();
        renderEmailList();
    </script>
</body>
</html>
